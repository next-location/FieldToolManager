# 発注書管理機能 テストシナリオ

## 0. テスト環境の準備

### 0-1. ログインユーザー情報
テスト用の組織アカウントでログインしてください：

**DX効率化パッケージ契約組織（発注機能が使える組織）:**
- メールアドレス: `admin@test-org-dx.com`
- パスワード: `password123`
- 役割: admin（管理者）

このアカウントで以下のテストを実施します。

---

## シナリオ1: 仕入先の登録（5分）

### 目的
実際の協力会社を仕入先として登録する

### 手順

1. **サイドバーから「仕入先管理」をクリック**
   - パス: `/suppliers`

2. **新規仕入先を3社登録**

   **仕入先A: 資材業者**
   ```
   仕入先名: 山田建材株式会社
   仕入先コード: 自動採番（SUP-001）
   郵便番号: 123-4567
   住所: 東京都千代田区丸の内1-1-1
   電話番号: 03-1234-5678
   担当者名: 山田太郎
   メールアドレス: yamada@kenzai.co.jp
   銀行名: みずほ銀行
   支店名: 丸の内支店
   口座種別: 普通
   口座番号: 1234567
   口座名義: ヤマダケンザイ(カ
   ```

   **仕入先B: 設備業者**
   ```
   仕入先名: 田中設備工業
   仕入先コード: 自動採番（SUP-002）
   郵便番号: 456-7890
   住所: 神奈川県横浜市西区みなとみらい2-2-2
   電話番号: 045-2345-6789
   担当者名: 田中花子
   メールアドレス: tanaka@setsubi.co.jp
   銀行名: 三菱UFJ銀行
   支店名: 横浜支店
   口座種別: 当座
   口座番号: 7654321
   口座名義: タナカセツビコウギョウ
   ```

   **仕入先C: 電気工事業者**
   ```
   仕入先名: 佐藤電気工事
   仕入先コード: 自動採番（SUP-003）
   郵便番号: 789-0123
   住所: 埼玉県さいたま市大宮区桜木町3-3-3
   電話番号: 048-3456-7890
   担当者名: 佐藤一郎
   メールアドレス: sato@denki.co.jp
   銀行名: りそな銀行
   支店名: 大宮支店
   口座種別: 普通
   口座番号: 9876543
   口座名義: サトウデンキコウジ
   ```

3. **登録確認**
   - 仕入先一覧に3社表示されることを確認
   - 仕入先コードが自動採番されていることを確認（SUP-001, SUP-002, SUP-003）

---

## シナリオ2: 小額発注（10万円未満）の作成・承認フロー（10分）

### 目的
現場で急遽必要になった資材の発注（リーダーが承認可能）

### 背景ストーリー
「○○マンション改修工事」の現場で、作業中に配管部材が不足していることが判明。
現場監督がスマホから発注書を作成し、リーダーが承認する。

### 手順

1. **発注書一覧ページへ移動**
   - サイドバーから「発注書管理」をクリック
   - パス: `/purchase-orders`

2. **新規発注書作成**
   - 「新規作成」ボタンをクリック
   - パス: `/purchase-orders/new`

3. **基本情報入力**
   ```
   発注日: 今日の日付
   仕入先: 山田建材株式会社（SUP-001）
   工事: プルダウンから既存の工事を選択（例: ○○マンション改修工事）
   納期: 3日後の日付
   支払条件: 翌月末払い
   ```

4. **明細入力**
   ```
   【明細1】
   品名: 塩ビ管 VP75
   規格: 4m
   数量: 10
   単位: 本
   単価: 3,500
   金額: 35,000円（自動計算）

   【明細2】
   品名: 継手セット
   規格: VP75用
   数量: 2
   単位: セット
   単価: 8,000
   金額: 16,000円（自動計算）

   【明細3】
   品名: 接着剤
   規格: 500ml
   数量: 3
   単位: 本
   単価: 2,500
   金額: 7,500円（自動計算）
   ```

5. **金額確認**
   ```
   小計: 58,500円
   消費税(10%): 5,850円
   合計: 64,350円
   ```

6. **備考入力**
   ```
   備考: 配管交換工事で使用。3日後の朝一で現場納品希望。
   ```

7. **下書き保存**
   - 「下書き保存」ボタンをクリック
   - 発注番号が自動採番されることを確認（例: PO-20231216-001）
   - 一覧ページに戻り、ステータスが「下書き」であることを確認

8. **承認申請**
   - 作成した発注書をクリックして詳細画面へ
   - 「承認申請」ボタンをクリック
   - ステータスが「承認申請中」に変わることを確認

9. **承認処理（リーダー権限でテスト）**
   - 同じアカウントで承認操作
   - 「承認」ボタンをクリック
   - コメント入力: 「内容確認しました。承認します。」
   - ステータスが「承認済み」に変わることを確認
   - 承認者名と承認日時が表示されることを確認

10. **PDF出力テスト**
    - 「PDF出力」ボタンをクリック
    - PDFがダウンロードされることを確認
    - PDF内容を確認:
      - 発注番号
      - 仕入先情報
      - 明細情報
      - 金額（小計、消費税、合計）
      - 振込先情報

---

## シナリオ3: 高額発注（100万円以上）の作成・承認フロー（10分）

### 目的
大型工事の設備工事発注（管理者承認が必要）

### 背景ストーリー
「△△ビル新築工事」で空調設備工事を発注。金額が100万円を超えるため、
管理者の承認が必須。

### 手順

1. **新規発注書作成**
   - 「新規作成」ボタンをクリック

2. **基本情報入力**
   ```
   発注日: 今日の日付
   仕入先: 田中設備工業（SUP-002）
   工事: △△ビル新築工事（なければプルダウンで別の工事を選択）
   納期: 30日後の日付
   支払条件: 翌月末払い
   ```

3. **明細入力（高額設備）**
   ```
   【明細1】
   品名: 業務用エアコン
   規格: 天井埋込カセット形 5馬力
   数量: 8
   単位: 台
   単価: 150,000
   金額: 1,200,000円

   【明細2】
   品名: 室外機
   規格: 5馬力用
   数量: 8
   単位: 台
   単価: 80,000
   金額: 640,000円

   【明細3】
   品名: 配管・据付工事費
   規格: 一式
   数量: 1
   単位: 式
   単価: 500,000
   金額: 500,000円
   ```

4. **金額確認**
   ```
   小計: 2,340,000円
   消費税(10%): 234,000円
   合計: 2,574,000円 ← 100万円超え
   ```

5. **備考入力**
   ```
   備考: 空調設備一式。配管・据付含む。工期に合わせて搬入調整必要。
   ```

6. **承認申請**
   - 「下書き保存」→「承認申請」の流れで申請

7. **リーダーが承認しようとした場合のテスト**
   - もしリーダーアカウントがあれば、リーダーでログインして承認を試みる
   - 「100万円以上の発注は管理者の承認が必要です」のエラーメッセージが表示されることを確認

8. **管理者による承認**
   - 管理者アカウントで承認
   - コメント入力: 「予算内であり、必要性を確認しました。承認します。」
   - 承認が成功することを確認

---

## シナリオ4: 発注書の差戻しと再申請（10分）

### 目的
内容に不備がある発注書を差し戻し、修正後に再申請する

### 背景ストーリー
現場から上がってきた発注書の数量が間違っていたため、
管理者が差し戻して修正を依頼する。

### 手順

1. **新規発注書作成（意図的に不備のある内容）**
   ```
   発注日: 今日の日付
   仕入先: 佐藤電気工事（SUP-003）
   工事: 任意の工事を選択
   納期: 7日後
   支払条件: 翌月末払い

   【明細1】
   品名: LED照明器具
   規格: 埋込型 100W
   数量: 50 ← わざと多めに入力
   単位: 台
   単価: 8,000
   金額: 400,000円
   ```

2. **承認申請**
   - 下書き保存→承認申請

3. **管理者による差戻し**
   - 発注書詳細画面で「差戻し」ボタンをクリック
   - 差戻し理由入力: 「照明器具の数量が多すぎます。図面を確認して正確な数量で再申請してください。」
   - ステータスが「差戻し」に変わることを確認

4. **作成者への通知確認**
   - 通知アイコンに新着通知が表示されることを確認
   - 通知内容: 「発注書 PO-XXXXXXX-XXX が差し戻されました」

5. **発注書の修正**
   - 差し戻された発注書の詳細画面へ
   - 「編集」ボタンをクリック（編集ページへ遷移）
   - 数量を修正: 50 → 30
   - 金額が自動再計算されることを確認: 240,000円
   - 「更新」ボタンをクリック

6. **再申請**
   - 詳細画面に戻る
   - 「承認申請」ボタンをクリック
   - ステータスが「承認申請中」に戻ることを確認

7. **再承認**
   - 管理者が内容を確認して承認
   - コメント: 「数量を修正しました。承認します。」

8. **履歴確認**
   - 詳細画面下部の「変更履歴」セクションを確認
   - 以下の履歴が記録されていることを確認:
     - 作成
     - 承認申請
     - 差戻し（差戻し理由のコメント付き）
     - 更新
     - 承認申請（再申請）
     - 承認

---

## シナリオ5: 工事別の発注状況確認（5分）

### 目的
特定の工事にかかっている発注コストを確認する

### 手順

1. **工事詳細ページへ移動**
   - サイドバーから「工事管理」をクリック
   - 任意の工事をクリックして詳細画面へ
   - パス: `/projects/[工事ID]`

2. **発注情報セクションの確認**
   - 「発注情報」セクションが表示されることを確認
   - 以下の情報が表示されることを確認:
     - 発注書件数
     - 発注総額
     - 承認済件数
     - 承認済金額
     - 予算消化率（プログレスバー）
     - 予算残額

3. **予算消化率の色分け確認**
   - 80%未満: 緑色
   - 80%以上100%未満: 黄色
   - 100%以上: 赤色

4. **工事別発注書一覧**
   - 「発注書一覧を見る」リンクをクリック
   - 工事でフィルタリングされた発注書一覧が表示されることを確認

---

## シナリオ6: CSV一括エクスポート（5分）

### 目的
月次報告用に発注データをExcelで加工できるようにCSV出力する

### 手順

1. **発注書一覧ページへ移動**
   - パス: `/purchase-orders`

2. **フィルター設定**
   ```
   ステータス: 承認済み
   仕入先: （任意または全て）
   工事: （任意または全て）
   ```

3. **CSV出力**
   - 「CSV出力」ボタンをクリック
   - CSVファイルがダウンロードされることを確認
   - ファイル名: `purchase_orders_YYYY-MM-DD.csv`

4. **CSVファイルをExcelで開く**
   - ダウンロードしたCSVをExcelで開く
   - 日本語が文字化けせず正しく表示されることを確認（BOM付きUTF-8）
   - 以下の列が含まれることを確認:
     - 発注番号
     - ステータス
     - 発注日
     - 仕入先コード
     - 仕入先名
     - 工事コード
     - 工事名
     - 小計
     - 消費税
     - 合計金額
     - 納期
     - 支払条件
     - 発注者
     - 承認者
     - 明細数
     - 備考
     - 作成日時

---

## シナリオ7: 発注分析レポート（5分）

### 目的
経営判断のために発注の傾向を分析する

### 手順

1. **分析レポートページへ移動**
   - 発注書一覧ページのURL末尾に `/analytics` を追加
   - パス: `/purchase-orders/analytics`

2. **期間設定**
   ```
   開始日: 3ヶ月前の日付
   終了日: 今日の日付
   ```

3. **サマリー統計の確認**
   - 総発注数
   - 総発注額
   - 平均発注額
   - 承認待ち件数・金額

4. **月別推移の確認**
   - 過去3ヶ月の発注推移がテーブルで表示されることを確認
   - 件数と金額が月ごとに集計されていることを確認

5. **仕入先別ランキング**
   - TOP10の仕入先が発注金額順に表示されることを確認
   - 各仕入先の発注件数と金額が表示されることを確認

6. **工事別ランキング**
   - TOP10の工事が発注金額順に表示されることを確認
   - 各工事の発注件数と金額が表示されることを確認

---

## シナリオ8: 承認金額閾値のカスタマイズ（5分）

### 目的
会社の運用に合わせて承認ルールを変更する

### 手順

1. **発注書設定ページへ移動**
   - 発注書一覧ページのURL末尾に `/settings` を追加
   - パス: `/purchase-orders/settings`
   - ※管理者のみアクセス可能

2. **現在の設定確認**
   ```
   レベル1閾値: 100,000円（デフォルト）
   レベル2閾値: 1,000,000円（デフォルト）
   発注番号プレフィックス: PO
   工事紐づけ必須: チェックなし
   ```

3. **承認金額閾値の変更**
   ```
   レベル1閾値: 50,000円に変更
   レベル2閾値: 500,000円に変更
   ```

4. **発注番号プレフィックスの変更**
   ```
   PO → ORD に変更
   ```

5. **工事紐づけ必須設定**
   - チェックボックスをONにする

6. **保存**
   - 「保存」ボタンをクリック
   - 「設定を保存しました」のメッセージが表示されることを確認

7. **設定反映の確認**
   - 新規発注書作成画面へ移動
   - 工事選択が必須項目（赤いアスタリスク）になっていることを確認
   - 新規発注書を作成して発注番号を確認: `ORD-YYYYMMDD-XXX` 形式になっていることを確認

8. **承認金額閾値の動作確認**
   - 5万円未満の発注: リーダーが承認可能
   - 5万円以上50万円未満の発注: 管理者承認必要
   - 50万円以上の発注: 管理者承認必要

---

## シナリオ9: ダッシュボードでの発注状況確認（3分）

### 目的
ダッシュボードで発注の概要を素早く把握する

### 手順

1. **ダッシュボードへ移動**
   - サイドバーから「ダッシュボード」をクリック
   - パス: `/`

2. **発注書管理カードの確認**
   - 「発注書管理」カードが表示されることを確認（DXパッケージ契約組織のみ）
   - 以下の情報が表示されることを確認:
     - 総発注件数
     - 総発注金額
     - 承認待ち件数（オレンジ色のバッジ）

3. **カードをクリック**
   - 発注書管理カードをクリック
   - 発注書一覧ページに遷移することを確認

---

## シナリオ10: モバイル表示確認（5分）

### 目的
スマホからの発注操作を確認する（現場での利用を想定）

### 手順

1. **ブラウザの開発者ツールを開く**
   - Chrome: F12キー → デバイスツールバー切替（Ctrl+Shift+M）
   - デバイス: iPhone 12 Pro または任意のスマホ

2. **発注書一覧の表示確認**
   - テーブルが横スクロール可能になっていることを確認
   - フィルターとボタンがスマホ画面でも操作しやすいことを確認

3. **発注書作成のモバイル操作**
   - 新規作成ボタンをタップ
   - フォーム入力がスマホでも快適に行えることを確認
   - 明細追加ボタンが押しやすいことを確認

4. **PDF出力のモバイル確認**
   - 発注書詳細画面でPDF出力ボタンをタップ
   - PDFがダウンロード/表示されることを確認

---

## トラブルシューティング

### 問題1: 「組織情報が見つかりません」エラー
**原因**: ログインしているユーザーの組織IDが正しく設定されていない
**解決**: 別のテストアカウントでログインするか、データベースを確認

### 問題2: 発注書一覧が空
**原因**: DX効率化パッケージが契約されていない組織でログインしている
**解決**: `admin@test-org-dx.com` でログイン

### 問題3: CSV出力で文字化け
**原因**: BOM付きUTF-8でエンコードされていない
**解決**: コードを確認（既にBOM付きで実装済み）

### 問題4: PDF出力で日本語が表示されない
**原因**: 日本語フォントが読み込まれていない
**解決**: コードを確認（既にNoto Sans JPで実装済み）

---

## チェックリスト

テスト完了後、以下の項目をチェックしてください：

### 基本機能
- [ ] 仕入先の登録・編集・削除ができる
- [ ] 仕入先コードが自動採番される
- [ ] 発注書の作成・編集・削除ができる
- [ ] 発注番号が自動採番される（PO-YYYYMMDD-XXX形式）
- [ ] 明細行の追加・削除ができる
- [ ] 金額が自動計算される（小計、消費税、合計）
- [ ] 下書き保存ができる

### 承認フロー
- [ ] 承認申請ができる
- [ ] 金額に応じた承認権限が機能する
  - [ ] 10万円未満: リーダー以上が承認可能
  - [ ] 10万円以上100万円未満: 管理者承認必要
  - [ ] 100万円以上: 管理者承認必要
- [ ] 差戻しができる
- [ ] 差戻し時に通知が届く
- [ ] 承認時に通知が届く
- [ ] 変更履歴がすべて記録される

### PDF出力
- [ ] PDFが正常に生成される
- [ ] 日本語が正しく表示される
- [ ] 発注番号、仕入先情報、明細、金額が正しく表示される
- [ ] 振込先情報が表示される

### 統合機能
- [ ] 工事詳細ページに発注情報が表示される
- [ ] 予算消化率が正しく計算される
- [ ] 工事でフィルタリングできる
- [ ] ダッシュボードに発注統計が表示される

### 高度な機能
- [ ] CSV出力ができる
- [ ] Excelで開いたときに文字化けしない
- [ ] 一括承認APIが動作する（別途API呼び出しテストが必要）
- [ ] 分析レポートが表示される
  - [ ] 月別推移
  - [ ] 仕入先別ランキング
  - [ ] 工事別ランキング
- [ ] 承認金額閾値のカスタマイズができる
- [ ] 発注番号プレフィックスのカスタマイズができる
- [ ] 工事紐づけ必須設定が機能する

### レスポンシブ対応
- [ ] スマホ表示で操作できる
- [ ] タブレット表示で操作できる

---

## テスト実施記録

| シナリオ | 実施日 | 実施者 | 結果 | 備考 |
|---------|--------|--------|------|------|
| シナリオ1 |        |        |      |      |
| シナリオ2 |        |        |      |      |
| シナリオ3 |        |        |      |      |
| シナリオ4 |        |        |      |      |
| シナリオ5 |        |        |      |      |
| シナリオ6 |        |        |      |      |
| シナリオ7 |        |        |      |      |
| シナリオ8 |        |        |      |      |
| シナリオ9 |        |        |      |      |
| シナリオ10 |       |        |      |      |

---

## 所要時間
- 全シナリオ実施: 約60分
- 基本機能のみ（シナリオ1-4）: 約35分
- レポート・設定（シナリオ5-8）: 約20分
- その他（シナリオ9-10）: 約8分
