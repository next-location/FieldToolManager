# åˆ†ææ©Ÿèƒ½è¨­è¨ˆä»•æ§˜æ›¸

## 1. æ¦‚è¦

Field Tool Managerã®åˆ†ææ©Ÿèƒ½ã¯ã€ä¼æ¥­ãŒå¥‘ç´„ã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å¿œã˜ã¦åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã‚’å‹•çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãŒéƒ¨åˆ†çš„ã«ã—ã‹åˆ©ç”¨ã§ããªã„å ´åˆã§ã‚‚ã€æœ‰ç”¨ãªåˆ†æçµæœã‚’æä¾›ã§ãã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## 2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥æ©Ÿèƒ½åˆ¶ç´„ãƒãƒˆãƒªã‚¯ã‚¹

### 2.1 åˆ©ç”¨å¯èƒ½ãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ | ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ | ãƒ•ãƒ«æ©Ÿèƒ½çµ±åˆãƒ‘ãƒƒã‚¯ |
|-----------|--------------|---------------------|-----------------|
| é“å…·ãƒ»é‡æ©Ÿãƒ»æ¶ˆè€—å“ãƒ‡ãƒ¼ã‚¿ | âœ… | âŒ | âœ… |
| åœ¨åº«ãƒ»ç§»å‹•å±¥æ­´ | âœ… | âŒ | âœ… |
| ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å±¥æ­´ | âœ… | âŒ | âœ… |
| å‡ºé€€å‹¤ãƒ‡ãƒ¼ã‚¿ | âŒ | âœ… | âœ… |
| ä½œæ¥­å ±å‘Šæ›¸ | âŒ | âœ… | âœ… |
| è¦‹ç©ãƒ»è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ | âŒ | âœ… | âœ… |
| æ”¯æ‰•ãƒ»å…¥é‡‘ãƒ‡ãƒ¼ã‚¿ | âŒ | âœ… | âœ… |
| å·¥äº‹ãƒã‚¹ã‚¿ | âŒ | âœ… | âœ… |

### 2.2 åˆ†ææ©Ÿèƒ½ã®åˆ©ç”¨å¯å¦

| åˆ†ææ©Ÿèƒ½ | ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ | ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ | ãƒ•ãƒ«æ©Ÿèƒ½çµ±åˆãƒ‘ãƒƒã‚¯ | å‚™è€ƒ |
|---------|--------------|---------------------|-----------------|------|
| **åœ¨åº«åˆ†æ** | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **é“å…·ç¨¼åƒç‡åˆ†æ** | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆæ¸¬** | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **å·¥äº‹åŸä¾¡åˆ†æ** | âš ï¸ æ‰‹å‹•å…¥åŠ› | âš ï¸ éƒ¨åˆ†çš„ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | æ³¨1 |
| **åæ”¯åˆ†æ** | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **äººä»¶è²»åˆ†æ** | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **è³‡é‡‘ç¹°ã‚Šäºˆæ¸¬** | âŒ åˆ©ç”¨ä¸å¯ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | |
| **ç·åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** | âš ï¸ é™å®šçš„ | âš ï¸ é™å®šçš„ | âœ… ãƒ•ãƒ«æ©Ÿèƒ½ | æ³¨2 |

**æ³¨1**: å·¥äº‹åŸä¾¡åˆ†æã«ãŠã‘ã‚‹åˆ¶ç´„
- ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ï¼šé“å…·ãƒ»é‡æ©Ÿã‚³ã‚¹ãƒˆã¯è‡ªå‹•è¨ˆç®—ã€äººä»¶è²»ãƒ»ææ–™è²»ã¯æ‰‹å‹•å…¥åŠ›
- ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ï¼šäººä»¶è²»ãƒ»ææ–™è²»ã¯è‡ªå‹•è¨ˆç®—ã€é“å…·ãƒ»é‡æ©Ÿã‚³ã‚¹ãƒˆã¯æ‰‹å‹•å…¥åŠ›
- ãƒ•ãƒ«æ©Ÿèƒ½çµ±åˆãƒ‘ãƒƒã‚¯ï¼šå…¨ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—

**æ³¨2**: ç·åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯å¥‘ç´„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å¿œã˜ã¦è¡¨ç¤ºå†…å®¹ãŒå¤‰ã‚ã‚‹

## 3. ãƒ‡ãƒ¼ã‚¿æ¬ ææ™‚ã®å¯¾å¿œç­–

### 3.1 æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 

#### å·¥äº‹åŸä¾¡æ‰‹å‹•å…¥åŠ›ï¼ˆç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ã®ã¿å¥‘ç´„æ™‚ï¼‰

```typescript
interface ManualCostInput {
  project_id: string;
  labor_cost: number;      // äººä»¶è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  material_cost: number;   // ææ–™è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  outsourcing_cost: number; // å¤–æ³¨è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  // é“å…·ãƒ»é‡æ©Ÿã‚³ã‚¹ãƒˆã¯è‡ªå‹•è¨ˆç®—
}
```

#### é“å…·ã‚³ã‚¹ãƒˆæ‰‹å‹•å…¥åŠ›ï¼ˆç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ã®ã¿å¥‘ç´„æ™‚ï¼‰

```typescript
interface ManualToolCostInput {
  project_id: string;
  tool_rental_cost: number;     // é“å…·ãƒ¬ãƒ³ã‚¿ãƒ«è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  equipment_rental_cost: number; // é‡æ©Ÿãƒ¬ãƒ³ã‚¿ãƒ«è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  consumables_cost: number;      // æ¶ˆè€—å“è²»ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  // äººä»¶è²»ãƒ»ææ–™è²»ã¯è‡ªå‹•è¨ˆç®—
}
```

### 3.2 æ¨å®šå€¤ã®æ´»ç”¨

ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ–¹æ³•ã§æ¨å®šå€¤ã‚’æä¾›ï¼š

1. **æ¥­ç•Œå¹³å‡å€¤ã®åˆ©ç”¨**
   - å›½åœŸäº¤é€šçœã®å»ºè¨­å·¥äº‹è²»ãƒ‡ãƒ•ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‚ç…§
   - ä¸€èˆ¬çš„ãªå·¥äº‹åŸä¾¡æ§‹æˆæ¯”ï¼ˆææ–™è²»30%ã€åŠ´å‹™è²»40%ã€æ©Ÿæ¢°è²»10%ã€çµŒè²»20%ï¼‰

2. **éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®æ¨å®š**
   - é¡ä¼¼å·¥äº‹ã®å®Ÿç¸¾å€¤ã‹ã‚‰æ¨å®š
   - å­£ç¯€å¤‰å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**
   - çµ„ç¹”ã”ã¨ã«æ¨™æº–å˜ä¾¡ã‚’è¨­å®šå¯èƒ½
   - é »ç¹ã«ä½¿ç”¨ã™ã‚‹å€¤ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–

## 4. å®Ÿè£…è¨­è¨ˆ

### 4.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
-- æ‰‹å‹•å…¥åŠ›ã‚³ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE manual_cost_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  project_id UUID REFERENCES projects(id),
  entry_type TEXT NOT NULL CHECK (entry_type IN ('labor', 'material', 'tool', 'equipment', 'outsourcing', 'other')),
  amount DECIMAL(10, 2) NOT NULL,
  notes TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- åˆ†æè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆçµ„ç¹”ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
CREATE TABLE analytics_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  setting_type TEXT NOT NULL,
  setting_key TEXT NOT NULL,
  setting_value JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(organization_id, setting_type, setting_key)
);

-- åˆ†æçµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE analytics_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  analysis_type TEXT NOT NULL,
  target_date DATE NOT NULL,
  result_data JSONB NOT NULL,
  data_sources JSONB NOT NULL, -- ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
  has_manual_entries BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMPTZ,
  INDEX idx_analytics_cache_lookup (organization_id, analysis_type, target_date)
);
```

### 4.2 APIè¨­è¨ˆ

#### åˆ†æãƒ‡ãƒ¼ã‚¿å–å¾—API

```typescript
// app/api/analytics/project-cost/route.ts
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const projectId = searchParams.get('project_id');

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥‘ç´„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèª
  const packages = await getContractedPackages(organization_id);

  let costData = {
    labor_cost: 0,
    material_cost: 0,
    tool_cost: 0,
    equipment_cost: 0,
    outsourcing_cost: 0,
    total_cost: 0,
    data_completeness: 'full' as 'full' | 'partial' | 'estimated'
  };

  // ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
  if (packages.includes('asset_management')) {
    // é“å…·ãƒ»é‡æ©Ÿã‚³ã‚¹ãƒˆã‚’è‡ªå‹•è¨ˆç®—
    const toolCosts = await calculateToolCosts(projectId);
    costData.tool_cost = toolCosts.tool_cost;
    costData.equipment_cost = toolCosts.equipment_cost;
  }

  if (packages.includes('dx_efficiency')) {
    // äººä»¶è²»ãƒ»ææ–™è²»ã‚’è‡ªå‹•è¨ˆç®—
    const laborCosts = await calculateLaborCosts(projectId);
    const materialCosts = await calculateMaterialCosts(projectId);
    costData.labor_cost = laborCosts.total;
    costData.material_cost = materialCosts.total;
  }

  // æ‰‹å‹•å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const manualEntries = await getManualCostEntries(projectId);

  // ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã‚’åˆ¤å®š
  if (!packages.includes('asset_management') || !packages.includes('dx_efficiency')) {
    costData.data_completeness = 'partial';
  }

  return NextResponse.json(costData);
}
```

### 4.3 UI/UXè¨­è¨ˆ

#### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º

```typescript
// components/analytics/Dashboard.tsx
'use client';

import { useContractedPackages } from '@/hooks/useContractedPackages';

export default function AnalyticsDashboard() {
  const { packages, loading } = useContractedPackages();

  if (loading) return <LoadingSpinner />;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {/* ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯å¥‘ç´„æ™‚ã®ã¿è¡¨ç¤º */}
      {packages.includes('asset_management') && (
        <>
          <InventoryAnalyticsCard />
          <ToolUtilizationCard />
          <MaintenancePredictionCard />
        </>
      )}

      {/* ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯å¥‘ç´„æ™‚ã®ã¿è¡¨ç¤º */}
      {packages.includes('dx_efficiency') && (
        <>
          <RevenueAnalyticsCard />
          <CashFlowForecastCard />
          <LaborCostAnalyticsCard />
        </>
      )}

      {/* ä¸¡æ–¹å¥‘ç´„æ™‚ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹çµ±åˆåˆ†æ */}
      {packages.includes('asset_management') && packages.includes('dx_efficiency') && (
        <>
          <IntegratedPLCard />
          <ROIAnalysisCard />
          <ComprehensiveCostCard />
        </>
      )}

      {/* ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã®æ‰‹å‹•å…¥åŠ›ä¿ƒé€²ã‚«ãƒ¼ãƒ‰ */}
      {!packages.includes('asset_management') && packages.includes('dx_efficiency') && (
        <ManualToolCostInputCard />
      )}

      {packages.includes('asset_management') && !packages.includes('dx_efficiency') && (
        <ManualLaborCostInputCard />
      )}
    </div>
  );
}
```

#### æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«

```typescript
// components/analytics/ManualCostInputModal.tsx
export default function ManualCostInputModal({ projectId, costType }) {
  const [formData, setFormData] = useState({
    amount: 0,
    notes: ''
  });

  const handleSubmit = async () => {
    await fetch('/api/analytics/manual-costs', {
      method: 'POST',
      body: JSON.stringify({
        project_id: projectId,
        entry_type: costType,
        amount: formData.amount,
        notes: formData.notes
      })
    });
  };

  return (
    <Modal>
      <h2>æ‰‹å‹•ã‚³ã‚¹ãƒˆå…¥åŠ›</h2>
      <div className="bg-yellow-50 p-4 rounded-md mb-4">
        <p className="text-sm text-yellow-800">
          <InfoIcon className="inline mr-2" />
          {costType === 'labor' && 'ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ã‚’å¥‘ç´„ã™ã‚‹ã¨ã€å‡ºé€€å‹¤ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™'}
          {costType === 'tool' && 'ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ã‚’å¥‘ç´„ã™ã‚‹ã¨ã€é“å…·ä½¿ç”¨å±¥æ­´ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™'}
        </p>
      </div>

      <form onSubmit={handleSubmit}>
        <label>
          é‡‘é¡
          <input
            type="number"
            value={formData.amount}
            onChange={(e) => setFormData({...formData, amount: e.target.value})}
          />
        </label>

        <label>
          å‚™è€ƒ
          <textarea
            value={formData.notes}
            onChange={(e) => setFormData({...formData, notes: e.target.value})}
            placeholder="è¦‹ç©æ›¸ç•ªå·ã€è¨ˆç®—æ ¹æ‹ ãªã©"
          />
        </label>

        <button type="submit">ä¿å­˜</button>
      </form>
    </Modal>
  );
}
```

### 4.4 ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ­ã‚¸ãƒƒã‚¯

```typescript
// lib/analytics/cost-calculator.ts

export async function calculateProjectCost(
  projectId: string,
  organizationId: string
): Promise<ProjectCost> {
  const packages = await getContractedPackages(organizationId);

  const cost: ProjectCost = {
    labor: { amount: 0, source: 'none', confidence: 0 },
    material: { amount: 0, source: 'none', confidence: 0 },
    tool: { amount: 0, source: 'none', confidence: 0 },
    equipment: { amount: 0, source: 'none', confidence: 0 },
    outsourcing: { amount: 0, source: 'none', confidence: 0 }
  };

  // 1. è‡ªå‹•è¨ˆç®—å¯èƒ½ãªã‚³ã‚¹ãƒˆã‚’å–å¾—
  if (packages.includes('dx_efficiency')) {
    // å‡ºé€€å‹¤ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰äººä»¶è²»è¨ˆç®—
    const attendance = await getAttendanceData(projectId);
    if (attendance.length > 0) {
      cost.labor.amount = calculateLaborFromAttendance(attendance);
      cost.labor.source = 'automatic';
      cost.labor.confidence = 95;
    }

    // è«‹æ±‚æ›¸ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ææ–™è²»è¨ˆç®—
    const invoices = await getProjectInvoices(projectId);
    cost.material.amount = sumMaterialCosts(invoices);
    cost.material.source = 'automatic';
    cost.material.confidence = 100;
  }

  if (packages.includes('asset_management')) {
    // é“å…·ä½¿ç”¨å±¥æ­´ã‹ã‚‰ã‚³ã‚¹ãƒˆè¨ˆç®—
    const toolUsage = await getToolUsageHistory(projectId);
    cost.tool.amount = calculateToolDepreciation(toolUsage);
    cost.tool.source = 'automatic';
    cost.tool.confidence = 90;

    // é‡æ©Ÿä½¿ç”¨å±¥æ­´ã‹ã‚‰ã‚³ã‚¹ãƒˆè¨ˆç®—
    const equipmentUsage = await getEquipmentUsageHistory(projectId);
    cost.equipment.amount = calculateEquipmentCost(equipmentUsage);
    cost.equipment.source = 'automatic';
    cost.equipment.confidence = 90;
  }

  // 2. æ‰‹å‹•å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const manualEntries = await getManualCostEntries(projectId);
  for (const entry of manualEntries) {
    if (!cost[entry.entry_type].source || cost[entry.entry_type].source === 'none') {
      cost[entry.entry_type].amount = entry.amount;
      cost[entry.entry_type].source = 'manual';
      cost[entry.entry_type].confidence = 80;
    }
  }

  // 3. æ¨å®šå€¤ã§è£œå®Œï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
  const projectInfo = await getProjectInfo(projectId);
  const industryAverage = await getIndustryAverageRatio(projectInfo.type);

  for (const costType of Object.keys(cost)) {
    if (cost[costType].source === 'none') {
      // ä»–ã®ã‚³ã‚¹ãƒˆã‹ã‚‰æ¨å®š
      const totalKnownCost = Object.values(cost)
        .filter(c => c.source !== 'none')
        .reduce((sum, c) => sum + c.amount, 0);

      if (totalKnownCost > 0) {
        cost[costType].amount = totalKnownCost * industryAverage[costType];
        cost[costType].source = 'estimated';
        cost[costType].confidence = 60;
      }
    }
  }

  return cost;
}
```

## 5. è¡¨ç¤ºåˆ¶å¾¡ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°

### 5.1 ãƒ‡ãƒ¼ã‚¿ä¸è¶³æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
const DataSourceIndicator = ({ source, confidence }) => {
  const messages = {
    automatic: { icon: 'âœ…', text: 'è‡ªå‹•è¨ˆç®—', color: 'green' },
    manual: { icon: 'âœï¸', text: 'æ‰‹å‹•å…¥åŠ›', color: 'yellow' },
    estimated: { icon: 'ğŸ“Š', text: 'æ¨å®šå€¤', color: 'orange' },
    none: { icon: 'âŒ', text: 'ãƒ‡ãƒ¼ã‚¿ãªã—', color: 'red' }
  };

  const info = messages[source];

  return (
    <div className={`flex items-center text-${info.color}-600`}>
      <span>{info.icon}</span>
      <span className="ml-1 text-sm">{info.text}</span>
      {confidence && (
        <span className="ml-2 text-xs">
          (ä¿¡é ¼åº¦: {confidence}%)
        </span>
      )}
    </div>
  );
};
```

### 5.2 ã‚¢ãƒƒãƒ—ã‚»ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
const PackageUpgradePrompt = ({ missingPackage }) => {
  const benefits = {
    asset_management: [
      'é“å…·ãƒ»é‡æ©Ÿã‚³ã‚¹ãƒˆã®è‡ªå‹•è¨ˆç®—',
      'åœ¨åº«æœ€é©åŒ–ã«ã‚ˆã‚‹20%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›',
      'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆæ¸¬ã§ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ å‰Šæ¸›'
    ],
    dx_efficiency: [
      'äººä»¶è²»ã®è‡ªå‹•è¨ˆç®—',
      'è«‹æ±‚æ›¸ã‹ã‚‰ã®åŸä¾¡è‡ªå‹•é›†è¨ˆ',
      'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼äºˆæ¸¬'
    ]
  };

  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h3 className="font-bold text-blue-900 mb-2">
        ã‚ˆã‚Šæ­£ç¢ºãªåˆ†æã®ãŸã‚ã«
      </h3>
      <p className="text-sm text-blue-800 mb-3">
        {missingPackage === 'asset_management' ? 'ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯' : 'ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯'}
        ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š
      </p>
      <ul className="list-disc list-inside text-sm text-blue-700">
        {benefits[missingPackage].map((benefit, idx) => (
          <li key={idx}>{benefit}</li>
        ))}
      </ul>
      <button className="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ã®ç›¸è«‡
      </button>
    </div>
  );
};
```

## 6. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›æ™‚ã®å¯¾å¿œ

### 6.1 PDF/CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã®æ³¨è¨˜

```typescript
const generateAnalyticsReport = async (projectId: string, format: 'pdf' | 'csv') => {
  const costData = await calculateProjectCost(projectId);

  // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å†…è¨³ã‚’é›†è¨ˆ
  const dataSources = {
    automatic: 0,
    manual: 0,
    estimated: 0,
    none: 0
  };

  Object.values(costData).forEach(item => {
    dataSources[item.source]++;
  });

  // ãƒ¬ãƒãƒ¼ãƒˆã«æ³¨è¨˜ã‚’è¿½åŠ 
  const notes = [];

  if (dataSources.manual > 0) {
    notes.push('â€» ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯æ‰‹å‹•å…¥åŠ›å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™');
  }

  if (dataSources.estimated > 0) {
    notes.push('â€» ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¥­ç•Œå¹³å‡å€¤ã‹ã‚‰ã®æ¨å®šå€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™');
  }

  if (format === 'pdf') {
    // PDFã«æ³¨è¨˜æ¬„ã‚’è¿½åŠ 
    doc.setFontSize(8);
    doc.text(notes.join('\n'), 10, 280);
  } else {
    // CSVã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
    const metadata = [
      ['ãƒ‡ãƒ¼ã‚¿å“è³ªæƒ…å ±'],
      ['è‡ªå‹•è¨ˆç®—é …ç›®æ•°', dataSources.automatic],
      ['æ‰‹å‹•å…¥åŠ›é …ç›®æ•°', dataSources.manual],
      ['æ¨å®šå€¤é …ç›®æ•°', dataSources.estimated],
      [''],
      ...notes.map(note => [note])
    ];
  }
};
```

## 7. å®Ÿè£…å„ªå…ˆé †ä½

### Phase 1: åŸºæœ¬å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
2. æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
3. ãƒ‡ãƒ¼ã‚¿çµ±åˆåŸºæœ¬ãƒ­ã‚¸ãƒƒã‚¯

### Phase 2: UIå®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
2. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
3. ã‚¢ãƒƒãƒ—ã‚»ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### Phase 3: é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆ2é€±é–“ï¼‰
1. æ¨å®šå€¤è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
2. ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
3. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å¯¾å¿œ

### Phase 4: æœ€é©åŒ–ï¼ˆ1é€±é–“ï¼‰
1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

## 8. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 8.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
describe('ProjectCostCalculator', () => {
  it('ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ã®ã¿ã®å ´åˆã€äººä»¶è²»ã¯æ‰‹å‹•å…¥åŠ›ã‚’ä½¿ç”¨', async () => {
    const packages = ['asset_management'];
    const manualEntry = { entry_type: 'labor', amount: 500000 };

    const result = await calculateProjectCost(projectId, orgId);

    expect(result.labor.source).toBe('manual');
    expect(result.labor.amount).toBe(500000);
  });

  it('ãƒ•ãƒ«æ©Ÿèƒ½ãƒ‘ãƒƒã‚¯ã®å ´åˆã€å…¨ã¦è‡ªå‹•è¨ˆç®—', async () => {
    const packages = ['asset_management', 'dx_efficiency'];

    const result = await calculateProjectCost(projectId, orgId);

    expect(result.labor.source).toBe('automatic');
    expect(result.tool.source).toBe('automatic');
  });
});
```

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®çµ„ã¿åˆã‚ã›ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ã‚¹ãƒˆï¼š
- ç¾å ´è³‡ç”£ãƒ‘ãƒƒã‚¯ã®ã¿
- ç¾å ´DXæ¥­å‹™åŠ¹ç‡åŒ–ãƒ‘ãƒƒã‚¯ã®ã¿
- ãƒ•ãƒ«æ©Ÿèƒ½çµ±åˆãƒ‘ãƒƒã‚¯
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã—ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰

## 9. ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

```typescript
// åˆ†æç²¾åº¦ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
const monitorAnalyticsAccuracy = async () => {
  const metrics = await db.query(`
    SELECT
      organization_id,
      COUNT(CASE WHEN data_sources->>'primary' = 'automatic' THEN 1 END) as automatic_count,
      COUNT(CASE WHEN data_sources->>'primary' = 'manual' THEN 1 END) as manual_count,
      COUNT(CASE WHEN data_sources->>'primary' = 'estimated' THEN 1 END) as estimated_count
    FROM analytics_cache
    WHERE created_at > NOW() - INTERVAL '7 days'
    GROUP BY organization_id
  `);

  // æ‰‹å‹•å…¥åŠ›ãŒå¤šã„çµ„ç¹”ã«ã‚¢ãƒƒãƒ—ã‚»ãƒ«ã®ææ¡ˆ
  for (const org of metrics) {
    if (org.manual_count > org.automatic_count) {
      await sendUpgradeRecommendation(org.organization_id);
    }
  }
};
```

## 10. ã¾ã¨ã‚

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ï¼š

1. **æŸ”è»Ÿæ€§**: å¥‘ç´„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«é–¢ã‚ã‚‰ãšã€åˆ©ç”¨å¯èƒ½ãªç¯„å›²ã§æœ€å¤§é™ã®ä¾¡å€¤ã‚’æä¾›
2. **é€æ˜æ€§**: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ä¿¡é ¼åº¦ã‚’æ˜ç¢ºã«è¡¨ç¤º
3. **æˆé•·æ€§**: ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã‚’å¯è¦–åŒ–ã—ã€ã‚¢ãƒƒãƒ—ã‚»ãƒ«ã®æ©Ÿä¼šã‚’å‰µå‡º
4. **å®Ÿç”¨æ€§**: æ‰‹å‹•å…¥åŠ›ã¨æ¨å®šå€¤ã«ã‚ˆã‚Šã€éƒ¨åˆ†çš„ãªãƒ‡ãƒ¼ã‚¿ã§ã‚‚åˆ†æå¯èƒ½

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é–“ã®ä¾å­˜é–¢ä¿‚ã«ã‚ˆã‚‹åˆ¶ç´„ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã†ã“ã¨ãªãè§£æ±ºã—ã€
æ®µéšçš„ãªæ©Ÿèƒ½æ‹¡å¼µã‚’ä¿ƒé€²ã™ã‚‹è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯åˆ†ææ©Ÿèƒ½ã®å®Ÿè£…è¨­è¨ˆã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚*
*å®Ÿè£…æ™‚ã¯ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«åŸºã¥ã„ã¦èª¿æ•´ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚*