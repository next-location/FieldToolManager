# ログインセキュリティ - 手動テストガイド

## テスト環境

- **管理者ログイン**: https://zairoku.com/admin/login
- **利用者ログイン**: https://[サブドメイン].zairoku.com/login

---

## 📋 テスト項目一覧

### ✅ Test 1: 管理者ログインのレート制限

**URL**: https://zairoku.com/admin/login

**手順**:
1. ブラウザで管理者ログインページを開く
2. 存在しないメールアドレスとパスワードを入力
   - Email: `test@example.com`
   - Password: `wrongpassword`
3. 「ログイン」ボタンをクリック（1回目）
4. エラーメッセージを確認: `メールアドレスまたはパスワードが正しくありません`
5. 同じ手順を繰り返す（2回目、3回目）
6. **4回目のログイン試行時**、以下のいずれかのエラーが表示されるべき:
   - ✅ `リクエスト制限に達しました`
   - ✅ `しばらく時間をおいてから再度お試しください`
   - ✅ HTTP 429エラー

**期待結果**:
- ❌ 4回目も「メールアドレスまたはパスワードが正しくありません」→ **レート制限が機能していない**
- ✅ 4回目で「リクエスト制限に達しました」→ **正常に機能**

---

### ✅ Test 2: 利用者ログインのレート制限

**URL**: https://[あなたの組織のサブドメイン].zairoku.com/login

**手順**:
1. ブラウザで利用者ログインページを開く
2. 存在しないメールアドレスとパスワードを入力
   - Email: `test@example.com`
   - Password: `wrongpassword`
3. 「ログイン」ボタンをクリック（1回目）
4. エラーメッセージを確認
5. 同じ手順を繰り返す（2回目、3回目）
6. **4回目のログイン試行時**、レート制限エラーが表示されるべき

**期待結果**:
- ✅ 4回目で「リクエスト制限に達しました」→ **正常に機能**

---

### ✅ Test 3: 正常なログイン（リダイレクト確認）

#### 管理者ログイン

**URL**: https://zairoku.com/admin/login

**手順**:
1. **レート制限をリセット**（10分待つ、またはブラウザのシークレットモードを使用）
2. 正しい管理者の認証情報を入力
3. 「ログイン」ボタンをクリック
4. リダイレクト先を確認

**期待結果**:
- ✅ `/admin/dashboard` にリダイレクトされる
- ❌ トップページ `/` にリダイレクトされる → **問題あり**

#### 利用者ログイン

**URL**: https://[サブドメイン].zairoku.com/login

**手順**:
1. **レート制限をリセット**
2. 正しい利用者の認証情報を入力
3. 「ログイン」ボタンをクリック
4. リダイレクト先を確認

**期待結果**:
- ✅ ダッシュボード `/` にリダイレクトされる
- ❌ ログインページに戻る → **問題あり**

---

### ✅ Test 4: フロントエンドバリデーション

**URL**: いずれかのログインページ

**手順**:
1. メールアドレス欄に不正な形式を入力:
   - `test@` (ドメイン部分なし)
   - `notanemail` (@なし)
2. 「ログイン」ボタンをクリック

**期待結果**:
- ✅ ブラウザのバリデーションメッセージが表示される（送信前にブロック）
- 例: `有効なメールアドレスを入力してください`

---

### ✅ Test 5: パスワード長のバリデーション

**URL**: いずれかのログインページ

**手順**:
1. パスワード欄に7文字以下を入力:
   - `1234567` (7文字)
2. 「ログイン」ボタンをクリック

**期待結果**:
- ✅ ブラウザのバリデーションメッセージが表示される
- 例: `8文字以上入力してください`

---

## 🔍 追加確認項目

### サブドメイン対応の確認

利用者ログインのセキュリティ対策は、以下のURLでも動作する必要があります:

- `https://組織A.zairoku.com/login`
- `https://組織B.zairoku.com/login`
- `https://デモ.zairoku.com/login`

**確認事項**:
- レート制限が機能しているか
- HTMLエスケープが機能しているか
- 海外IP警告が機能しているか（該当する場合）

---

## 📝 テスト結果記録用テンプレート

```
テスト実施日時: YYYY/MM/DD HH:MM

## Test 1: 管理者ログインのレート制限
- [ ] 合格
- [ ] 不合格
- 備考:

## Test 2: 利用者ログインのレート制限（サブドメイン）
- [ ] 合格
- [ ] 不合格
- 使用したURL: https://______.zairoku.com/login
- 備考:

## Test 3: 正常なログイン（管理者）
- [ ] 合格（/admin/dashboardにリダイレクト）
- [ ] 不合格（リダイレクト先: ______ ）
- 備考:

## Test 4: 正常なログイン（利用者）
- [ ] 合格（ダッシュボードにリダイレクト）
- [ ] 不合格（リダイレクト先: ______ ）
- 備考:

## Test 5: フロントエンドバリデーション
- [ ] 合格
- [ ] 不合格
- 備考:

## Test 6: パスワード長バリデーション
- [ ] 合格
- [ ] 不合格
- 備考:
```

---

## ⚠️ 注意事項

1. **レート制限のリセット**: テストごとに10分待つか、異なるIPアドレス（シークレットモード、VPN等）を使用してください。

2. **本番環境**: このテストは本番環境で実行するため、実際のユーザーに影響がないよう、深夜など利用が少ない時間帯に実施することを推奨します。

3. **CSRF トークン**: ブラウザでのテストでは自動的に処理されるため、スクリプトテストで発生したCSRFエラーは発生しません。

4. **Supabase ログ確認**: テスト後、Supabase Dashboardで `rate_limits` テーブルを確認し、レコードが作成されていることを確認できます。
   ```sql
   SELECT * FROM rate_limits ORDER BY created_at DESC LIMIT 10;
   ```

---

## 🎯 合格基準

以下の条件を全て満たす場合、テスト合格とみなします:

- ✅ レート制限が4回目の試行でブロックする
- ✅ 正常なログインが成功し、正しいページにリダイレクトされる
- ✅ フロントエンドバリデーションが機能する
- ✅ サブドメイン経由のログインでもセキュリティ対策が機能する
