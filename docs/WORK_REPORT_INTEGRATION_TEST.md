# 作業報告書機能 統合テスト手順書

## 📋 目次

1. [事前準備](#事前準備)
2. [Phase 1: 基本機能テスト](#phase-1-基本機能テスト)
3. [Phase 2: カスタムフィールドテスト](#phase-2-カスタムフィールドテスト)
4. [Phase 3: 写真・添付ファイルテスト](#phase-3-写真添付ファイルテスト)
5. [Phase 4: 承認フローテスト](#phase-4-承認フローテスト)
6. [PDF出力テスト](#pdf出力テスト)
7. [チェックリスト](#チェックリスト)

---

## 事前準備

### ✅ データベースとサーバーの確認

1. **Supabase起動確認**
   ```bash
   npx supabase status
   ```
   - すべてのサービスが `running` になっていることを確認

2. **開発サーバー起動**
   ```bash
   npm run dev
   ```
   - http://localhost:3000 でアクセスできることを確認

3. **テストアカウント情報**

   | 役割 | メールアドレス | パスワード | 権限 |
   |------|---------------|-----------|------|
   | 管理者 | admin@test.com | password123 | 承認権限あり |
   | マネージャー | manager@test.com | password123 | 承認権限あり |
   | 一般ユーザー | user@test.com | password123 | 一般ユーザー |

4. **テストデータ確認**
   - 組織: A建設株式会社
   - クライアント: B商事株式会社
   - 現場: 新宿オフィスビル建設現場、渋谷マンション改修工事
   - カスタムフィールド: 気温（数値）、安全確認（チェックボックス）

---

## Phase 1: 基本機能テスト

### 1-1. ログインとダッシュボード表示

**テスト手順:**

1. http://localhost:3000 にアクセス
2. `user@test.com` / `password123` でログイン
3. ダッシュボードが表示されることを確認
4. サイドバーに「作業報告書」メニューがあることを確認

**期待結果:**
- ✅ ログイン成功
- ✅ ダッシュボード表示
- ✅ 作業報告書メニュー表示

---

### 1-2. 作業報告書一覧表示

**テスト手順:**

1. サイドバーの「作業報告書」をクリック
2. 作業報告書一覧ページ `/work-reports` に遷移
3. 「新規作成」ボタンがあることを確認
4. 一覧が空であることを確認（初期状態）

**期待結果:**
- ✅ 一覧ページ表示
- ✅ 新規作成ボタン表示
- ✅ 空の一覧表示

---

### 1-3. 作業報告書の新規作成（基本項目のみ）

**テスト手順:**

1. 「新規作成」ボタンをクリック
2. `/work-reports/new` に遷移
3. 以下の情報を入力:

   **基本情報:**
   - **現場**: `新宿オフィスビル建設現場` を選択
   - **作業日**: `2025-12-06`（今日の日付）
   - **天気**: `☀️ 晴れ` を選択

   **作業時間:**
   - **開始時刻**: `08:00`（デフォルト値のまま）
   - **終了時刻**: `17:00`（デフォルト値のまま）
   - **休憩時間（分）**: `60`（デフォルト値のまま）
   - **時間外（残業時間）**: `0`（空欄のまま）
   - ※実作業時間: 8.0時間 と表示されることを確認

   **帯同作業員:**
   - 「+ 追加」ボタンをクリック
   - セレクトボックスから `マネージャー次郎 (manager@test.com)` を選択
   - 時間外（残業時間）: `0`（空欄のまま）

   **作業内容:**
   ```
   外壁タイル貼り作業
   - 下地処理完了
   - タイル貼り付け（30㎡）
   - 目地埋め作業
   ```

   **オプション:**
   - **作業場所（詳細）**: `3階 東側エリア`
   - **進捗率（%）**: `45`
   - **使用資材**:
     ```
     タイル（300×600） 200枚
     接着剤 20kg
     目地材 10kg
     ```
   - **使用道具**:
     ```
     電動ドリル
     サンダー
     水平器
     ```

   **特記事項・備考:**（空欄のままでOK）

4. 「下書き保存」ボタンをクリック

**期待結果:**
- ✅ 入力フォームが正しく表示
- ✅ 現場のドロップダウンに2つの現場が表示
- ✅ 天気の選択肢（☀️ 晴れ/☁️ 曇り/🌧️ 雨/⛄ 雪）表示
- ✅ 作業時間が自動計算されて表示される
- ✅ 帯同作業員の「+ 追加」ボタンが動作
- ✅ 帯同作業員のセレクトボックスに他の社員が表示
- ✅ 帯同作業員の「削除」ボタンが動作
- ✅ 「下書き保存」成功後、詳細ページにリダイレクト

---

### 1-4. 作業報告書詳細表示

**テスト手順:**

1. 詳細ページが表示されることを確認
2. 以下の情報が正しく表示されていることを確認:
   - ステータスバッジ「下書き」（グレー）
   - 作業日: 2025年12月6日
   - 現場: 新宿オフィスビル建設現場（リンク）
   - 天気: ☀️ 晴れ
   - 作業時間: 08:00〜17:00（休憩60分）
   - 実作業時間: 8.0時間
   - 作業員: ユーザー三郎、マネージャー次郎（各8.0時間）
   - 作業内容: 入力したテキスト
   - 作業場所: 3階 東側エリア
   - 進捗率: 45%（プログレスバー表示）
   - 使用資材: 入力したテキスト
   - 使用道具: 入力したテキスト
3. 「編集」ボタンが表示されることを確認
4. 「削除」ボタンが表示されることを確認
5. 「提出」ボタンが表示されることを確認

**期待結果:**
- ✅ すべての入力情報が正しく表示
- ✅ ステータスバッジが「下書き」
- ✅ 編集・削除・提出ボタンが表示
- ✅ 承認ボタンは表示されない（下書き状態）

---

### 1-5. 作業報告書の編集

**テスト手順:**

1. 「編集」ボタンをクリック
2. `/work-reports/[id]/edit` に遷移
3. 作業内容を以下に変更:
   ```
   外壁タイル貼り作業
   - 下地処理完了
   - タイル貼り付け（50㎡）← 変更
   - 目地埋め作業
   - 清掃完了 ← 追加
   ```
4. 進捗率を 60% に変更
5. 「保存」ボタンをクリック

**期待結果:**
- ✅ 編集フォームに既存データが表示
- ✅ 変更が保存される
- ✅ 詳細ページで変更内容が反映されている

---

### 1-6. 作業報告書一覧での確認

**テスト手順:**

1. 「作業報告書一覧に戻る」リンクをクリック
2. 作成した報告書が一覧に表示されることを確認
3. 以下の情報が表示されていることを確認:
   - 報告日: 2025年12月6日
   - 現場名: 新宿オフィスビル建設現場
   - ステータス: 下書き
   - 進捗率: 60%

**期待結果:**
- ✅ 一覧に1件表示
- ✅ すべての情報が正しく表示
- ✅ クリックで詳細ページに遷移

---

## Phase 2: カスタムフィールドテスト

### 2-1. カスタムフィールド表示確認

**テスト手順:**

1. 先ほど作成した報告書の編集ページに戻る
2. 「業種固有項目」セクションが表示されることを確認
3. 以下のフィールドがあることを確認:
   - 気温（数値入力）- プレースホルダー「例: 25」
   - 安全確認（チェックボックス）- 3つの選択肢

**期待結果:**
- ✅ 業種固有項目セクション表示
- ✅ 気温フィールド（数値）表示
- ✅ 安全確認フィールド（チェックボックス）表示

---

### 2-2. カスタムフィールドの入力

**テスト手順:**

1. 気温に「18」を入力
2. 安全確認で以下をチェック:
   - ✅ ヘルメット着用
   - ✅ 安全帯確認
   - ✅ 立入禁止区域設定
3. 「保存」ボタンをクリック
4. 詳細ページに戻る

**期待結果:**
- ✅ カスタムフィールドの入力が可能
- ✅ 保存成功

---

### 2-3. カスタムフィールド表示確認（詳細ページ）

**テスト手順:**

1. 詳細ページで「業種固有項目」セクションを確認
2. 以下が表示されていることを確認:
   - 気温: 18
   - 安全確認: ヘルメット着用, 安全帯確認, 立入禁止区域設定

**期待結果:**
- ✅ カスタムフィールドが正しく表示
- ✅ チェックボックスの複数選択が反映

---

## Phase 3: 写真・添付ファイルテスト

### 3-1. 写真アップロード

**テスト手順:**

1. 詳細ページで「写真ギャラリー」セクションを確認
2. 「写真を追加」ボタンをクリック
3. テスト用の画像ファイル（JPG/PNG）を3枚選択
   - または画像をドラッグ&ドロップ
4. 各写真にキャプションを入力:
   - 写真1: 作業開始前の様子
   - 写真2: タイル貼り付け作業中
   - 写真3: 作業完了後
5. アップロードの進捗が表示されることを確認
6. アップロード完了後、写真がグリッド表示されることを確認

**期待結果:**
- ✅ ファイル選択ダイアログ表示
- ✅ ドラッグ&ドロップ動作
- ✅ アップロード進捗表示
- ✅ 写真がグリッド表示（2列）
- ✅ キャプション表示
- ✅ ファイルサイズ5MB以下のチェック

---

### 3-2. 写真の編集・削除

**テスト手順:**

1. 写真1のキャプションを「作業開始前（8:00）」に変更
2. 「保存」ボタンをクリック
3. 写真3の「削除」ボタンをクリック
4. 確認ダイアログで「OK」をクリック
5. ページをリロードして変更が保持されていることを確認

**期待結果:**
- ✅ キャプション編集成功
- ✅ 写真削除成功
- ✅ 2枚の写真が残っている
- ✅ 変更が永続化されている

---

### 3-3. 添付ファイルアップロード

**テスト手順:**

1. 「添付資料」セクションを確認
2. 「ファイルを追加」ボタンをクリック
3. テスト用のPDFファイルを選択
4. ファイル種別で「図面」を選択
5. 説明に「現場レイアウト図」と入力
6. アップロードボタンをクリック
7. ファイルが一覧に表示されることを確認

**期待結果:**
- ✅ ファイル選択ダイアログ表示
- ✅ ファイル種別の選択肢（図面/仕様書/マニュアル/その他）表示
- ✅ アップロード成功
- ✅ ファイル一覧に表示
- ✅ ファイルサイズ10MB以下のチェック

---

### 3-4. 添付ファイルのダウンロード・削除

**テスト手順:**

1. アップロードしたファイルの「ダウンロード」リンクをクリック
2. ファイルがダウンロードされることを確認
3. 「削除」ボタンをクリック
4. 確認ダイアログで「OK」をクリック
5. ファイルが一覧から削除されることを確認

**期待結果:**
- ✅ ファイルダウンロード成功
- ✅ ファイル削除成功
- ✅ 一覧から削除されている

---

## Phase 4: 承認フローテスト

### 4-1. 作業報告書の提出（一般ユーザー）

**テスト手順:**

1. 詳細ページで「提出」ボタンをクリック
2. 確認モーダルが表示されることを確認
3. 「提出する」ボタンをクリック
4. ステータスバッジが「提出済み」（青色）に変わることを確認
5. 「編集」ボタンが表示されなくなることを確認
6. 「承認」「却下」ボタンが表示されないことを確認（一般ユーザー）

**期待結果:**
- ✅ 提出確認モーダル表示
- ✅ ステータスが「提出済み」に変更
- ✅ 編集ボタン非表示
- ✅ 一般ユーザーには承認ボタン非表示

---

### 4-2. 承認権限の確認（マネージャー）

**テスト手順:**

1. ログアウトする
2. `manager@test.com` / `password123` でログイン
3. 作業報告書一覧に移動
4. 先ほど提出した報告書をクリック
5. 「承認」「却下」ボタンが表示されることを確認

**期待結果:**
- ✅ マネージャーでログイン成功
- ✅ 承認・却下ボタンが表示される

---

### 4-3. 作業報告書の却下

**テスト手順:**

1. 「却下」ボタンをクリック
2. コメント入力モーダルが表示される
3. 却下コメントに以下を入力:
   ```
   作業内容の記載が不十分です。
   使用資材の数量を追記してください。
   ```
4. 「却下する」ボタンをクリック
5. ステータスが「却下」（赤色）に変わることを確認
6. 承認履歴セクションが表示されることを確認
7. 却下理由とマネージャー名が表示されることを確認

**期待結果:**
- ✅ コメント入力モーダル表示
- ✅ ステータスが「却下」に変更
- ✅ 承認履歴に却下情報表示
- ✅ 却下理由とマネージャー名表示

---

### 4-4. 却下された報告書の再編集（一般ユーザー）

**テスト手順:**

1. ログアウトして `user@test.com` で再ログイン
2. 却下された報告書の詳細ページに移動
3. 「編集」ボタンが表示されることを確認（却下された報告書は再編集可能）
4. 「編集」ボタンをクリック
5. 使用資材を以下に変更:
   ```
   - タイル（300×600） 200枚
   - 接着剤 20kg
   - 目地材 10kg
   ```
6. 「保存」ボタンをクリック
7. 詳細ページで「提出」ボタンをクリック
8. 再提出の確認モーダルが表示されることを確認
9. 「提出する」ボタンをクリック

**期待結果:**
- ✅ 却下された報告書の編集が可能
- ✅ 修正内容が保存される
- ✅ 再提出成功
- ✅ ステータスが「提出済み」に戻る

---

### 4-5. 作業報告書の承認（管理者）

**テスト手順:**

1. ログアウトして `admin@test.com` でログイン
2. 再提出された報告書の詳細ページに移動
3. 内容を確認
4. 「承認」ボタンをクリック
5. コメント入力モーダルが表示される
6. 承認コメントに以下を入力（任意）:
   ```
   修正内容を確認しました。承認します。
   ```
7. 「承認する」ボタンをクリック
8. ステータスが「承認済み」（緑色）に変わることを確認
9. 承認履歴セクションに承認情報が追加されることを確認
10. 「編集」ボタンが表示されなくなることを確認
11. 「承認」「却下」ボタンが表示されなくなることを確認

**期待結果:**
- ✅ 管理者でログイン成功
- ✅ 承認コメント入力モーダル表示
- ✅ ステータスが「承認済み」に変更
- ✅ 承認履歴に承認情報追加
- ✅ 編集・承認ボタン非表示

---

## PDF出力テスト

### PDF-1. 基本情報の出力

**テスト手順:**

1. 承認済みの報告書の詳細ページに移動
2. 「PDF出力」ボタンをクリック
3. PDFファイルがダウンロードされることを確認
4. PDFを開いて以下の情報が表示されていることを確認:
   - タイトル: 作業報告書
   - 報告日: 2025年12月6日
   - 現場名: 新宿オフィスビル建設現場
   - 天気: ☀️ 晴れ
   - 作業場所: 3階 東側エリア
   - 進捗率: 60%
   - 作業員情報（名前・作業時間）
   - 作業内容
   - 使用資材

**期待結果:**
- ✅ PDFダウンロード成功
- ✅ すべての基本情報が正しく表示
- ✅ 日本語が正しく表示される

---

### PDF-2. カスタムフィールドの出力

**テスト手順:**

1. PDFで「業種固有項目」セクションを確認
2. 以下が表示されていることを確認:
   - 気温: 18
   - 安全確認: ヘルメット着用, 安全帯確認, 立入禁止区域設定

**期待結果:**
- ✅ カスタムフィールドがPDFに含まれる
- ✅ 値が正しく表示される

---

### PDF-3. 写真の出力

**テスト手順:**

1. PDFで「作業写真」セクションを確認
2. アップロードした写真が2列で表示されていることを確認
3. 各写真の下にキャプションが表示されていることを確認
4. 画像が適切なサイズで表示されていることを確認

**期待結果:**
- ✅ 写真が2列グリッドで表示
- ✅ キャプション表示
- ✅ 画像が読み込まれている

---

### PDF-4. 承認情報の出力

**テスト手順:**

1. PDFで「承認情報」セクションを確認
2. 以下が表示されていることを確認:
   - 承認者: 管理者太郎
   - 承認日時
   - 承認コメント

**期待結果:**
- ✅ 承認情報が表示
- ✅ 承認者名・日時・コメントが正しい

---

## チェックリスト

### Phase 1: 基本機能
- [ ] ログイン
- [ ] 作業報告書一覧表示
- [ ] 新規作成（基本項目）
- [ ] 詳細表示
- [ ] 編集
- [ ] 削除
- [ ] 一覧での表示確認

### Phase 2: カスタムフィールド
- [ ] カスタムフィールド表示（編集画面）
- [ ] カスタムフィールド入力
- [ ] カスタムフィールド表示（詳細画面）

### Phase 3: 写真・添付ファイル
- [ ] 写真アップロード
- [ ] 写真編集（キャプション）
- [ ] 写真削除
- [ ] 添付ファイルアップロード
- [ ] 添付ファイルダウンロード
- [ ] 添付ファイル削除

### Phase 4: 承認フロー
- [ ] 作業報告書の提出（一般ユーザー）
- [ ] 承認権限確認（マネージャー）
- [ ] 作業報告書の却下
- [ ] 却下された報告書の再編集
- [ ] 作業報告書の承認（管理者）
- [ ] ステータス変化の確認

### PDF出力
- [ ] 基本情報の出力
- [ ] カスタムフィールドの出力
- [ ] 写真の出力
- [ ] 承認情報の出力

---

## 🐛 トラブルシューティング

### 問題: ログインできない

**解決策:**
```bash
# データベースをリセット
npx supabase db reset

# テストデータを再作成
npx tsx scripts/create-test-data-work-reports.ts
```

---

### 問題: 写真アップロードが失敗する

**確認事項:**
1. Supabase Storageが起動しているか確認
   ```bash
   npx supabase status
   ```
2. ファイルサイズが5MB以下か確認
3. ファイル形式がJPG/PNGか確認

---

### 問題: PDFに写真が表示されない

**確認事項:**
1. ブラウザのコンソールにエラーがないか確認
2. Supabase Storageから写真がダウンロードできるか確認

---

## ✅ 完了

すべてのテストが完了したら、以下を確認してください:

1. すべてのチェックリスト項目が✅になっている
2. 各Phase（1-4）の機能が正しく動作している
3. PDF出力が正常に動作している
4. 承認フローが正しく動作している（下書き → 提出 → 却下 → 再提出 → 承認）

---

**テスト実施日**: ___________
**テスト実施者**: ___________
**結果**: ✅ 合格 / ❌ 不合格
**備考**: ___________
