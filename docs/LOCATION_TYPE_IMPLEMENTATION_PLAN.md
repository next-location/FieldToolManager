# 自社拠点（支店・倉庫）管理機能 実装計画書

## 📋 概要

現在「倉庫」として一括管理されている保管場所を、複数の自社拠点（本社倉庫、支店、資材置き場など）として管理できるようにする。

**作成日:** 2026-01-18
**ステータス:** 計画中

---

## 🎯 目的

### 現状の課題
1. **倉庫が単一**: すべての資材が「倉庫」として一括管理され、本社・支店の区別ができない
2. **自社間移動が記録できない**: 本社→支店、支店A→支店Bなどの移動が管理できない
3. **初期保管場所が選択できない**: 道具・重機登録時に保管場所を指定できない
4. **実態との乖離**: 複数拠点を持つ企業の実運用に対応していない

### 解決策
`sites`テーブルに`type`カラムを追加し、顧客現場と自社拠点を区別できるようにする。

---

## 🗂️ 現状分析

### データベース構造

#### sitesテーブル（現状）
```sql
CREATE TABLE sites (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL,
    name TEXT NOT NULL,
    address TEXT,
    manager_id UUID,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    client_id UUID,
    qr_code UUID,
    UNIQUE(organization_id, name)
);
```

**現在の用途:** 顧客の工事現場のみ

#### 現在地管理の方法

| リソース | 現在地の保持方法 | 問題点 |
|---------|---------------|--------|
| 道具（tool_items） | `current_location: 'warehouse' \| 'site'`（文字列） | 倉庫が単一、拠点別管理不可 |
| 消耗品移動 | `from/to_location_type: 'warehouse' \| 'site'`（文字列） | 同上 |
| 重機 | `current_location_id: UUID \| null`（null=倉庫） | 倉庫が暗黙的、明示的な選択不可 |

### 影響を受けるコード

- **ファイル数:**
  - `warehouse`を含むファイル: 43ファイル
  - `current_location`を含むファイル: 26ファイル
  - `sites`を参照するファイル: 多数

- **主要な影響箇所:**
  - 道具・消耗品・重機の登録フォーム
  - 移動フォーム（道具・消耗品・重機）
  - 移動履歴の表示
  - ダッシュボードの在庫表示
  - 現場管理UI

---

## 🏗️ 設計

### データベース設計（Option 2: sitesテーブル拡張）

#### typeカラムの追加

```sql
ALTER TABLE sites ADD COLUMN type TEXT NOT NULL DEFAULT 'customer_site'
  CHECK (type IN ('customer_site', 'own_warehouse', 'branch', 'storage_yard', 'other'));

-- is_own_locationカラム（検索・フィルタリング用）
ALTER TABLE sites ADD COLUMN is_own_location BOOLEAN GENERATED ALWAYS AS
  (type IN ('own_warehouse', 'branch', 'storage_yard', 'other')) STORED;
```

#### type の値と意味

| type | 日本語名 | 説明 | 例 |
|------|---------|------|---|
| `customer_site` | 顧客現場 | 顧客の工事現場（既存データ） | 〇〇ビル建設工事 |
| `own_warehouse` | 自社倉庫 | 自社の倉庫・保管場所 | 本社倉庫、支店A倉庫 |
| `branch` | 支店 | 自社の支店・営業所 | 大阪支店、福岡営業所 |
| `storage_yard` | 資材置き場 | 屋外の資材保管場所 | 〇〇資材置き場 |
| `other` | その他 | その他の自社拠点 | 協力会社倉庫 |

### UI設計

#### 1. 拠点管理ページ（新規作成）

**パス:** `/settings/locations` または `/organization/locations`

**機能:**
- 自社拠点の一覧表示（type別にフィルター可能）
- 新規拠点登録（typeを選択）
- 拠点情報の編集
- 拠点の削除（論理削除）

**権限:** 管理者（admin）のみ

**表示項目:**
- 拠点名
- 種別（倉庫/支店/資材置き場/その他）
- 住所
- 責任者
- ステータス（有効/無効）

#### 2. 既存UI改修

##### 道具登録フォーム
- **変更点:** 初期保管場所の選択肢を追加
- **デフォルト値:** 最初に登録された自社倉庫（`own_warehouse`）
- **選択肢:** 自社拠点のみ（`is_own_location = true`）

##### 重機登録フォーム
- **変更点:** 現在地選択を2段階に分離
  - ステップ1: 場所の種類（自社拠点/顧客現場/未設定）
  - ステップ2: 具体的な場所を選択
- **表示:** 自社拠点と顧客現場を別々のセクションで表示

##### 移動フォーム（道具・重機）
- **変更点:** 移動元・移動先の選択肢を整理
  - 自社拠点セクション
  - 顧客現場セクション
  - その他の場所（重機のみ）

##### 移動履歴
- **変更点:** 場所の表示に種別アイコンを追加
  - 🏢 自社倉庫
  - 🏪 支店
  - 📦 資材置き場
  - 🏗️ 顧客現場

---

## 📅 実装計画

### Phase 1: データベース準備（必須）⚠️

**優先度:** 🔴 最高
**工数見積もり:** 2-3時間
**影響範囲:** データベースのみ

#### タスク

1. ✅ **マイグレーションSQL作成**
   - `sites`テーブルに`type`カラム追加
   - `is_own_location`カラム追加（GENERATED ALWAYS AS）
   - CHECK制約の追加
   - 既存データを`customer_site`に設定

2. ✅ **マイグレーション実行**
   - ローカル環境でテスト
   - 本番環境で実行
   - ロールバック手順の確認

3. ✅ **検証**
   - 既存データの確認（すべて`customer_site`になっているか）
   - 制約が正しく動作するか確認
   - RLSポリシーが引き続き機能するか確認

**リスク対策:**
- ✅ 既存データは`DEFAULT 'customer_site'`で自動設定
- ✅ 既存機能に影響なし（読み取り互換性を維持）
- ✅ ロールバックSQL準備

**ロールバックSQL:**
```sql
ALTER TABLE sites DROP COLUMN IF EXISTS is_own_location;
ALTER TABLE sites DROP COLUMN IF EXISTS type;
```

---

### Phase 2: 拠点管理UI作成（管理者専用）

**優先度:** 🔴 高
**工数見積もり:** 4-6時間
**影響範囲:** 新規ページのみ

#### タスク

1. ⏳ **拠点管理ページ作成**
   - `/app/(authenticated)/settings/locations/page.tsx`
   - 自社拠点の一覧表示（`is_own_location = true`）
   - typeごとのフィルター機能

2. ⏳ **拠点登録フォーム**
   - `/app/(authenticated)/settings/locations/new/page.tsx`
   - type選択（ラジオボタンまたはセレクトボックス）
   - 名前、住所、責任者の入力
   - バリデーション

3. ⏳ **拠点編集フォーム**
   - `/app/(authenticated)/settings/locations/[id]/edit/page.tsx`
   - 既存データの編集
   - typeの変更は慎重に（変更時に警告表示）

4. ⏳ **Server Actions作成**
   - `/app/(authenticated)/settings/locations/actions.ts`
   - createLocation, updateLocation, deleteLocation

**リスク対策:**
- ✅ 管理者権限チェック（requireAuth + role check）
- ✅ 顧客現場（`customer_site`）の編集は別ページ（`/sites`）に誘導
- ✅ 削除時に関連する道具・重機の有無を確認

---

### Phase 3: 重機関連の改修（最優先）

**優先度:** 🔴 高
**工数見積もり:** 3-4時間
**影響範囲:** 重機登録・移動フォーム、移動履歴

#### タスク

1. ⏳ **重機登録フォーム改修**
   - `current_location_id`選択を改善
   - 自社拠点と顧客現場を分けて表示
   - デフォルト値: 本社倉庫（最初の`own_warehouse`）

2. ⏳ **重機移動フォーム改修**
   - 持出先/返却先/移動先の選択肢を整理
   - 自社拠点セクションと顧客現場セクションに分離
   - 「その他の場所」は継続サポート

3. ⏳ **重機移動履歴表示改修**
   - 移動元・移動先にtypeに応じたアイコン表示
   - 拠点名の横に種別を表示

**リスク対策:**
- ✅ 既存の`current_location_id = null`のロジックを維持
- ✅ 「その他の場所」機能は継続サポート
- ✅ 後方互換性の確保

---

### Phase 4: 道具関連の改修

**優先度:** 🟡 中
**工数見積もり:** 3-4時間
**影響範囲:** 道具登録フォーム、移動ロジック

#### タスク

1. ⏳ **道具登録フォーム改修**
   - `current_location`を`site_id`に変更（将来的に）
   - 初期保管場所の選択肢追加（自社拠点のみ）
   - デフォルト: 本社倉庫

2. ⏳ **tool_items テーブル改修（段階的）**
   - `current_location_site_id`カラム追加（自社拠点用）
   - 既存の`current_location`は当面維持
   - マイグレーション: `'warehouse'` → デフォルト倉庫のID

3. ⏳ **道具移動フォーム改修**
   - 移動元・移動先を拠点IDベースに変更
   - UIは重機と同様に改修

**リスク対策:**
- ✅ 段階的な移行（既存の`current_location`文字列は当面維持）
- ✅ データマイグレーションは慎重に実施
- ✅ 既存の移動履歴との互換性確保

---

### Phase 5: 消耗品関連の改修（段階的）

**優先度:** 🟢 低
**工数見積もり:** 5-8時間
**影響範囲:** 消耗品移動、在庫管理

#### タスク

1. ⏳ **consumable_movements改修**
   - `from_location_type`, `to_location_type`を非推奨化
   - `from_location_id`, `to_location_id`カラム追加
   - sitesテーブルへのFK設定

2. ⏳ **拠点別在庫管理（将来機能）**
   - 拠点ごとの在庫数を管理
   - ダッシュボードで拠点別在庫を表示

**リスク対策:**
- ✅ 大規模な改修のため、段階的に実施
- ✅ 既存の文字列ベースのロジックは当面維持
- ✅ 新旧両方のデータ構造をサポート

---

### Phase 6: 移動履歴・ダッシュボード改善

**優先度:** 🟢 低
**工数見積もり:** 2-3時間
**影響範囲:** 表示のみ

#### タスク

1. ⏳ **移動履歴にアイコン追加**
   - typeに応じたアイコン表示
   - 🏢 自社倉庫、🏪 支店、📦 資材置き場、🏗️ 顧客現場

2. ⏳ **ダッシュボード改善**
   - 拠点別在庫数の表示（Phase 5と連動）

**リスク対策:**
- ✅ 表示のみの変更なので影響は限定的

---

## ⚠️ リスクと対策

### 1. データ整合性リスク

**リスク:**
- 既存の移動履歴（`'warehouse'`文字列）との互換性
- マイグレーション時のデータ不整合

**対策:**
- ✅ 既存データは触らず、新規データのみ新形式を使用
- ✅ 表示ロジックで新旧両方に対応
- ✅ マイグレーション前にバックアップ必須

### 2. UX複雑化リスク

**リスク:**
- 選択肢が増えることで操作が複雑化
- ユーザーが混乱する可能性

**対策:**
- ✅ 自社拠点と顧客現場を視覚的に分離
- ✅ デフォルト値を適切に設定
- ✅ ヘルプテキストを充実させる

### 3. パフォーマンスリスク

**リスク:**
- sitesテーブルへのクエリ増加
- インデックスの最適化が必要

**対策:**
- ✅ `type`カラムにインデックス追加
- ✅ `is_own_location`カラムでフィルタリング最適化
- ✅ クエリのN+1問題を回避

---

## 🔍 テスト計画

### 単体テスト
- [ ] マイグレーションのロールバック確認
- [ ] 拠点CRUD機能の動作確認
- [ ] 既存の顧客現場機能が正常動作するか

### 統合テスト
- [ ] 道具・重機の登録 → 移動 → 履歴表示のフロー
- [ ] 自社拠点間の移動
- [ ] 顧客現場との移動
- [ ] 既存データとの互換性

### ユーザー受け入れテスト
- [ ] 管理者による拠点登録
- [ ] スタッフによる道具・重機移動
- [ ] 移動履歴の確認

---

## 📊 進捗管理

### 実装状況

| Phase | タスク | ステータス | 担当者 | 完了予定日 |
|-------|--------|-----------|--------|-----------|
| Phase 1 | マイグレーションSQL作成 | ⏳ 未着手 | - | - |
| Phase 1 | マイグレーション実行 | ⏳ 未着手 | - | - |
| Phase 1 | 検証 | ⏳ 未着手 | - | - |
| Phase 2 | 拠点管理UI作成 | ⏳ 未着手 | - | - |
| Phase 3 | 重機関連改修 | ⏳ 未着手 | - | - |
| Phase 4 | 道具関連改修 | ⏳ 未着手 | - | - |
| Phase 5 | 消耗品関連改修 | ⏳ 未着手 | - | - |
| Phase 6 | 表示改善 | ⏳ 未着手 | - | - |

### マイルストーン

- [ ] **M1: データベース準備完了**（Phase 1完了）
- [ ] **M2: 基本機能リリース**（Phase 1-3完了）
- [ ] **M3: 全機能対応完了**（Phase 1-6完了）

---

## 📝 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2026-01-18 | 初版作成 | Claude |

---

## 📚 関連ドキュメント

- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md) - データベーススキーマ
- [MIGRATIONS.md](./MIGRATIONS.md) - マイグレーション履歴
- [CHANGELOG.md](../CHANGELOG.md) - 変更履歴

---

## ✅ 次のステップ

1. **Phase 1のマイグレーションSQL作成**
2. ローカル環境でテスト
3. 本番環境でマイグレーション実行
4. Phase 2の拠点管理UI作成に着手

**⚠️ 重要:** 各Phaseの完了後、既存機能が正常に動作することを必ず確認してから次に進む。
