# ザイロク (Zairoku) 段階的成長型環境プラン

**作成日**: 2025-12-22
**最終更新**: 2025-12-22
**ステータス**: Phase 1 実施中

---

## 📊 現状分析

### 現在の環境構成

| 環境 | 状態 | 詳細 |
|------|------|------|
| **ローカル開発** | ✅ 稼働中 | Docker Compose, Supabase Local |
| **本番環境** | ⚠️ 部分稼働 | Supabase Free (ecehilhaxgwphvamvabj), Vercel Pro |
| **テスト環境** | ❌ 未構築 | - |
| **ステージング** | ❌ 未構築 | - |

### 主要な問題点

1. **スキーマ不一致** 🔴 緊急
   - ローカル：115個のマイグレーション適用済み
   - 本番：基本テーブル（3ステップ）のみ
   - 差分：約110個のマイグレーション未適用
   - **影響：新機能が本番で動作しない**

2. **デプロイプロセス** 🟡 重要
   - ローカル → 本番の直接デプロイ（危険）
   - テスト環境なし
   - ロールバック手順なし

3. **環境変数管理** 🟡 重要
   - `.env.local`と`.env.production`のみ
   - テスト環境用の設定なし

---

## 🚀 段階的成長型プラン

### Phase 1: 基盤整備（現在〜2025年1月）
**目標**: テスト環境構築とスキーマ同期
**予算**: 0円追加

#### 1.1 テスト環境構築

**Supabase テスト環境**
- プロジェクト名：`zairoku-test`
- リージョン：Northeast Asia (Tokyo)
- プラン：Free Tier（無料）
- 用途：本番デプロイ前の最終確認

**Vercel テスト環境**
- ブランチ：`test`
- ドメイン：`test.zairoku.com`（サブドメイン）
- デプロイ：自動（testブランチプッシュ時）

**環境変数**
- ファイル：`.env.test`
- Vercel環境：`Preview`として設定

#### 1.2 マイグレーション同期プロセス

```mermaid
graph LR
    A[ローカル開発] --> B[テスト環境]
    B --> C[動作確認]
    C --> D[本番環境]

    style A fill:#f9f,stroke:#333,stroke-width:4px
    style D fill:#9f9,stroke:#333,stroke-width:4px
```

**手順**:
1. ローカルでマイグレーション作成・テスト
2. テスト環境に適用（全115マイグレーション）
3. 機能テスト実施（1-2日）
4. 本番環境に適用

#### 1.3 緊急対応：本番スキーマ更新

**実施タイミング**: テスト環境構築完了後即座

**方法**:
```bash
# 1. テスト環境で全マイグレーション適用
./scripts/migrate-test.sh

# 2. 動作確認
# - 基本機能テスト
# - RLSポリシー確認
# - データ投入テスト

# 3. 本番環境に適用
./scripts/migrate-production-safe.sh
```

---

### Phase 2: 初期運用（2025年1月〜3月）
**目標**: 顧客10社まで対応
**予算**: 0円追加（Supabase Free継続可能）

#### 2.1 環境構成

| 環境 | Supabase | Vercel | ドメイン | 用途 |
|------|----------|--------|----------|------|
| ローカル | Docker | - | localhost:3000 | 開発 |
| テスト | Free | Preview | test.zairoku.com | 最終確認 |
| 本番 | Free → Pro* | Pro | zairoku.com | 顧客利用 |

*データベース500MB超過時にPro移行

#### 2.2 デプロイフロー

```yaml
# .github/workflows/deploy.yml
1. mainブランチマージ時
   - ビルドテスト
   - TypeScriptチェック
   - ESLintチェック

2. testブランチマージ時
   - テスト環境自動デプロイ
   - Slack通知

3. 本番デプロイ
   - 手動承認必須
   - タグ付けリリース
```

---

### Phase 3: 成長期（2025年4月〜9月）
**目標**: 顧客10-30社
**予算**: 月額3,750円追加

#### 3.1 Supabase Pro移行

**移行トリガー**:
- データベースサイズ 500MB超過
- 同時接続数増加
- バックアップ要件

**Pro特典**:
- データベース 8GB
- 自動バックアップ（7日間）
- 優先サポート

#### 3.2 開発環境追加（オプション）

チーム開発開始時に検討：
- Supabase開発環境：`zairoku-dev`
- 複数開発者の並行作業対応

---

### Phase 4: 拡大期（2025年10月〜）
**目標**: 顧客30社以上
**予算**: 要検討（チーム規模による）

#### 4.1 フル環境構成

```
開発 → テスト → ステージング → 本番
Dev    Test     Staging       Production
```

#### 4.2 エンタープライズ機能

- マルチリージョン対応
- 専用インスタンス
- SLA保証

---

## 📝 実装タスクリスト

### 即座に実施（Phase 1.1）

- [ ] Supabaseテスト環境プロジェクト作成
- [ ] テスト環境用環境変数設定
- [ ] Vercelテスト環境設定
- [ ] test.zairoku.comサブドメイン設定
- [ ] マイグレーション適用スクリプト作成

### 1週間以内（Phase 1.2）

- [ ] テスト環境への全マイグレーション適用
- [ ] 機能テスト実施
- [ ] 本番環境スキーマ更新
- [ ] デプロイ手順書作成

### 1ヶ月以内（Phase 1.3）

- [ ] CI/CD基本設定
- [ ] 自動テスト整備
- [ ] 開発マニュアル作成
- [ ] バックアップ手順確立

---

## 🔧 技術仕様

### テスト環境ドメイン設定

**推奨構成**:
```
本番: zairoku.com
テスト: test.zairoku.com
ステージング（将来）: staging.zairoku.com
開発（将来）: dev.zairoku.com
```

**DNS設定（お名前.com）**:
```
# テスト環境用
Type: CNAME
Name: test
Value: cname.vercel-dns.com
```

### 環境変数管理

```bash
# ファイル構成
.env.local          # ローカル開発
.env.test           # テスト環境
.env.staging        # ステージング（将来）
.env.production     # 本番環境

# Vercel環境変数
- Production: 本番用
- Preview: テスト・ステージング用
- Development: 開発用
```

### マイグレーション管理

**ディレクトリ構成**:
```
supabase/
├── migrations/          # マイグレーションファイル
├── seeds/              # テストデータ
└── functions/          # Edge Functions

scripts/
├── migrate-local.sh    # ローカル適用
├── migrate-test.sh     # テスト適用
├── migrate-staging.sh  # ステージング適用（将来）
└── migrate-production.sh # 本番適用
```

---

## 📊 コスト試算

### Phase 1（現在）
| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase（本番・テスト） | 0円 | 0円 |
| Vercel Pro | 3,260円 | 39,120円 |
| **合計** | **3,260円** | **39,120円** |

### Phase 2（顧客10社時）
| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase Pro（本番） | 3,750円 | 45,000円 |
| Supabase Free（テスト） | 0円 | 0円 |
| Vercel Pro | 3,260円 | 39,120円 |
| **合計** | **7,010円** | **84,120円** |

### Phase 3（顧客30社時）
| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase Pro × 2 | 7,500円 | 90,000円 |
| Vercel Pro | 3,260円 | 39,120円 |
| **合計** | **10,760円** | **129,120円** |

---

## 🚨 リスク管理

### リスク項目と対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| マイグレーション失敗 | 高 | テスト環境で事前検証、ロールバックスクリプト準備 |
| データ損失 | 高 | 定期バックアップ、本番適用前のスナップショット |
| 環境間の設定ミス | 中 | 環境変数チェックリスト、自動化 |
| スケーリング遅延 | 低 | 使用量モニタリング、早期アップグレード |

---

## 📅 実施スケジュール

### 2024年12月（現在）
- [x] 現状分析完了
- [ ] テスト環境構築開始
- [ ] マイグレーション同期計画

### 2025年1月
- [ ] テスト環境完成
- [ ] 本番スキーマ更新
- [ ] 初期顧客受け入れ準備

### 2025年2月
- [ ] CI/CD整備
- [ ] 開発マニュアル完成
- [ ] 顧客オンボーディング開始

### 2025年3月
- [ ] Phase 2評価
- [ ] Supabase Pro移行判断
- [ ] チーム拡大検討

---

## 📞 サポート・連絡先

### 技術サポート
- Supabase: https://supabase.com/support
- Vercel: https://vercel.com/support

### ドキュメント参照
- [PRODUCTION_MIGRATION_PLAN.md](./PRODUCTION_MIGRATION_PLAN.md)
- [PRODUCTION_MIGRATION_LOG.md](./PRODUCTION_MIGRATION_LOG.md)
- [DATABASE_SCHEMA.md](./DATABASE_SCHEMA.md)

---

**最終更新日**: 2025-12-22
**次回レビュー**: 2025-01-01