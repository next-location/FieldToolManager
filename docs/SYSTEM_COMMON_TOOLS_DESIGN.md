# システム共通道具マスタ設計書

## 概要

スーパー管理者（システム管理者）が全組織共通で使用できる道具マスタを一元管理し、各組織がそれを参照できる仕組みを実装する。

## 設計方針：参照方式

### 基本コンセプト

- `tools`テーブルに`is_system_common: boolean`カラムを追加
- `organization_id = NULL` かつ `is_system_common = true` の道具 = システム共通道具
- 各組織は以下の両方を参照可能：
  1. システム共通道具（全組織で共有）
  2. 組織独自の道具（`organization_id`が自組織のもの）

### メリット

1. **データの一元管理**: 共通道具の更新が全組織に即座に反映
2. **ストレージ効率**: 重複データなし
3. **メンテナンス性**: スーパー管理者が一箇所で管理
4. **柔軟性**: 各組織は独自の道具も追加可能

## データベース設計

### 1. toolsテーブルの拡張

```sql
-- 新規カラム追加
ALTER TABLE tools
ADD COLUMN is_system_common BOOLEAN DEFAULT false;

-- インデックス追加
CREATE INDEX idx_tools_is_system_common ON tools(is_system_common) WHERE is_system_common = true;

-- organization_idをNULL許可に変更（共通道具用）
ALTER TABLE tools
ALTER COLUMN organization_id DROP NOT NULL;

-- 制約追加：共通道具の場合organization_idはNULL必須
ALTER TABLE tools
ADD CONSTRAINT tools_system_common_check
CHECK (
  (is_system_common = false AND organization_id IS NOT NULL) OR
  (is_system_common = true AND organization_id IS NULL)
);

-- コメント追加
COMMENT ON COLUMN tools.is_system_common IS 'システム共通道具フラグ（true=全組織共通、false=組織固有）';
```

### 2. RLSポリシーの更新

```sql
-- 既存のSELECTポリシーを更新（共通道具も閲覧可能に）
DROP POLICY IF EXISTS "Users can view organization tools" ON tools;

CREATE POLICY "Users can view tools" ON tools
FOR SELECT
USING (
  (deleted_at IS NULL) AND (
    -- 自組織の道具
    (organization_id = get_organization_id()) OR
    -- システム共通道具
    (is_system_common = true AND organization_id IS NULL)
  )
);

-- INSERTポリシー：一般ユーザーは組織固有道具のみ作成可能
CREATE POLICY "Users can insert organization tools" ON tools
FOR INSERT
WITH CHECK (
  organization_id = get_organization_id() AND
  is_system_common = false
);

-- UPDATEポリシー：一般ユーザーは自組織の道具のみ更新可能
CREATE POLICY "Users can update organization tools" ON tools
FOR UPDATE
USING (
  organization_id = get_organization_id() AND
  is_system_common = false
);

-- スーパー管理者用ポリシー（Service Role Keyで実行）
-- システム共通道具の作成・更新・削除はサービスロールキー経由のみ
```

### 3. データの整合性

**共通道具の特性:**
- `organization_id`: NULL
- `is_system_common`: true
- `qr_code`: 生成するが、実際のQRコード印刷は各組織が個別アイテム作成時に行う
- `quantity`, `current_location`, `status`: デフォルト値（参考値）
- `management_type`: 'individual' または 'consumable'

## 機能仕様

### A. スーパー管理者側（システム管理画面）

#### A-1. 共通道具一覧ページ

**URL**: `/admin/tools/common`

**機能**:
- システム共通道具の一覧表示
- 検索・フィルタリング（カテゴリ、管理タイプ）
- ソート機能
- 新規登録ボタン
- 編集・削除ボタン

**表示項目**:
- 道具名
- カテゴリ
- 型番
- メーカー
- 管理タイプ（個別管理/消耗品）
- 登録日
- 更新日

#### A-2. 共通道具登録・編集ページ

**URL**:
- 新規: `/admin/tools/common/new`
- 編集: `/admin/tools/common/[id]/edit`

**入力項目**:
- 道具名 *（必須）
- カテゴリ（tool_categoriesから選択）
- 型番
- メーカー
- 管理タイプ *（必須）: 個別管理 / 消耗品
- 単位（消耗品の場合）
- 標準購入価格（参考値）
- 画像URL
- 備考

**制約**:
- QRコードは自動生成（UUID）
- `organization_id`は常にNULL
- `is_system_common`は常にtrue

#### A-3. API設計

**GET /api/admin/tools/common**
- システム共通道具一覧取得
- クエリパラメータ: `search`, `category_id`, `management_type`

**POST /api/admin/tools/common**
- システム共通道具作成
- 認証: スーパー管理者のみ

**GET /api/admin/tools/common/[id]**
- 特定の共通道具取得

**PUT /api/admin/tools/common/[id]**
- システム共通道具更新
- 認証: スーパー管理者のみ

**DELETE /api/admin/tools/common/[id]**
- システム共通道具削除（論理削除）
- 認証: スーパー管理者のみ

### B. 各組織側（通常の管理画面）

#### B-1. 道具一覧ページの変更

**URL**: `/tools` (既存ページ)

**変更点**:
- システム共通道具も一覧に表示
- 共通道具には視覚的なバッジ表示（例: 🌐 共通道具）
- フィルタリングオプション追加: 「すべて」「組織独自」「共通道具」
- 共通道具は編集・削除不可（閲覧のみ）

#### B-2. 道具詳細ページの変更

**URL**: `/tools/[id]` (既存ページ)

**変更点**:
- 共通道具の場合:
  - 「システム共通道具」バッジ表示
  - 編集・削除ボタン非表示
  - 「この道具から個別アイテムを作成」ボタン表示
- 組織独自道具の場合:
  - 従来通り編集・削除可能

#### B-3. 個別アイテムの作成

**共通道具から個別アイテム作成時の動作**:

1. ユーザーが共通道具を選択
2. 「個別アイテムを作成」をクリック
3. 新しい`tool_items`レコードを作成:
   - `tool_id`: 共通道具のID（参照）
   - `serial_number`: 組織独自のシリアル番号
   - `qr_code`: 新規UUID生成
   - `organization_id`: 自組織ID

**データ構造**:
```
tools (共通道具マスタ)
  ├─ tool_items (A社の個別アイテム)
  ├─ tool_items (B社の個別アイテム)
  └─ tool_items (C社の個別アイテム)
```

## UI/UX設計

### スーパー管理者画面

#### 1. サイドメニュー追加

```
組織管理
契約管理
営業管理
━━━━━━━━━━
マスタ管理
  └ 共通道具マスタ  ← NEW
```

#### 2. 共通道具一覧画面

```
┌──────────────────────────────────────────────┐
│ システム共通道具マスタ              [+ 新規登録] │
├──────────────────────────────────────────────┤
│ [検索...] [カテゴリ▼] [管理タイプ▼]          │
├──────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐   │
│ │ 🔧 電動ドライバー                       │   │
│ │ カテゴリ: 電動工具 | 型番: XYZ-100      │   │
│ │ 管理: 個別管理 | 登録: 2025-12-01      │   │
│ │                          [編集] [削除]  │   │
│ └────────────────────────────────────────┘   │
│ ┌────────────────────────────────────────┐   │
│ │ 🔨 ハンマー                             │   │
│ │ カテゴリ: 手工具 | 型番: -             │   │
│ │ 管理: 個別管理 | 登録: 2025-12-01      │   │
│ │                          [編集] [削除]  │   │
│ └────────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

#### 3. 共通道具登録画面

```
┌──────────────────────────────────────────────┐
│ 共通道具マスタ登録                           │
├──────────────────────────────────────────────┤
│ 道具名 *                                     │
│ [_________________________________]          │
│                                              │
│ カテゴリ                                     │
│ [電動工具 ▼]                                │
│                                              │
│ 型番                                         │
│ [_________________________________]          │
│                                              │
│ メーカー                                     │
│ [_________________________________]          │
│                                              │
│ 管理タイプ *                                 │
│ ( ) 個別管理  ( ) 消耗品                    │
│                                              │
│ 標準購入価格（参考値）                       │
│ [_________________________________] 円       │
│                                              │
│ 備考                                         │
│ [_________________________________]          │
│ [_________________________________]          │
│                                              │
│          [キャンセル]  [登録]               │
└──────────────────────────────────────────────┘
```

### 各組織画面

#### 1. 道具一覧の表示

```
┌──────────────────────────────────────────────┐
│ 道具一覧                        [+ 新規登録]  │
├──────────────────────────────────────────────┤
│ [検索...] [種類: すべて ▼] [カテゴリ▼]      │
│          ├ すべて                            │
│          ├ 組織独自                          │
│          └ 共通道具                          │
├──────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐   │
│ │ 🌐 電動ドライバー                       │   │
│ │ システム共通道具                        │   │
│ │ 在庫: 3個 | 利用可能: 2個              │   │
│ │                          [詳細を見る]   │   │
│ └────────────────────────────────────────┘   │
│ ┌────────────────────────────────────────┐   │
│ │ 🔧 当社専用ドリル                       │   │
│ │ 在庫: 5個 | 利用可能: 4個              │   │
│ │                    [編集] [詳細を見る]  │   │
│ └────────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

## 実装フェーズ

### Phase 1: データベース準備
1. マイグレーション作成
2. RLSポリシー更新
3. 既存データの整合性確認

### Phase 2: スーパー管理者機能
1. 共通道具一覧ページ
2. 共通道具登録・編集ページ
3. API実装

### Phase 3: 各組織機能
1. 道具一覧の表示ロジック変更
2. 共通道具の視覚的識別
3. フィルタリング機能追加

### Phase 4: テスト・検証
1. 共通道具の作成・編集・削除
2. 各組織からの参照確認
3. RLSポリシーの動作確認
4. パフォーマンステスト

## セキュリティ考慮事項

1. **RLS厳格化**:
   - 一般ユーザーは共通道具を閲覧のみ
   - 共通道具の変更はService Role Keyのみ

2. **API認証**:
   - `/api/admin/tools/common/*` はスーパー管理者のみアクセス可能
   - JWT検証必須

3. **監査ログ**:
   - 共通道具の作成・更新・削除を`super_admin_logs`に記録

## 注意事項

1. **QRコード**: 共通道具のQRコードは参考用。実際の運用では各組織が`tool_items`を作成して個別QRコードを発行
2. **カスタムフィールド**: 共通道具でも使用可能だが、各組織で追加情報が必要な場合は独自道具として複製推奨
3. **削除**: 共通道具の削除は慎重に（各組織が参照している可能性）

## 今後の拡張案

1. **カテゴリマスタの共通化**: `tool_categories`も共通化
2. **インポート機能**: CSV一括登録
3. **テンプレート機能**: 共通道具から組織独自道具への変換
4. **利用統計**: どの共通道具が各組織で多く使われているか分析
