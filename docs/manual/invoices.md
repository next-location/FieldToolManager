# 請求書管理

## 概要

請求書機能は、顧客への請求書を作成・管理するための機能です。
承認フロー、顧客送付、入金管理まで、請求書のライフサイクル全体を管理できます。

**主な機能**:
- 請求書の作成・編集（リーダー以上）
- 承認ワークフロー（マネージャー以上が承認）
- 顧客への送付管理
- 入金記録・管理（一部入金・全額入金）
- 承認済み見積書からの請求書作成
- 操作履歴の記録
- PDF出力

---

## 対象者

### 作成・編集
- **リーダー（Leader）**: 自分が作成した請求書のみ作成・編集
- **マネージャー（Manager）**: 全ての請求書を作成・編集
- **管理者（Admin）**: 全ての請求書を作成・編集

### 承認
- **マネージャー（Manager）以上**: 提出済み請求書を承認・差し戻しできる

### 顧客送付
- **マネージャー（Manager）以上**: 承認済み請求書を顧客に送付できる

### 入金登録
- **リーダー（Leader）以上**: 入金を記録できる

**注意**: スタッフ（Staff）は請求書機能を利用できません。

---

## 前提条件

請求書を作成する前に、以下のマスタデータが登録されている必要があります。

1. **取引先マスタ**: 請求先の取引先が登録されている
   - 取引先タイプが「顧客」または「両方」である必要があります
   - 支払期日（payment_due_days）が設定されていると、自動計算されます
2. **工事マスタ（任意）**: 請求書に紐づける工事を登録（省略可能）

---

## 請求書のステータス

請求書は以下のステータスで管理されます：

| ステータス | 説明 |
|-----------|------|
| **下書き** | 作成中、編集可能 |
| **提出済み** | 承認待ち（リーダーが提出した場合） |
| **承認済** | マネージャーが承認済み（顧客送付可能） |
| **送付済** | 顧客に送付済み、入金待ち |
| **入金済** | 全額入金完了（最終状態） |

### ステータスフロー

```
下書き → 提出済み → 承認済 → 送付済 → 入金済
```

**注意**:
- マネージャー以上が作成した場合、「提出済み」をスキップして即座に承認されます

---

## 請求書の作成

### 基本的な作成手順

1. サイドメニューから **請求書** をクリック
2. 右下の **+** ボタン（FAB）をクリック
3. 基本情報と明細を入力
4. **下書き** または **提出** をクリック

### 見積書から請求書を作成

顧客承認済みの見積書から、請求書を作成できます。

**手順**:
1. 見積書詳細画面を開く（ステータス「顧客承認」）
2. **請求書作成** ボタンをクリック
3. 請求書作成画面が開く
4. 見積書の内容（取引先、工事、件名、明細）が自動的に引き継がれる
5. 必要に応じて内容を編集
6. **下書き** または **提出** をクリック

### 入力項目の詳細

#### 基本情報

| 項目 | 必須 | 説明 |
|------|------|------|
| **請求書番号** | ○ | 自動生成（INV-年月-連番） |
| **取引先** | ○ | 請求先の取引先を選択 |
| **工事** | - | 紐づける工事を選択（任意） |
| **請求日** | ○ | 請求書の発行日 |
| **支払期日** | ○ | 支払期日（デフォルト30日後） |
| **件名** | ○ | 請求書の件名 |
| **適格請求書** | - | 適格請求書発行事業者の場合、チェックON |
| **登録番号** | - | 適格請求書の登録番号（組織設定から自動入力） |

**請求書番号の自動生成**:
- フォーマット: `INV-202501-0001`（年月-連番）
- 月ごとに連番がリセットされます

**支払期日の自動計算**:
- 取引先に支払期日（日数）が設定されている場合、請求日から自動計算されます
- 例: 支払期日30日 → 請求日の30日後

#### 明細

請求書には1つ以上の明細を追加する必要があります。

| 項目 | 必須 | 説明 |
|------|------|------|
| **種別** | ○ | 材料費/人件費/外注費/経費/その他 |
| **カスタム種別** | - | 種別が「その他」の場合に入力 |
| **項目名** | ○ | 明細の名称 |
| **説明** | - | 明細の詳細説明 |
| **数量** | ○ | 数量 |
| **単位** | ○ | 式/個/台/本/枚/m/m²/m³/kg/t/L/日/時間/人/その他 |
| **カスタム単位** | - | 単位が「その他」の場合に入力 |
| **単価** | ○ | 単価（税抜） |
| **税率** | ○ | 10%/8%/0% |
| **金額** | - | 自動計算（数量×単価） |

**明細の追加・削除**:
- **+ 明細を追加** ボタンで明細を追加
- 各明細の **削除** ボタンで削除（最低1つは必要）

**数値入力**:
- 全角数字を入力しても自動的に半角に変換されます

#### 備考

| 項目 | 説明 |
|------|------|
| **備考（お客様向け）** | 請求書に記載される備考 |
| **社内メモ** | 社内用のメモ（請求書には記載されません） |

---

## 下書き保存と提出

### 下書き保存

作成途中の請求書を保存する場合は **下書き** ボタンをクリックします。

**下書き状態の特徴**:
- いつでも編集・削除が可能
- 承認者には表示されない
- 一覧画面でステータス「下書き」として表示

### 提出（リーダーの場合）

リーダーが請求書を完成させて提出する場合は **提出** ボタンをクリックします。

**提出時の動作**:
- ステータスが「提出済み」に変更
- マネージャー以上に承認依頼の通知が届く
- 提出後は編集できません（差し戻された場合のみ再編集可能）

### 提出（マネージャー以上の場合）

マネージャー以上が請求書を作成する場合、**提出** ボタンをクリックすると即座に承認されます。

**提出時の動作**:
- ステータスが「承認済」に変更（承認プロセスをスキップ）
- 顧客送付ボタンが表示される

---

## 請求書の閲覧

### 一覧画面

請求書一覧では、以下の情報がカード形式で表示されます：

- ステータスバッジ
- 請求書番号
- 請求日・支払期日
- 取引先名・工事名
- 作成者（リーダーの場合）
- 承認者（マネージャー以上のみ表示）
- 金額
- 入金状況（未入金/一部入金/入金済）

**フィルタリング**:
- ステータスで絞り込み
- 入金状況で絞り込み（未入金/一部入金/入金済）
- キーワード検索（請求書番号、取引先名、工事名）

**ソート**:
- 請求日
- 支払期日
- 金額

### 詳細画面

請求書をクリックすると、詳細画面が開きます。

**表示内容**:
- ステータス表示（ステータスバッジ＋入金状況）
- 請求書本体（印刷可能なフォーマット）
- 宛先情報（取引先名）
- 発行者情報（組織名、住所、電話番号、登録番号）
- 請求書番号、請求日、支払期日
- 件名
- 明細一覧
- 合計金額（小計、消費税、合計）
- 備考
- 社内メモ（印刷時は非表示）
- 承認情報（承認済みの場合）
- 操作履歴

---

## 承認フロー

### リーダーが作成した場合

1. リーダーが請求書を作成
2. **提出** → ステータス「提出済み」
3. マネージャー以上が承認
4. ステータス「承認済」に変更（顧客送付ボタンが表示される）

### マネージャー以上が作成した場合

1. マネージャー以上が請求書を作成
2. **提出** → ステータス「承認済」（即座に承認）
3. 顧客送付ボタンが表示される

### 承認手順（マネージャー以上）

1. 請求書一覧から「提出済み」の請求書を開く
2. 内容を確認
3. 画面右上の **承認** ボタンをクリック
4. 必要に応じてメモを入力
5. **確定** をクリック

**承認後の動作**:
- ステータスが「承認済」に変更
- 作成者に承認完了の通知が届く
- 顧客送付ボタンが表示される

### 差し戻し手順（マネージャー以上）

承認せずに修正が必要な場合は、差し戻しができます。

1. 請求書一覧から「提出済み」の請求書を開く
2. 内容を確認
3. 画面右上の **差し戻し** ボタンをクリック
4. 差し戻し理由を入力（必須）
5. **確定** をクリック

**差し戻し後の動作**:
- ステータスが「下書き」に戻る
- 作成者に差し戻しの通知が届く
- 作成者は請求書を再編集して再提出できる

---

## 顧客送付

承認済みの請求書は、顧客に送付できます。

### 顧客送付手順（マネージャー以上）

1. 請求書詳細画面を開く
2. 画面右上の **顧客送付** ボタンをクリック
3. 送付先メールアドレスを確認（取引先の連絡先メールアドレスが自動入力）
4. 必要に応じて送付メッセージを入力
5. **送付** をクリック

**送付時の動作**:
- 顧客にメールが送信される（PDF添付）
- ステータスが「送付済」に変更
- 操作履歴に送付記録が追加される
- 入金登録ボタンが表示される

---

## 入金管理

### 入金登録

送付済みの請求書に対して、入金を記録できます。

**入金登録手順**:
1. 請求書詳細画面を開く（ステータス「送付済」）
2. 画面右上の **入金登録** ボタンをクリック
3. 入金情報を入力
   - 入金日
   - 入金額
   - 入金方法（銀行振込/現金/クレジットカード/その他）
   - メモ（任意）
4. **登録** をクリック

**入金登録後の動作**:
- 入金額が記録される
- 操作履歴に入金記録が追加される
- 全額入金の場合、ステータスが「入金済」に変更

### 入金状況

請求書の入金状況は以下のように表示されます：

| 入金状況 | 説明 |
|---------|------|
| **未入金** | 入金額が0円 |
| **一部入金** | 入金額が請求額より少ない |
| **入金済** | 入金額が請求額以上（全額入金） |

**一部入金の場合**:
- 一覧画面で「一部入金済 (¥500,000 / ¥1,000,000)」のように表示
- 追加の入金登録が可能
- 複数回の入金記録を追加できる

**全額入金の場合**:
- ステータスが「入金済」に変更
- これ以上の操作はできません（最終状態）

### 支払期限超過

支払期日を過ぎても入金がない場合、「期限超過」と表示されます。

**期限超過の表示**:
- 一覧画面でステータスバッジが赤色に変わる
- 詳細画面で「⚠ 支払期限超過」と表示

---

## PDF出力

承認済みの請求書は、PDF形式でダウンロードできます。

### PDF出力手順

1. 請求書詳細画面を開く
2. 画面右上の **PDF** ボタンをクリック
3. PDFファイルがダウンロードされる

**PDF出力内容**:
- 請求書本体（印刷可能なフォーマット）
- 組織情報（会社名、住所、電話番号、登録番号）
- 取引先情報
- 請求書番号、請求日、支払期日
- 件名
- 明細一覧
- 合計金額
- 備考

**注意**:
- 社内メモはPDFに含まれません

---

## 請求書の編集・削除

### 編集

下書き状態の請求書のみ編集できます。

**編集手順**:
1. 請求書詳細画面を開く（ステータス「下書き」）
2. 画面右上の **編集** ボタンをクリック
3. 編集画面で内容を修正
4. **下書き** または **提出** をクリック

**提出済み・承認済み・送付済みの請求書は編集できません**。
修正が必要な場合は、マネージャーに差し戻しを依頼してください。

### 削除

未承認の請求書のみ削除できます。

**削除手順**:
1. 請求書詳細画面を開く
2. 画面右上の **削除** ボタンをクリック
3. 確認ダイアログで **削除** をクリック

**削除可能な請求書**:
- 下書き
- 提出済み（承認前）

**削除できない請求書**:
- 承認済み
- 送付済み
- 入金済み

**注意**: 削除した請求書は復元できません。

---

## 入金予定一覧

入金予定一覧では、未入金・一部入金の請求書を一覧で確認できます。

### 入金予定一覧の表示

1. サイドメニューから **請求書** をクリック
2. 画面右上の **入金予定一覧** ボタンをクリック

**表示内容**:
- 支払期日順に並んだ請求書一覧
- 請求書番号、取引先名、工事名
- 請求日、支払期日
- 請求額、入金額、未入金額
- 入金状況（未入金/一部入金/期限超過）

**フィルタリング**:
- 期限超過のみ表示
- 未入金のみ表示
- 一部入金のみ表示

---

## トラブルシューティング

### 提出ボタンが押せない場合

必須項目が未入力の可能性があります。以下を確認してください：

1. **取引先** が選択されているか
2. **請求日** が入力されているか
3. **支払期日** が入力されているか
4. **件名** が入力されているか
5. **明細** が1つ以上追加されているか
6. 各明細の **項目名**、**数量**、**単位**、**単価** が入力されているか

フォーム内に赤字でエラーメッセージが表示されている項目がないか確認してください。

### 承認ボタンが表示されない場合

以下を確認してください：

1. **権限**: マネージャー以上の権限があるか
2. **ステータス**: 請求書が「提出済み」であるか
3. **既に承認済み**: 既に承認済みの場合、承認ボタンは表示されません

### 顧客送付ボタンが表示されない場合

以下を確認してください：

1. **権限**: マネージャー以上の権限があるか
2. **ステータス**: 請求書が「承認済」であるか
3. **既に送付済み**: 既に送付済みの場合、ボタンは表示されません

### 入金登録ボタンが表示されない場合

以下を確認してください：

1. **ステータス**: 請求書が「送付済」であるか
2. **既に全額入金済み**: 全額入金済みの場合、ボタンは表示されません
3. **権限**: マネージャー以上の権限があるか（リーダーは表示されません）

---

## 関連機能

- [見積書管理](./estimates.md)
- [取引先管理](./clients.md)
- [工事管理](./projects.md)
- [入金管理](./payments.md)

---

**請求書機能で、正確な請求書を作成・管理し、スムーズな入金管理を実現しましょう！**
