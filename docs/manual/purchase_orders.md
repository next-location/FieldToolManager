# 発注書管理

## 概要

発注書機能は、仕入先（サプライヤー）への発注を作成・管理するための機能です。
材料の仕入れ、外注作業の依頼、機器の購入などを体系的に管理し、承認フロー、発注送付、納品管理、支払管理まで、発注のライフサイクル全体を管理できます。

**主な機能**:
- 発注書の作成・編集（リーダー以上）
- 承認ワークフロー（マネージャー以上が承認）
- 仕入先への送付管理
- 納品記録
- 支払記録・管理
- 操作履歴の記録
- PDF出力
- 発注分析・レポート

---

## 対象者

### 作成・編集
- **リーダー（Leader）**: 自分が作成した発注書のみ作成・編集
- **マネージャー（Manager）**: 全ての発注書を作成・編集
- **管理者（Admin）**: 全ての発注書を作成・編集

### 承認
- **マネージャー（Manager）以上**: 他者が提出した発注書を承認・差し戻しできる
  - **注意**: 自分が作成した発注書は承認できません

### 発注送付
- **マネージャー（Manager）以上**: 承認済み発注書を仕入先に送付できる

### 納品・支払登録
- **リーダー（Leader）以上**: 納品・支払を記録できる

**注意**: スタッフ（Staff）は発注書機能を利用できません。

---

## 前提条件

発注書を作成する前に、以下のマスタデータが登録されている必要があります。

1. **取引先マスタ**: 発注先の仕入先が登録されている
   - 取引先タイプが「仕入先」または「両方」である必要があります
   - 支払条件（payment_terms）が設定されていると、自動入力されます
2. **工事マスタ（任意）**: 発注書に紐づける工事を登録（省略可能）

---

## 発注書のステータス

発注書は以下のステータスで管理されます：

| ステータス | 説明 |
|-----------|------|
| **下書き** | 作成中、編集可能 |
| **承認待ち** | リーダーが提出、承認待ち |
| **差戻し** | マネージャーが差し戻し、再編集可能 |
| **承認済** | マネージャーが承認済み（発注送付可能） |
| **発注済** | 仕入先に送付済み |
| **納品済** | 納品完了 |
| **支払済** | 支払完了（最終状態） |

### ステータスフロー

```
下書き → 承認待ち → 承認済 → 発注済 → 納品済 → 支払済
           ↓
         差戻し → 下書き（再編集）
```

**注意**:
- マネージャー以上が作成した場合、「承認待ち」をスキップして即座に承認されます

---

## 発注書の作成

### 基本的な作成手順

1. サイドメニューから **発注書** をクリック
2. 右下の **+** ボタン（FAB）をクリック
3. 基本情報と明細を入力
4. **下書き** または **提出** をクリック

### 消耗品発注管理から発注書を作成

消耗品発注管理で作成した発注依頼から、正式な発注書を作成できます。

**手順**:
1. 消耗品発注管理の詳細画面を開く
2. **発注書作成** ボタンをクリック
3. 発注書作成画面が開く
4. 消耗品発注の内容（仕入先、品名、数量、単価）が自動的に引き継がれる
5. 必要に応じて内容を編集
6. **下書き** または **提出** をクリック

### 入力項目の詳細

#### 基本情報

| 項目 | 必須 | 説明 |
|------|------|------|
| **発注番号** | ○ | 自動生成（PO-年月-連番） |
| **仕入先** | ○ | 発注先の仕入先を選択 |
| **工事** | - | 紐づける工事を選択（任意） |
| **発注日** | ○ | 発注書の発行日 |
| **納期** | - | 納品希望日 |
| **納品場所** | - | 納品先の住所や現場名 |
| **支払条件** | - | 支払条件（仕入先マスタから自動入力、編集可能） |

**発注番号の自動生成**:
- フォーマット: `PO-202501-0001`（年月-連番）
- 月ごとに連番がリセットされます

**支払条件の自動入力**:
- 仕入先に支払条件が設定されている場合、自動入力されます
- 手動で編集することもできます

#### 明細

発注書には1つ以上の明細を追加する必要があります。

| 項目 | 必須 | 説明 |
|------|------|------|
| **種別** | ○ | 材料費/人件費/外注費/機材費/その他 |
| **品名** | ○ | 明細の名称 |
| **仕様・規格** | - | 明細の詳細説明 |
| **数量** | ○ | 数量 |
| **単位** | ○ | 袋/箱/個/台/本/枚/m/m²/m³/kg/t/L/日/時間/人/その他 |
| **単価** | ○ | 単価（税抜） |
| **税率** | ○ | 10%/8%/0% |
| **金額** | - | 自動計算（数量×単価） |

**明細の追加・削除**:
- **+ 明細を追加** ボタンで明細を追加
- 各明細の **削除** ボタンで削除（最低1つは必要）

**数値入力**:
- 全角数字を入力しても自動的に半角に変換されます

#### 備考

| 項目 | 説明 |
|------|------|
| **備考** | 発注書に記載される備考（仕入先に表示） |
| **社内メモ** | 社内用のメモ（発注書には記載されません） |

---

## 下書き保存と提出

### 下書き保存

作成途中の発注書を保存する場合は **下書き** ボタンをクリックします。

**下書き状態の特徴**:
- いつでも編集・削除が可能
- 承認者には表示されない
- 一覧画面でステータス「下書き」として表示

### 提出（リーダーの場合）

リーダーが発注書を完成させて提出する場合は **提出** ボタンをクリックします。

**提出時の動作**:
- ステータスが「承認待ち」に変更
- マネージャー以上に承認依頼の通知が届く
- 提出後は編集できません（差し戻された場合のみ再編集可能）

### 提出（マネージャー以上の場合）

マネージャー以上が発注書を作成する場合、**提出** ボタンをクリックすると即座に承認されます。

**提出時の動作**:
- ステータスが「承認済」に変更（承認プロセスをスキップ）
- 発注送付ボタンが表示される

---

## 発注書の閲覧

### 一覧画面

発注書一覧では、以下の情報がカード形式で表示されます：

- ステータスバッジ
- 発注番号
- 発注日・納期
- 仕入先名・工事名
- 作成者（リーダーの場合）
- 承認者（マネージャー以上のみ表示）
- 金額
- 支払状況（未払/一部支払/支払済）

**フィルタリング**:
- ステータスで絞り込み
- 支払状況で絞り込み（未払/一部支払/支払済）
- キーワード検索（発注番号、仕入先名、工事名）

**ソート**:
- 発注日
- 納期
- 金額

### 詳細画面

発注書をクリックすると、詳細画面が開きます。

**表示内容**:
- ステータス表示（ステータスバッジ＋支払状況）
- 発注書本体（印刷可能なフォーマット）
- 宛先情報（仕入先名、住所）
- 発注元情報（組織名、住所、電話番号）
- 発注番号、発注日、納期、納品場所、支払条件
- 明細一覧
- 合計金額（小計、消費税、合計）
- 備考
- 社内メモ（印刷時は非表示）
- 承認情報（承認済みの場合）
- 支払記録（支払済みの場合）
- 操作履歴

---

## 承認フロー

### リーダーが作成した場合

1. リーダーが発注書を作成
2. **提出** → ステータス「承認待ち」
3. マネージャー以上が承認または差し戻し
4. ステータス「承認済」に変更（発注送付ボタンが表示される）

### マネージャー以上が作成した場合

1. マネージャー以上が発注書を作成
2. **提出** → ステータス「承認済」（即座に承認）
3. 発注送付ボタンが表示される

### 承認手順（マネージャー以上）

1. 発注書一覧から「承認待ち」の発注書を開く
2. 内容を確認
3. 画面右上の **承認** ボタンをクリック
4. 確認ダイアログで **確定** をクリック

**承認時の注意**:
- 自分が作成した発注書は承認できません
- 承認後は編集・削除ができなくなります

**承認後の動作**:
- ステータスが「承認済」に変更
- 作成者に承認完了の通知が届く
- 発注送付ボタンが表示される

### 差し戻し手順（マネージャー以上）

承認せずに修正が必要な場合は、差し戻しができます。

1. 発注書一覧から「承認待ち」の発注書を開く
2. 内容を確認
3. 画面右上の **差し戻し** ボタンをクリック
4. 差し戻し理由を入力（必須）
5. **確定** をクリック

**差し戻し後の動作**:
- ステータスが「差戻し」に変更
- 作成者に差し戻しの通知が届く
- 作成者は発注書を再編集して再提出できる

---

## 仕入先への送付

承認済みの発注書は、仕入先に送付できます。

### 発注送付手順（マネージャー以上）

1. 発注書詳細画面を開く
2. 画面右上の **発注送付** ボタンをクリック
3. 確認ダイアログで **確定** をクリック

**送付時の動作**:
- 仕入先にメールが送信される（PDF添付）
- ステータスが「発注済」に変更
- 操作履歴に送付記録が追加される
- 納品登録ボタンが表示される

---

## 納品管理

### 納品登録

発注済みの発注書に対して、納品を記録できます。

**納品登録手順**:
1. 発注書詳細画面を開く（ステータス「発注済」）
2. 画面右上の **納品登録** ボタンをクリック
3. 確認ダイアログで **確定** をクリック

**納品登録後の動作**:
- ステータスが「納品済」に変更
- 操作履歴に納品記録が追加される
- 支払登録ボタンが表示される

---

## 支払管理

### 支払登録

納品済みの発注書に対して、支払を記録できます。

**支払登録手順**:
1. 発注書詳細画面を開く（ステータス「納品済」）
2. 画面右上の **支払登録** ボタンをクリック
3. 支払情報を入力
   - 支払日
   - 支払額
   - 支払方法（銀行振込/現金/クレジットカード/その他）
   - 参照番号（任意）
   - メモ（任意）
4. **登録** をクリック

**支払登録後の動作**:
- 支払額が記録される
- 操作履歴に支払記録が追加される
- 全額支払の場合、ステータスが「支払済」に変更

### 支払状況

発注書の支払状況は以下のように表示されます：

| 支払状況 | 説明 |
|---------|------|
| **未払** | 支払額が0円 |
| **一部支払** | 支払額が発注額より少ない |
| **支払済** | 支払額が発注額以上（全額支払） |

**一部支払の場合**:
- 一覧画面で「一部支払済 (¥500,000 / ¥1,000,000)」のように表示
- 追加の支払登録が可能
- 複数回の支払記録を追加できる

**全額支払の場合**:
- ステータスが「支払済」に変更
- これ以上の操作はできません（最終状態）

---

## PDF出力

承認済みの発注書は、PDF形式でダウンロードできます。

### PDF出力手順

1. 発注書詳細画面を開く
2. 画面右上の **PDF** ボタンをクリック
3. PDFファイルがダウンロードされる

**PDF出力内容**:
- 発注書本体（印刷可能なフォーマット）
- 発注元情報（会社名、住所、電話番号）
- 仕入先情報
- 発注番号、発注日、納期、納品場所、支払条件
- 明細一覧
- 合計金額
- 備考

**注意**:
- 社内メモはPDFに含まれません

---

## 発注書の編集・削除

### 編集

下書き状態または差戻し状態の発注書のみ編集できます。

**編集手順**:
1. 発注書詳細画面を開く（ステータス「下書き」または「差戻し」）
2. 画面右上の **編集** ボタンをクリック
3. 編集画面で内容を修正
4. **下書き** または **提出** をクリック

**提出済み・承認済み・発注済みの発注書は編集できません**。
修正が必要な場合は、マネージャーに差し戻しを依頼してください。

### 削除

未承認の発注書のみ削除できます。

**削除手順**:
1. 発注書詳細画面を開く
2. 画面右上の **削除** ボタンをクリック
3. 確認ダイアログで **削除** をクリック

**削除可能な発注書**:
- **リーダー**: 下書き、差戻し
- **マネージャー以上**: 下書き、承認待ち、差戻し

**削除できない発注書**:
- 承認済み
- 発注済み
- 納品済み
- 支払済み

**注意**: 削除した発注書は復元できません。

---

## 支払予定一覧

支払予定一覧では、未払・一部支払の発注書を納期順に一覧で確認できます。

### 支払予定一覧の表示

1. サイドメニューから **発注書** をクリック
2. 画面右上の **支払予定一覧** ボタンをクリック

**表示内容**:
- 納期順に並んだ発注書一覧
- 発注番号、仕入先名、工事名
- 発注日、納期
- 発注額、支払額、未払額
- 支払状況（未払/一部支払/納期超過）

**フィルタリング**:
- 納期超過のみ表示
- 未払のみ表示
- 一部支払のみ表示

---

## 発注分析

発注分析画面では、発注書の統計情報を確認できます。

### 発注分析の表示

1. サイドメニューから **発注書** をクリック
2. 画面右上の **分析** ボタンをクリック

**表示内容**:
- 発注金額の推移グラフ（月別）
- 仕入先別の発注金額ランキング
- 品目別の発注金額ランキング
- 工事別の発注金額ランキング
- 発注ステータス別の件数・金額

**期間指定**:
- 今月、今四半期、今年
- カスタム期間

---

## トラブルシューティング

### 提出ボタンが押せない場合

必須項目が未入力の可能性があります。以下を確認してください：

1. **仕入先** が選択されているか
2. **発注日** が入力されているか
3. **明細** が1つ以上追加されているか
4. 各明細の **品名**、**数量**、**単位**、**単価** が入力されているか

フォーム内に赤字でエラーメッセージが表示されている項目がないか確認してください。

### 承認ボタンが表示されない場合

以下を確認してください：

1. **権限**: マネージャー以上の権限があるか
2. **ステータス**: 発注書が「承認待ち」であるか
3. **作成者**: 自分が作成した発注書は承認できません
4. **既に承認済み**: 既に承認済みの場合、承認ボタンは表示されません

### 発注送付ボタンが表示されない場合

以下を確認してください：

1. **権限**: マネージャー以上の権限があるか
2. **ステータス**: 発注書が「承認済」であるか
3. **既に送付済み**: 既に送付済みの場合、ボタンは表示されません

### 納品登録ボタンが表示されない場合

以下を確認してください：

1. **ステータス**: 発注書が「発注済」であるか
2. **既に納品済み**: 既に納品済みの場合、ボタンは表示されません

---

## 関連機能

- [取引先管理](./clients.md)
- [工事管理](./projects.md)
- [消耗品発注管理](./consumable_orders.md)
- [支払管理](./payments.md)

---

**発注書機能で、正確な発注管理と支出管理を実現しましょう！**
