# QRコード有効期間の確認方法（中学生でもわかる簡単ガイド）

## QRコード有効期間とは？

出退勤用のQRコードには「賞味期限」があります。
例えば「7日」に設定すると、QRコードは1週間後に使えなくなります。

## なぜ有効期限があるの？

- **セキュリティ対策**: QRコードの写真を撮られても、数日後には使えなくなる
- **不正防止**: 古いQRコードを悪用されるのを防ぐ

## 設定できる期間

| 設定 | 意味 | いつまで使える？ | 例 |
|-----|-----|----------------|-----|
| 1日 | 当日のみ有効 | **当日の23:59まで** | 1/27 14:30発行 → 1/27 23:59まで |
| 3日 | 3日後まで有効 | **3日後の23:59まで** | 1/27 14:30発行 → 1/30 23:59まで |
| 7日 | 7日後まで有効 | **7日後の23:59まで** | 1/27 14:30発行 → 2/3 23:59まで |
| 30日 | 30日後まで有効 | **30日後の23:59まで** | 1/27 14:30発行 → 2/26 23:59まで |

**重要ポイント**: 何時に発行しても、必ず**23:59に期限切れ**になります！

## 確認方法（ステップ・バイ・ステップ）

### 📋 準備するもの

1. **スマホ2台**
   - スマホA: リーダー（管理者）のスマホ
   - スマホB: スタッフのスマホ

2. **メモとペン**
   - 日時を記録するため

---

### 🔍 確認手順

#### **ステップ1: 設定を「1日」に変更する**

1. 管理者でログイン
2. `勤怠管理` → `設定` → `基本` タブ
3. 「QRコード有効期間」を **1日** に変更
4. 保存ボタンを押す

**📝メモ**: 今の日時を書く → 例: `2026年1月27日 14:30`

---

#### **ステップ2: QRコードを発行する**

1. `勤怠管理` → `QR発行（リーダー）` を開く
2. **会社用QRコード**を表示
3. スマホAの画面をそのままにしておく

**💡ポイント**: このQRコードは「2026年1月27日の23:59まで」有効

---

#### **ステップ3: スマホBでスキャンしてみる（成功パターン）**

1. スマホBでスタッフとしてログイン
2. `出退勤` ページを開く
3. 「QRコードでスキャン」ボタンを押す
4. スマホAのQRコードをスキャン

**✅ 期待される結果**:
- 「出勤打刻が完了しました」と表示される
- これが正常な動き

**📝メモ**: `1回目 成功 - 2026年1月27日 14:35`

---

#### **ステップ4: 翌日（1日後）に同じQRコードをスキャン（失敗パターン）**

**重要**: スマホAのQRコードは**そのまま**（新しくしない）

1. **翌日**（2026年1月28日）になったら
2. スマホBで出退勤ページを開く
3. スマホAの**昨日のQRコード**をスキャン

**❌ 期待される結果**:
- 「このQRコードは有効期限切れです」とエラーが出る
- これが正常な動き（古いQRコードは使えない）

**📝メモ**: `2回目 失敗 - 2026年1月28日 9:00 - エラー: 有効期限切れ`

---

#### **ステップ5: 新しいQRコードを発行して確認（成功パターン）**

1. スマホAで**新しいQRコード**を発行
2. スマホBでスキャン

**✅ 期待される結果**:
- 「出勤打刻が完了しました」と表示される
- 新しいQRコードは使える

**📝メモ**: `3回目 成功 - 2026年1月28日 9:05 - 新QRコード`

---

### 🎯 確認完了！

もし上記の通りに動いたら、QRコード有効期間は**正常に動作しています**。

---

## 簡単バージョン（3ステップ確認）

時間がない人向けの超簡単確認方法：

1. **今日**: QRコードを発行してスキャン → ✅ 成功するはず
2. **設定を「1日」にする**
3. **明日**: 同じQRコードをスキャン → ❌ エラーが出るはず

---

## よくある質問

### Q1: スマホが1台しかない場合は？

**A**: QRコードをスクリーンショットで保存して、別の日に試してください。

```
1. 今日: QRコード画面をスクリーンショット
2. 明日: そのスクリーンショットを別のQRコードリーダーアプリでスキャン
3. 中身のテキストをコピー
4. 出退勤ページで手動入力（開発者向け）
```

### Q2: どこにエラーが表示されるの？

**A**: スマホ画面の上の方に赤い背景で「このQRコードは有効期限切れです」と表示されます。

### Q3: 有効期限はいつから始まるの？

**A**: QRコードを**発行した瞬間**から数えます。

例:
- 発行日時: 2026年1月27日 14:30
- 設定: 7日
- 有効期限: 2026年2月3日 23:59まで

---

## トラブルシューティング

### うまく確認できない場合

#### パターン1: 翌日でもエラーが出ない

**原因**:
- 設定が保存されていない可能性
- キャッシュの問題

**対処法**:
1. ブラウザを完全に閉じて開き直す
2. 設定ページでもう一度「1日」を選んで保存
3. QRコードを**再発行**してから試す

#### パターン2: 今日でもエラーが出る

**原因**:
- QRコードが古い（発行してから時間が経ちすぎ）

**対処法**:
1. 新しいQRコードを発行
2. すぐにスキャンしてみる

---

## まとめ

**QRコード有効期間の仕組み**:
```
QRコード発行
    ↓
有効期限が設定される（例: 7日後の23:59まで）
    ↓
期限内 → ✅ スキャン成功
期限切れ → ❌ エラー「有効期限切れです」
```

**この機能があることで**:
- QRコードの写真を撮られても安心
- 定期的にQRコードを更新する必要がある（セキュリティ向上）

---

## 開発者向け情報

### データベースで確認する方法

```sql
-- QRコードテーブルから有効期限を確認
SELECT
  id,
  qr_type,
  qr_data,
  created_at,
  expires_at,
  is_active,
  CASE
    WHEN expires_at > NOW() THEN '有効'
    ELSE '期限切れ'
  END as status
FROM attendance_qr_codes
WHERE organization_id = 'あなたの組織ID'
ORDER BY created_at DESC
LIMIT 5;
```

### API レスポンスで確認

QRスキャン時のAPIレスポンス:

```json
// 成功時
{
  "success": true,
  "message": "出勤打刻が完了しました"
}

// 期限切れ時
{
  "error": "このQRコードは有効期限切れです"
}
```

---

**作成日**: 2026年1月27日
**バージョン**: 1.0
