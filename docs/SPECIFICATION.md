# 道具管理システム 設計・仕様書

## 目次
1. [システム概要](#1-システム概要)
2. [ユーザーペルソナ](#2-ユーザーペルソナ)
3. [情報アーキテクチャ](#3-情報アーキテクチャ)
4. [画面設計](#4-画面設計)
5. [QRスキャン機能](#5-qrスキャン機能)
6. [データモデル](#6-データモデル)
7. [技術仕様](#7-技術仕様)
8. [セキュリティ](#8-セキュリティ)
9. [導入・運用](#9-導入運用)
10. [開発ロードマップ](#10-開発ロードマップ)

---

## 1. システム概要

### 1.1 課題
- 道具の数量・所在が不明確（現場 vs 会社倉庫）
- 20名のスタッフによる複雑な道具移動の管理困難
- アナログ管理によるDX化の遅れ

### 1.2 解決策
全道具に**一意のID + QRコード**を付与し、スマホでスキャンするだけで**リアルタイムな在庫・所在管理**を実現

### 1.3 主要機能
1. **道具マスタ管理** - 道具情報のデジタル化
2. **在庫・所在管理** - リアルタイム在庫表示
3. **入出庫・移動管理** - QRスキャンによる履歴追跡

---

## 2. ユーザーペルソナ

### ペルソナA: 現場スタッフ（一般作業者）
- **年齢**: 20-50代
- **ITリテラシー**: 低〜中
- **利用環境**: 屋外、手袋着用、雨天・日光下
- **ニーズ**: 簡単・迅速なスキャン操作

### ペルソナB: 現場リーダー
- **年齢**: 30-50代
- **ITリテラシー**: 中
- **利用環境**: 現場と会社の両方
- **ニーズ**: 現場ごとの在庫把握、チェックリスト

### ペルソナC: 経営者・管理者
- **年齢**: 40-60代
- **ITリテラシー**: 低〜中
- **利用環境**: 主にPC、時々スマホ
- **ニーズ**: 一目で分かるダッシュボード、発注判断材料

---

## 3. 情報アーキテクチャ

### 3.1 ナビゲーション構造（モバイルファースト）

**下部タブバー**:
```
┌─────────────────────────────────────┐
│  ホーム   スキャン   道具   履歴   設定  │
│   🏠      📷      🔧     📋     ⚙️   │
└─────────────────────────────────────┘
```

**設計理由**:
- スマホ片手操作で親指が届きやすい下部配置
- 最頻度機能（ホーム・スキャン）を左側に
- アイコン+テキストで視認性向上

### 3.2 権限別アクセス制御

| 機能 | 一般スタッフ | 現場リーダー | 管理者 |
|------|-------------|-------------|--------|
| ダッシュボード閲覧 | ○ | ○ | ○ |
| QRスキャン | ○ | ○ | ○ |
| 道具検索・閲覧 | ○ | ○ | ○ |
| 道具登録・編集 | × | △ | ○ |
| 現場マスタ管理 | × | × | ○ |
| 購入・発注管理 | × | × | ○ |
| ユーザー管理 | × | × | ○ |

---

## 4. 画面設計

### 4.1 ホーム（ダッシュボード）

#### レイアウト
```
┌─────────────────────────────────┐
│ [ヘッダー]                      │
│ 道具管理システム    [通知🔔 3]  │
├─────────────────────────────────┤
│ 【在庫サマリー】                │
│ ┌───────┐ ┌───────┐ ┌───────┐ │
│ │ 総在庫 │ │現場中 │ │会社  │ │
│ │ 324個│ │ 187個│ │ 137個│ │
│ └───────┘ └───────┘ └───────┘ │
├─────────────────────────────────┤
│ 【要注意アラート】 🚨           │
│ ⚠️ 在庫不足 (3件)              │
│ ・ドライバーセット 残り2個      │
│ → 発注管理へ                   │
│                                 │
│ 🔧 長期未返却 (2件)            │
│ ・現場A: ハンマー (7日間)      │
│ → 詳細を見る                   │
├─────────────────────────────────┤
│ 【直近の移動履歴】（最新5件）   │
│ 🔵 10:30 田中太郎            │
│    ドライバーセット → 現場A     │
└─────────────────────────────────┘
```

#### UX配慮ポイント
- **3秒ルール**: 開いて3秒以内に重要情報を把握
- **色分け**: 在庫（青）、警告（赤・黄）、正常（緑）
- **大きな数字**: 24px以上のフォント
- **直接アクション**: アラートから該当機能へワンタップ遷移

---

### 4.2 スキャン（入出庫・移動）

#### スキャンフロー

**ステップ1: アクション選択**
```
┌─────────────────────────────────┐
│ どの操作をしますか？            │
│ ┌─────────────────────────────┐│
│ │ 📤 持ち出し（会社→現場）    ││
│ │ 📥 返却（現場→会社）        ││
│ │ 🔄 現場間移動               ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

**ステップ2: スキャン実行**
```
┌─────────────────────────────────┐
│ [×]                   [💡ライト]│
│    ┌─────────────────┐          │
│    │  QRコード       │          │
│    │  読み取り枠     │          │
│    └─────────────────┘          │
│  道具のQRコードを枠内に合わせる │
│ ┌─────────────────────────────┐│
│ │ 📷 カメラでスキャン         ││
│ │ ⌨️  手動でID入力            ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

**ステップ3: 詳細入力**
```
┌─────────────────────────────────┐
│ スキャン完了 ✓                  │
│ 道具: ドライバーセット #A-0123  │
│ 現在地: 会社倉庫                │
├─────────────────────────────────┤
│ 移動先の現場を選択              │
│ 🏗️ 現場A（渋谷ビル改修）       │
│ 🏗️ 現場B（新宿マンション）      │
│                                 │
│ 備考（任意）                    │
│ [例: 緊急修理のため]            │
│                                 │
│ [     登録する ✓     ]         │
└─────────────────────────────────┘
```

**ステップ4: 完了**
```
┌─────────────────────────────────┐
│         ✅                      │
│     登録完了しました!           │
│ ドライバーセット #A-0123        │
│ 会社倉庫 → 現場A                │
│                                 │
│ [  続けてスキャン  ]            │
│ [  ホームに戻る    ]            │
│                                 │
│ (3秒後に自動でスキャン画面へ)   │
└─────────────────────────────────┘
```

#### UX配慮ポイント
- **ワンタップアクセス**: 下部タブ中央配置
- **大きなボタン**: 最小44px×44px（手袋対応）
- **フラッシュライト**: 暗所対応
- **手動入力**: カメラ不調時のフォールバック
- **連続スキャンモード**: 複数道具の効率的処理
- **音声+振動フィードバック**: 成功を即座に通知

---

### 4.3 道具（一覧・検索）

#### 検索画面
```
┌─────────────────────────────────┐
│ [🔍 道具名・IDで検索]     [🎚️]│
├─────────────────────────────────┤
│ クイックフィルター              │
│ [全て][電動工具][手工具][測定器]│
│                                 │
│ 所在フィルター                  │
│ [すべて][会社][現場A][現場B]    │
├─────────────────────────────────┤
│ 324件の道具                     │
│ ┌─────────────────────────────┐│
│ │ 🔧 ドライバーセット         ││
│ │ ID: A-0123                  ││
│ │ 📍 現場A  👤 田中太郎       ││
│ │ 🕐 2時間前                  ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ ⚡ 電動サンダー             ││
│ │ ID: B-0045                  ││
│ │ 📍 会社倉庫                 ││
│ │ ⚠️ 要メンテナンス          ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

#### 詳細モーダル
```
┌─────────────────────────────────┐
│ [×]        道具詳細             │
│ 🔧 ドライバーセット             │
│ ID: A-0123                      │
├─────────────────────────────────┤
│ 基本情報                        │
│ ・種類: 電動工具                │
│ ・型番: XYZ-2000                │
│ ・メーカー: マキタ              │
│ ・購入日: 2023/04/15            │
│ ・状態: 🟢 正常                │
├─────────────────────────────────┤
│ 現在の所在                      │
│ 📍 現場A（渋谷ビル改修）        │
│ 👤 田中太郎                     │
│ 🕐 2024/11/29 10:30             │
├─────────────────────────────────┤
│ 移動履歴（最新5件）             │
│ 11/29 会社→現場A                │
│ 11/25 現場B→会社                │
│ → すべての履歴を見る            │
├─────────────────────────────────┤
│ [スキャン][編集][故障報告]      │
└─────────────────────────────────┘
```

#### UX配慮ポイント
- **インクリメンタル検索**: リアルタイム絞り込み
- **視覚的アイコン**: 文字より先に情報伝達
- **所在の強調**: 現在地を最も目立つ位置に
- **カード形式**: 情報の塊として認識しやすい
- **無限スクロール**: ページネーションより直感的

---

### 4.4 履歴追跡

```
┌─────────────────────────────────┐
│ 移動履歴                        │
│ [道具で検索][スタッフで検索]    │
│ [期間指定] [📅 今月]            │
├─────────────────────────────────┤
│ タイムライン表示                │
│                                 │
│ 2024/11/29 ────────────────     │
│ 🔵 10:30 田中太郎              │
│ ドライバーセット #A-0123        │
│ 会社倉庫 → 現場A                │
│                                 │
│ 🟢 09:15 佐藤花子              │
│ サンダー #B-0045                │
│ 現場B → 会社倉庫                │
│                                 │
│ 2024/11/28 ────────────────     │
│ 🔵 16:00 鈴木一郎              │
│ ハンマー #C-0078                │
│ 現場A → 現場B                   │
└─────────────────────────────────┘
```

#### エクスポート機能
- CSV出力（Excel対応）
- PDF出力（印刷用）
- 期間指定（日次・週次・月次）

---

### 4.5 設定（管理者向け）

```
┌─────────────────────────────────┐
│ 設定                            │
├─────────────────────────────────┤
│ 【道具マスタ管理】              │
│ ➕ 新規道具登録                │
│ 📦 一括登録（CSVインポート）    │
│ 🏷️ QRコード一括印刷            │
├─────────────────────────────────┤
│ 【現場マスタ管理】              │
│ ➕ 新規現場登録                │
│ 📋 現場一覧・編集               │
├─────────────────────────────────┤
│ 【アラート設定】                │
│ 在庫下限: ドライバー [5]個以下  │
│ 未返却アラート: [7]日以上       │
├─────────────────────────────────┤
│ 【ユーザー管理】                │
│ 👥 スタッフ一覧・権限設定      │
└─────────────────────────────────┘
```

---

## 5. QRスキャン機能

### 5.1 QRコード設計

#### QRコード内容
```
https://tool.company.com/scan?id=A-0123
```

#### 仕様
- **サイズ**: 最小25mm × 25mm
- **訂正レベル**: Level H（約30%復元可能）
- **推奨印刷**: 耐水ラベル、ラミネート加工

#### 道具ID命名規則
```
[カテゴリーコード]-[連番4桁]

例:
A-0001～A-9999: 電動工具
B-0001～B-9999: 手工具
C-0001～C-9999: 測定器
D-0001～D-9999: 消耗品
```

---

### 5.2 スキャン技術仕様

#### 使用ライブラリ
- **`html5-qrcode`**: PWAでカメラアクセス
- **`qrcode`**: QRコード生成

#### 最適化機能
- オートフォーカス
- ピンチイン/アウトでズーム
- フラッシュライト制御
- スキャン音（ON/OFF可能）
- 振動フィードバック

#### エラーハンドリング

| エラー | メッセージ | アクション |
|--------|-----------|-----------|
| カメラ権限なし | 「カメラの使用を許可してください」 | 設定画面へリンク |
| 読み取り失敗 | 「QRコードが読み取れません」 | 手動入力ボタン表示 |
| 未登録ID | 「このIDは登録されていません」 | 管理者へ連絡促す |
| オフライン | 「オフライン状態です」 | ローカル保存 |

---

## 6. データモデル

### 6.1 エンティティ関係図

```
User (ユーザー)
├── id (PK)
├── name
├── email
├── role (admin/leader/staff)
└── created_at

Tool (道具)
├── id (PK)
├── tool_code (UQ) "A-0001"
├── category_id (FK → ToolCategory)
├── name
├── model_number
├── manufacturer
├── purchase_date
├── status (normal/repair/broken)
├── current_location_id (FK → Location)
├── min_stock_alert
├── photo_url
├── manual_url
└── created_at

ToolMovement (移動履歴)
├── id (PK)
├── tool_id (FK)
├── user_id (FK)
├── from_location_id (FK)
├── to_location_id (FK)
├── movement_type (checkout/checkin/transfer)
├── note
├── moved_at
└── created_at

Location (場所)
├── id (PK)
├── type (company/site)
├── name
├── address
├── manager_name
├── is_active
└── created_at

ToolCategory (道具カテゴリ)
├── id (PK)
├── name
└── code_prefix (A/B/C/D)

PurchaseOrder (発注管理)
├── id (PK)
├── tool_category (FK)
├── quantity
├── status (pending/ordered/delivered)
├── ordered_by (FK → User)
├── ordered_at
└── delivered_at

Notification (通知)
├── id (PK)
├── user_id (FK)
├── type (low_stock/overdue/damage)
├── message
├── is_read
└── created_at
```

---

### 6.2 主要テーブル定義

#### Tool（道具マスタ）
```typescript
interface Tool {
  id: string;                    // UUID
  tool_code: string;             // "A-0001" (ユニーク)
  category_id: string;           // FK
  name: string;                  // "ドライバーセット"
  model_number: string;          // "XYZ-2000"
  manufacturer: string;          // "マキタ"
  purchase_date: Date;
  status: 'normal' | 'repair' | 'broken' | 'disposed';
  current_location_id: string;   // FK
  min_stock_alert: number;       // 在庫下限
  photo_url?: string;
  manual_url?: string;
  created_at: Date;
  updated_at: Date;
}
```

#### ToolMovement（移動履歴）
```typescript
interface ToolMovement {
  id: string;
  tool_id: string;
  user_id: string;
  from_location_id: string;
  to_location_id: string;
  movement_type: 'checkout' | 'checkin' | 'transfer';
  note?: string;
  moved_at: Date;
  created_at: Date;
}
```

#### Location（場所）
```typescript
interface Location {
  id: string;
  type: 'company' | 'site';
  name: string;                  // "会社倉庫" or "現場A"
  address?: string;
  manager_name?: string;
  is_active: boolean;
  created_at: Date;
}
```

---

## 7. 技術仕様

### 7.1 技術スタック

```json
{
  "dependencies": {
    // フレームワーク
    "next": "^14.0.0",
    "react": "^18.0.0",
    "typescript": "^5.0.0",

    // UI
    "tailwindcss": "^3.4.0",
    "@headlessui/react": "^1.7.0",
    "lucide-react": "^0.300.0",

    // QRコード
    "html5-qrcode": "^2.3.8",
    "qrcode": "^1.5.3",

    // 状態管理
    "zustand": "^4.4.0",

    // フォーム
    "react-hook-form": "^7.48.0",
    "zod": "^3.22.0",

    // データフェッチ
    "@tanstack/react-query": "^5.0.0",

    // 日付
    "date-fns": "^2.30.0",

    // PWA
    "next-pwa": "^5.6.0",

    // データベース
    "@supabase/supabase-js": "^2.38.0"
  }
}
```

---

### 7.2 PWA対応（オフライン機能）

#### 必要性
- 現場では電波が不安定
- オフラインでもスキャン継続可能に

#### 実装方針
```typescript
// Service Worker実装
interface OfflineQueueItem {
  id: string;
  tool_id: string;
  action: 'checkout' | 'checkin' | 'transfer';
  from_location: string;
  to_location: string;
  user_id: string;
  timestamp: Date;
  synced: boolean;
}

// 1. スキャンデータをIndexedDBに一時保存
// 2. オンライン復帰時に自動同期
// 3. 同期完了を通知
```

#### オフライン対応範囲
- ✅ QRスキャン（ローカル保存）
- ✅ 道具一覧閲覧（キャッシュ）
- ❌ 管理者機能（オンライン必須）

---

### 7.3 レスポンシブデザイン

#### ブレークポイント
```css
sm: 640px   /* スマホ横 */
md: 768px   /* タブレット縦 */
lg: 1024px  /* タブレット横 */
xl: 1280px  /* デスクトップ */
```

#### デバイス別最適化

**スマホ（主要デバイス）**
- ボタン: 最小44px × 44px
- フォント: 本文16px、見出し20px以上
- タップ領域: 間隔8px以上

**タブレット**
- 2カラムレイアウト
- サイドバーナビゲーション

**PC**
- 3カラムレイアウト
- グラフ追加
- キーボードショートカット

---

### 7.4 アクセシビリティ（WCAG 2.1 AA準拠）

- ✅ コントラスト比 4.5:1以上
- ✅ フォーカス表示
- ✅ スクリーンリーダー対応（ARIA）
- ✅ タッチターゲット最小サイズ

**高齢者対応**
- 大きな文字（最小16px）
- 明確なアイコン
- 誤操作防止（確認ダイアログ）

---

### 7.5 パフォーマンス目標

| 指標 | 目標値 |
|------|--------|
| FCP（初回表示） | 1.5秒以内 |
| TTI（インタラクティブ） | 3秒以内 |
| QRスキャン応答 | 0.5秒以内 |
| ページ遷移 | 0.3秒以内 |
| Lighthouse | 90点以上 |

**最適化施策**
- 画像最適化（WebP、遅延読み込み）
- コード分割（Dynamic Import）
- CDN配信
- DBインデックス最適化

---

## 8. セキュリティ

### 8.1 認証・認可

#### 認証方式
- メールアドレス + パスワード
- JWT セッション管理
- パスワードリセット機能

#### 権限制御（RBAC）
```typescript
enum UserRole {
  ADMIN = 'admin',    // 全機能アクセス
  LEADER = 'leader',  // 閲覧+スキャン+一部編集
  STAFF = 'staff'     // 閲覧+スキャンのみ
}

const permissions = {
  'tool.create': [UserRole.ADMIN],
  'tool.edit': [UserRole.ADMIN, UserRole.LEADER],
  'tool.view': [UserRole.ADMIN, UserRole.LEADER, UserRole.STAFF],
  'tool.scan': [UserRole.ADMIN, UserRole.LEADER, UserRole.STAFF],
  'location.manage': [UserRole.ADMIN],
  'user.manage': [UserRole.ADMIN],
  'purchase.create': [UserRole.ADMIN],
};
```

---

## 9. 導入・運用

### 9.1 初期導入ステップ

#### フェーズ1: 準備（1-2週間）
1. 既存道具の棚卸し
2. カテゴリー分類とID付与
3. QRコードラベル印刷・貼付
4. 現場マスタ登録
5. スタッフアカウント作成

#### フェーズ2: パイロット運用（2-4週間）
1. 1現場で試験運用
2. フィードバック収集
3. UI/UX改善

#### フェーズ3: 本格展開（1ヶ月〜）
1. 全現場へ展開
2. 運用ルール徹底教育
3. 定期棚卸しとデータ整合性チェック

---

### 9.2 運用ルール

#### 必須ルール
1. **道具移動時は必ずスキャン**
2. **1日の終わりに現場リーダーが在庫確認**
3. **週1回の棚卸し**（現場ごと）
4. **故障・紛失は即座に報告**

#### KPI設定
- スキャン実施率: 95%以上
- 在庫差異率: 5%以下
- 未返却アラート対応率: 100%

---

## 10. 開発ロードマップ

### MVP（最小限の機能）- フェーズ1
✅ 道具マスタ管理
✅ QRスキャン（入出庫）
✅ 在庫サマリー表示
✅ 移動履歴記録
✅ 低在庫アラート

### フェーズ2（3ヶ月後）
📊 ダッシュボードのグラフ化
🔧 損耗・修理管理機能
📋 現場別チェックリスト
📧 メール通知機能

### フェーズ3（6ヶ月後）
📷 道具写真・マニュアル添付
📱 スタッフ稼働現場表示
💰 コスト分析
📤 API連携（会計ソフト等）

---

## まとめ

本システムは**現場スタッフの使いやすさを最優先**に設計されています。

### 成功の鍵
1. **シンプルな操作**: QRスキャンだけで完結
2. **モバイルファースト**: スマホでの操作性を徹底追求
3. **オフライン対応**: 現場の電波環境に配慮
4. **段階的導入**: パイロット運用で改善を繰り返す
5. **運用ルールの徹底**: システムだけでなく、人の運用も重要

このシステムにより、**アナログ管理からの脱却**と**リアルタイムな道具管理**を実現し、業務効率の大幅な改善が期待できます。
