# 請求・プラン変更機能テスト計画

## 目的
月払い/年払い契約の請求書生成、プラン変更（アップグレード/ダウングレード）の動作確認を行う。

## テスト用ヘルパーAPI

### 1. `/api/admin/test/generate-invoice`
特定の契約の請求書を即座に生成

**使い方:**
```bash
curl -X POST https://zairoku.com/api/admin/test/generate-invoice \
  -H "Content-Type: application/json" \
  -H "Cookie: super-admin-session=<セッションCookie>" \
  -d '{"contract_id": "<契約ID>"}'
```

### 2. `/api/admin/test/update-billing-date`
契約の請求日を今日に変更（cronテスト用）

**使い方:**
```bash
curl -X POST https://zairoku.com/api/admin/test/update-billing-date \
  -H "Content-Type: application/json" \
  -H "Cookie: super-admin-session=<セッションCookie>" \
  -d '{"contract_id": "<契約ID>"}'
```

### 3. `/api/admin/test/trigger-cron`
cronジョブを手動実行

**使い方:**
```bash
curl -X POST https://zairoku.com/api/admin/test/trigger-cron \
  -H "Content-Type: application/json" \
  -H "Cookie: super-admin-session=<セッションCookie>" \
  -d '{"cron_type": "invoice"}'
```

**cron_typeの種類:**
- `invoice`: 請求書自動生成
- `plan-change`: プラン変更処理
- `email-usage`: メール使用量チェック
- `low-stock`: 在庫アラート
- `warranty`: 保証期限チェック
- `equipment`: 機器期限チェック

---

## テストシナリオ

### ✅ テスト1: 初回請求書生成とメール送信 ✅ **完了 (2025-12-30)**

**目的:** 契約完了前に初回請求書が生成され、メールが送信されることを確認

**準備:**
1. ✅ テスト用組織を作成
2. ✅ 月払い契約を作成（billing_cycle: monthly）
   - 基本プラン: スタート（10名）
   - 機能パック: 現場資産パック
   - 支払い方法: 請求書払い

**手順:**
1. ✅ 契約詳細ページから「初回請求書生成」ボタンをクリック
2. ✅ 入金管理ページまたは請求書詳細ページから「入金確認」
3. ✅ 契約詳細ページから「契約完了」ボタンをクリック

**確認項目:**
- [x] Stripeに請求書が作成されている
- [x] データベースのinvoicesテーブルに記録されている
- [x] 請求金額が正しい（初期費用 + 1ヶ月分料金）
- [x] 請求書PDFがメールで送信されている
- [x] メールの件名・本文が正しい（ザイロク表記）
- [x] PDFの内容が正しい（組織名、金額、明細、角印）
- [x] メールフッターが正しい（会社情報なし、info@zairoku.com）
- [x] 入金確認後にpayment_recordsに記録される
- [x] 契約完了後にウェルカムメールが送信される

**期待される金額:**
- 基本プラン（スタート・10名）: ¥18,000
- 現場資産パック: ¥18,000
- **小計: ¥36,000**
- **消費税（10%）: ¥3,600**
- **合計: ¥39,600**

---

### ✅ テスト2: 年払い契約の請求書生成（12倍の料金）

**目的:** 年払い契約で月額×12の金額で請求書が生成されることを確認

**準備:**
1. テスト用組織を作成
2. 年払い契約を作成（billing_cycle: annual）
   - 基本プラン: スタンダード（30名）
   - 機能パック: フル機能統合パック
   - 支払い方法: 請求書払い

**手順:**

#### 方法A: 手動請求書生成
```bash
curl -X POST https://zairoku.com/api/admin/test/generate-invoice \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<年払い契約ID>"}'
```

#### 方法B: cron経由
```bash
# 1. 開始日を1年前の今日に変更
curl -X POST https://zairoku.com/api/admin/test/update-billing-date \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<年払い契約ID>"}'

# 2. cronジョブを実行
curl -X POST https://zairoku.com/api/admin/test/trigger-cron \
  -H "Content-Type: application/json" \
  -d '{"cron_type": "invoice"}'
```

**確認項目:**
- [ ] Stripeに請求書が作成されている
- [ ] 請求金額が月額の12倍になっている
- [ ] 請求書の説明に「年払い」と記載されている
- [ ] 明細に「基本プラン（年払い）」と表示されている
- [ ] メールが送信されている

**期待される金額:**
- 基本プラン（スタンダード・30名）: ¥45,000 × 12 = ¥540,000
- フル機能統合パック: ¥32,000 × 12 = ¥384,000
- **小計: ¥924,000**
- **消費税（10%）: ¥92,400**
- **合計: ¥1,016,400**

---

### ✅ テスト3: プラン変更（アップグレード）と日割り計算

**目的:** プラン変更時に日割り差額が正しく計算され、次回請求に加算されることを確認

**準備:**
1. active状態の月払い契約を用意
   - 現在: 現場資産パック（¥18,000/月）
   - billing_day: 任意（例: 15日）

**手順:**

#### ステップ1: プラン変更実行
1. 管理画面にログイン
2. 契約詳細ページを開く
3. 「プラン変更」ボタンをクリック
4. 変更後のプラン選択: **フル機能統合パック（¥32,000/月）**
5. 変更日: 今日の日付（例: 12月29日）
6. 「プレビュー」をクリック

**確認項目（プレビュー画面）:**
- [ ] 変更前月額料金が表示されている: ¥18,000
- [ ] 変更後月額料金が表示されている: ¥32,000
- [ ] 日割り計算詳細が表示されている
  - 計算期間（例: 12/1 - 12/31、31日間）
  - 旧プラン日割り額（マイナス表示）
  - 新プラン日割り額（プラス表示）
  - 日割り差額
- [ ] 次回請求額が表示されている

**期待される計算（例: 12/29に変更、billing_day=15の場合）:**
- 請求期間: 12/1 - 12/31（31日間）
- 残り日数: 12/29 - 12/31 = 3日間
- 旧プラン日割り: -¥18,000 × 3 / 31 = -¥1,742
- 新プラン日割り: ¥32,000 × 3 / 31 = ¥3,097
- **日割り差額: ¥1,355**
- 次回請求額（1/15）: ¥32,000 + ¥1,355 = **¥33,355**

#### ステップ2: プラン変更を実行
7. 「プラン変更を実行」ボタンをクリック
8. 確認ダイアログで「OK」

**確認項目（実行後）:**
- [ ] 成功メッセージが表示される
- [ ] データベースのcontractsテーブルが更新されている
  - `pending_prorated_charge`: 日割り差額が保存されている
  - `pending_prorated_description`: 説明文が保存されている
  - `plan_change_date`: 変更日時が記録されている
  - `plan_change_type`: 'upgrade'
- [ ] contract_packagesテーブルが更新されている（新しいパッケージ）

#### ステップ3: 次回請求書生成
```bash
# 請求日を今日に変更
curl -X POST https://zairoku.com/api/admin/test/update-billing-date \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<契約ID>"}'

# 請求書を生成
curl -X POST https://zairoku.com/api/admin/test/generate-invoice \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<契約ID>"}'
```

**確認項目（請求書）:**
- [ ] 請求書に日割り差額が含まれている
- [ ] 明細に「プラン変更差額」が表示されている
- [ ] 合計金額 = 新プラン月額 + 日割り差額
- [ ] 請求書生成後、`pending_prorated_charge`が0にクリアされている

---

### ✅ テスト4: プラン変更（ダウングレード）

**目的:** ダウングレード時の動作を確認

**準備:**
1. active状態の月払い契約を用意
   - 現在: フル機能統合パック（¥32,000/月）

**手順:**

#### ステップ1: プラン変更実行
1. プラン変更画面を開く
2. 変更後のプラン選択: **現場資産パック（¥18,000/月）**
3. 変更日: 今日の日付
4. 「プレビュー」をクリック

**確認項目（プレビュー）:**
- [ ] 日割り差額がマイナス表示されている
- [ ] 次回請求額 = 新プラン月額 + 日割り差額（マイナス）

**期待される計算（例: 12/29に変更、残り3日）:**
- 旧プラン日割り: -¥32,000 × 3 / 31 = -¥3,097
- 新プラン日割り: ¥18,000 × 3 / 31 = ¥1,742
- **日割り差額: -¥1,355**
- 次回請求額: ¥18,000 - ¥1,355 = **¥16,645**

#### ステップ2: プラン変更を実行
5. 「プラン変更を実行」をクリック

**確認項目:**
- [ ] ダウングレードの場合、`pending_prorated_charge`はマイナス値として保存される
- [ ] `plan_change_type`: 'downgrade'

#### ステップ3: 次回請求書生成
```bash
# 請求書を生成
curl -X POST https://zairoku.com/api/admin/test/generate-invoice \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<契約ID>"}'
```

**確認項目:**
- [ ] 請求書の合計金額が減額されている
- [ ] 明細にマイナスの日割り差額が表示されている

---

### ✅ テスト5: カード決済の自動実行

**目的:** カード払い契約で自動決済が実行されることを確認

**準備:**
1. テスト用組織を作成
2. 月払い契約を作成
   - 支払い方法: **カード決済**
   - Stripeのテストカードを登録

**手順:**
```bash
# 請求書を生成（カード決済自動実行）
curl -X POST https://zairoku.com/api/admin/test/generate-invoice \
  -H "Content-Type: application/json" \
  -d '{"contract_id": "<カード払い契約ID>"}'
```

**確認項目:**
- [ ] Stripeで自動的に決済が実行されている
- [ ] 請求書のステータスが'paid'になっている
- [ ] データベースのinvoicesテーブルのstatusが'paid'
- [ ] メールは送信されない（カード決済の場合）

---

## テスト実行チェックリスト

### 事前準備
- [x] 本番環境にデプロイ済み ✅
- [x] データベースマイグレーション実行済み ✅
- [x] テスト用組織を2-3個作成 ✅
- [x] テスト用メールアドレスを用意 ✅

### 実行順序
1. [x] **テスト1: 初回請求書生成（契約完了フロー）** ✅ **完了**
2. [ ] テスト2: 年払い請求書生成
3. [ ] テスト3: アップグレード
4. [ ] テスト4: ダウングレード
5. [ ] テスト5: カード決済
6. [ ] テスト6: 月次請求書自動生成（cron）

### テスト後の確認
- [x] Stripeダッシュボードで請求書を確認 ✅
- [x] Supabaseダッシュボードでデータを確認 ✅
- [x] メール受信ボックスを確認 ✅
- [x] PDFの内容を確認 ✅

---

## トラブルシューティング

### 請求書が生成されない
1. 契約のステータスが'active'か確認
2. `stripe_customer_id`が設定されているか確認
3. ログを確認（`/admin/logs`）

### メールが届かない
1. メールアドレスが正しく設定されているか確認
2. Resend APIキーが設定されているか確認
3. 迷惑メールフォルダを確認

### 日割り計算が合わない
1. 請求期間が正しいか確認
2. プレビューAPIのレスポンスを確認
3. 手動で計算して検証

---

## 注意事項

### テスト用APIの扱い
- ✅ リリース後も削除しない（管理者専用）
- ✅ スーパー管理者のみアクセス可能
- ✅ 本番環境で緊急時の手動請求に使用可能
- ⚠️ テスト実行時はログを確認すること
- ⚠️ 本番顧客データでテストしない

### テストデータのクリーンアップ
テスト後、以下をクリーンアップ:
- テスト用組織の削除
- テスト請求書の削除（Stripe + DB）
- テスト用契約の削除

---

## 完了条件

すべてのテストシナリオで以下を確認:
- [ ] 請求書が正しく生成される
- [ ] 金額計算が正確
- [ ] メールが正しく送信される
- [ ] データベースに正しく記録される
- [ ] エラーが発生しない
- [ ] ログに異常がない

テスト完了後、本番リリース可能。
