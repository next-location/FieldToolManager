# お問い合わせフォーム セキュリティテストガイド

## 📋 テスト項目一覧

このガイドでは、お問い合わせフォームのセキュリティ機能をテストします。

### ✅ 実装済みのセキュリティ機能
1. **レート制限** - 5分間に3回まで（✅ テスト完了）
2. **HTMLエスケープ** - HTMLインジェクション対策
3. **メールアドレス検証** - 不正な形式の拒否
4. **電話番号検証** - 不正な文字の拒否
5. **不審パターン検出** - 攻撃コードの検出

---

## 🧪 テスト手順

### 準備
1. https://zairoku.com/contact にアクセス
2. ブラウザの開発者ツールを開く（F12キー）
3. 「Console」タブを開いておく（エラー確認用）

---

## テスト 1: HTMLエスケープ ✅

### 目的
HTMLタグやスクリプトが実行されず、安全にエスケープされることを確認

### テストケース1-1: `<script>`タグ

**入力内容**:
- 会社名: `テスト株式会社`
- お名前: `山田太郎`
- メールアドレス: `test@example.com`
- お問い合わせ種別: `サービスに関する質問`
- お問い合わせ内容: `<script>alert('XSS')</script>これはテストです`

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**不正な入力が検出されました**」

**確認ポイント**:
- ✅ フォームが送信されない
- ✅ エラーメッセージが表示される
- ✅ アラートが表示されない（スクリプトが実行されない）

---

### テストケース1-2: HTMLタグ（`<img>`など）

**入力内容**:
- 会社名: `<img src=x onerror="alert('XSS')">`
- お名前: `山田太郎`
- メールアドレス: `test@example.com`
- お問い合わせ種別: `サービスに関する質問`
- お問い合わせ内容: `こんにちは`

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**不正な入力が検出されました**」

---

### テストケース1-3: `javascript:` プロトコル

**入力内容**:
- 会社名: `テスト株式会社`
- お名前: `山田太郎`
- メールアドレス: `test@example.com`
- お問い合わせ種別: `サービスに関する質問`
- お問い合わせ内容: `こちらをクリック: javascript:alert('test')`

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**不正な入力が検出されました**」

---

### テストケース1-4: イベントハンドラー

**入力内容**:
- 会社名: `テスト株式会社`
- お名前: `<div onclick="alert('XSS')">山田太郎</div>`
- メールアドレス: `test@example.com`
- お問い合わせ種別: `サービスに関する質問`
- お問い合わせ内容: `こんにちは`

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**不正な入力が検出されました**」

---

### テストケース1-5: 正常な入力（HTMLタグなし）

**入力内容**:
- 会社名: `テスト株式会社`
- お名前: `山田太郎`
- メールアドレス: `test@example.com`
- お問い合わせ種別: `サービスに関する質問`
- お問い合わせ内容: `ザイロクの料金プランについて教えてください`

**期待される動作**:
- ✅ **送信が成功する**
- 成功メッセージ: 「お問い合わせを受け付けました」
- 自動返信メールが届く

**確認ポイント**:
- ✅ メールの内容が正しく表示される
- ✅ HTMLタグが含まれていない（安全）

---

## テスト 2: メールアドレス検証 ✅

### 目的
不正な形式のメールアドレスを拒否することを確認

### テストケース2-1: `@`なし

**入力内容**:
- メールアドレス: `testexample.com`（@なし）

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**有効なメールアドレスを入力してください**」

---

### テストケース2-2: ドメインなし

**入力内容**:
- メールアドレス: `test@`（ドメインなし）

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**有効なメールアドレスを入力してください**」

---

### テストケース2-3: スペース含む

**入力内容**:
- メールアドレス: `test @example.com`（スペース含む）

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**有効なメールアドレスを入力してください**」

---

### テストケース2-4: 正常なメールアドレス

**入力内容**:
- メールアドレス: `test@example.com`

**期待される動作**:
- ✅ **検証を通過**（他の項目も正しければ送信成功）

---

## テスト 3: 電話番号検証 ✅

### 目的
不正な文字を含む電話番号を拒否することを確認

### テストケース3-1: 文字を含む

**入力内容**:
- 電話番号: `あいうえお`

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**有効な電話番号を入力してください**」

---

### テストケース3-2: 特殊記号を含む

**入力内容**:
- 電話番号: `03-1234-5678#999`（#が不正）

**期待される動作**:
- ❌ **送信が拒否される**
- エラーメッセージ: 「**有効な電話番号を入力してください**」

---

### テストケース3-3: 正常な電話番号（ハイフンあり）

**入力内容**:
- 電話番号: `03-1234-5678`

**期待される動作**:
- ✅ **検証を通過**

---

### テストケース3-4: 正常な電話番号（ハイフンなし）

**入力内容**:
- 電話番号: `09012345678`

**期待される動作**:
- ✅ **検証を通過**

---

### テストケース3-5: 空欄（任意項目）

**入力内容**:
- 電話番号: （空欄）

**期待される動作**:
- ✅ **検証を通過**（電話番号は任意項目）

---

## テスト 4: 複合テスト ✅

### テストケース4-1: 複数の不正入力

**入力内容**:
- 会社名: `<script>alert('test')</script>`
- お名前: `山田太郎`
- メールアドレス: `invalid-email`
- 電話番号: `あいうえお`
- お問い合わせ内容: `javascript:alert('xss')`

**期待される動作**:
- ❌ **送信が拒否される**
- 最初に検出された不正入力のエラーが表示される

---

## 📊 テスト結果チェックリスト

### HTMLエスケープ（不審パターン検出）
- [ ] `<script>`タグが拒否される
- [ ] `<img>`タグが拒否される
- [ ] `javascript:`が拒否される
- [ ] イベントハンドラー（`onclick`等）が拒否される
- [ ] 正常な入力が送信できる

### メールアドレス検証
- [ ] `@`なしが拒否される
- [ ] ドメインなしが拒否される
- [ ] スペース含みが拒否される
- [ ] 正常なメールアドレスが通過する

### 電話番号検証
- [ ] 文字（ひらがな・カタカナ）が拒否される
- [ ] 不正な特殊記号が拒否される
- [ ] 正常な電話番号（ハイフンあり）が通過する
- [ ] 正常な電話番号（ハイフンなし）が通過する
- [ ] 空欄が通過する（任意項目）

### レート制限（既にテスト済み）
- [x] 5分間に3回まで送信可能
- [x] 4回目でエラー表示

---

## 🔍 メール受信確認（重要）

### 管理者メール確認（info@zairoku.com）

正常に送信した後、受信メールを確認：

1. **件名**: 「【ザイロク】新規お問い合わせ - [会社名]」
2. **本文**: HTMLタグがエスケープされているか確認
   - 例: `<script>`は`&lt;script&gt;`として表示される
   - 例: `&`は`&amp;`として表示される

### 自動返信メール確認（送信者のメールアドレス）

1. **件名**: 「【ザイロク】お問い合わせを受け付けました」
2. **本文**: 入力内容が正しく表示されているか確認
3. **HTMLエスケープ**: 特殊文字が安全に表示されているか確認

---

## 🚨 エラーが出た場合のトラブルシューティング

### 問題1: 正常な入力なのにエラーが出る

**原因**: 不審パターン検出が厳しすぎる可能性

**確認方法**:
1. ブラウザのコンソール（F12）でエラーメッセージを確認
2. どのパターンに引っかかったか確認

**報告内容**:
- 入力した内容（全項目）
- 表示されたエラーメッセージ
- ブラウザのコンソールのエラー

---

### 問題2: 不正な入力が送信できてしまう

**原因**: バリデーションをすり抜けた可能性（要修正）

**報告内容**:
- 入力した内容（特に不正な部分）
- 送信が成功してしまった
- 受信メールのスクリーンショット

---

## 📝 テスト完了後の報告フォーマット

```
# セキュリティテスト結果

## テスト日時
2026年1月XX日 XX:XX

## テスト環境
- URL: https://zairoku.com/contact
- ブラウザ: Chrome/Safari/Firefox

## テスト結果
### HTMLエスケープ
- [✅/❌] <script>タグの拒否
- [✅/❌] <img>タグの拒否
- [✅/❌] javascript:の拒否
- [✅/❌] イベントハンドラーの拒否
- [✅/❌] 正常入力の送信

### メールアドレス検証
- [✅/❌] 不正形式の拒否
- [✅/❌] 正常メールの通過

### 電話番号検証
- [✅/❌] 文字の拒否
- [✅/❌] 正常番号の通過

### レート制限
- [✅] 5分間に3回制限（テスト済み）

## 問題点
（あれば記載）

## 備考
（その他気づいた点）
```

---

## ⚡ クイックテストセット（5分で完了）

時間がない場合は、以下の3つだけテスト：

### 1. `<script>`タグテスト
お問い合わせ内容に `<script>alert('test')</script>` を入力
→ 「不正な入力が検出されました」が表示されればOK ✅

### 2. 不正メールアドレステスト
メールアドレスに `test@` を入力
→ 「有効なメールアドレスを入力してください」が表示されればOK ✅

### 3. 不正電話番号テスト
電話番号に `あいうえお` を入力
→ 「有効な電話番号を入力してください」が表示されればOK ✅

---

すべて✅になれば、セキュリティ機能は正常に動作しています！🎉
