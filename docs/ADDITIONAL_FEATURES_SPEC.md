# è¿½åŠ é–‹ç™ºæ©Ÿèƒ½ä»•æ§˜æ›¸

> **å¯¾è±¡**: ãƒªãƒªãƒ¼ã‚¹å¾Œã®æ®µéšçš„è¿½åŠ æ©Ÿèƒ½
> **ç›®çš„**: ç¾å ´ç³»ä¼æ¥­ã®DXåŒ–ã‚’åŠ é€Ÿã—ã€å·¥å…·ç®¡ç†ã‹ã‚‰ç·åˆæ¥­å‹™ç®¡ç†ã¸æ‹¡å¼µ
> **ä½œæˆæ—¥**: 2025-11-29

---

## ğŸ“‹ æ©Ÿèƒ½ä¸€è¦§ã¨å„ªå…ˆåº¦

| æ©Ÿèƒ½å | å„ªå…ˆåº¦ | æ¨å¥¨æ™‚æœŸ | ä¾¡å€¤ |
|--------|--------|----------|------|
| ä½œæ¥­å ±å‘Š | â­â­â­â­â­ | 3ãƒ¶æœˆå¾Œ | å ±å‘Šæ›¸ä½œæˆã®æ‰‹é–“å‰Šæ¸›ã€å·¥å…·ä½¿ç”¨å±¥æ­´ã®è‡ªå‹•åŒ– |
| å‡ºé€€å‹¤ç®¡ç† | â­â­â­â­â­ | 3ãƒ¶æœˆå¾Œ | ç›´è¡Œç›´å¸°å¯¾å¿œã€å·¥å…·æŒå‡ºã¨ã®é€£æº |
| è³‡æç™ºæ³¨ãƒ»åœ¨åº«ç®¡ç† | â­â­â­â­â­ | 6ãƒ¶æœˆå¾Œ | å·¥å…·+è³‡æã®ä¸€å…ƒç®¡ç† |
| è«‹æ±‚æ›¸ä½œæˆ | â­â­â­â­â­ | 6ãƒ¶æœˆå¾Œ | ä½œæ¥­å ±å‘Šã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ |
| å®šæœŸç‚¹æ¤œãƒ»æ ¡æ­£æœŸé™ç®¡ç† | â­â­â­â­â­ | 3ãƒ¶æœˆå¾Œ | ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¼·åŒ– |
| ç¾å ´æŒ‡ç¤ºç®¡ç† | â­â­â­â­ | 6ãƒ¶æœˆå¾Œ | ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¹åŒ– |
| è»Šä¸¡ãƒ»é‡æ©Ÿç®¡ç† | â­â­â­â­ | 6ãƒ¶æœˆå¾Œ | å·¥å…·ã¨è»Šä¸¡ã®çµ±åˆç®¡ç† |
| é¡§å®¢ãƒ»ç¾å ´æƒ…å ±ç®¡ç† | â­â­â­â­ | 1å¹´å¾Œ | æ–½å·¥å±¥æ­´ã®è“„ç© |
| è¦‹ç©ã‚‚ã‚Šä½œæˆ | â­â­â­â­ | 1å¹´å¾Œ | å—æ³¨ã‹ã‚‰è«‹æ±‚ã¾ã§ä¸€å…ƒåŒ– |
| å®‰å…¨ç®¡ç†ãƒ»KYæ´»å‹•è¨˜éŒ² | â­â­â­â­ | 1å¹´å¾Œ | åŠ´ç½é˜²æ­¢ã€ISOå¯¾å¿œ |
| ã‚¹ã‚¿ãƒƒãƒ•è³‡æ ¼ãƒ»å…è¨±ç®¡ç† | â­â­â­â­ | 1å¹´å¾Œ | é©æé©æ‰€ã®äººå“¡é…ç½® |

---

## 1. ä½œæ¥­å ±å‘Šæ©Ÿèƒ½

### æ¦‚è¦
ç¾å ´ã§ã®ä½œæ¥­å®Œäº†å¾Œã€ãã®å ´ã§å†™çœŸä»˜ãå ±å‘Šæ›¸ã‚’ä½œæˆã€‚ä½¿ç”¨ã—ãŸå·¥å…·ãƒªã‚¹ãƒˆã‚’è‡ªå‹•çš„ã«æ·»ä»˜ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- å ±å‘Šæ›¸ä½œæˆã®ãŸã‚ã«äº‹å‹™æ‰€ã«æˆ»ã‚‹å¿…è¦ãŒã‚ã‚‹
- ä½¿ç”¨å·¥å…·ã®è¨˜éŒ²ãŒæ‰‹å‹•ã§æ¼ã‚Œã‚„ã™ã„
- æ–½å·¥å†™çœŸã¨å ±å‘Šæ›¸ãŒåˆ¥ç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- ä½œæ¥­å ±å‘Šãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE work_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  site_id UUID REFERENCES sites(id),
  created_by UUID NOT NULL REFERENCES users(id),

  -- åŸºæœ¬æƒ…å ±
  report_date DATE NOT NULL,
  work_type TEXT NOT NULL, -- å¡—è£…ã€é›»æ°—å·¥äº‹ã€é…ç®¡ç­‰
  work_description TEXT NOT NULL,

  -- ä½œæ¥­å†…å®¹
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  worker_count INTEGER,

  -- é€²æ—
  progress_percentage INTEGER DEFAULT 0,
  next_steps TEXT,
  issues TEXT, -- å•é¡Œç‚¹ãƒ»èª²é¡Œ

  -- å¤©å€™
  weather TEXT, -- æ™´ã‚Œã€é›¨ã€æ›‡ã‚Šç­‰
  temperature DECIMAL(3,1),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'draft', -- draft, submitted, approved
  submitted_at TIMESTAMP,
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  custom_fields JSONB DEFAULT '{}',
  deleted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ä½œæ¥­å ±å‘Šã«æ·»ä»˜ã•ã‚ŒãŸå†™çœŸ
CREATE TABLE work_report_photos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  work_report_id UUID NOT NULL REFERENCES work_reports(id),
  photo_url TEXT NOT NULL,
  caption TEXT,
  taken_at TIMESTAMP,
  gps_latitude DECIMAL(10, 8),
  gps_longitude DECIMAL(11, 8),
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ä½œæ¥­å ±å‘Šã§ä½¿ç”¨ã—ãŸå·¥å…·ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå±¥æ­´ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰
CREATE TABLE work_report_tools (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  work_report_id UUID NOT NULL REFERENCES work_reports(id),
  tool_id UUID NOT NULL REFERENCES tools(id),
  checkout_id UUID REFERENCES checkouts(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ä½œæ¥­å ±å‘Šã§ä½¿ç”¨ã—ãŸè³‡æ
CREATE TABLE work_report_materials (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  work_report_id UUID NOT NULL REFERENCES work_reports(id),
  material_id UUID REFERENCES materials(id),
  material_name TEXT NOT NULL,
  quantity DECIMAL(10,2) NOT NULL,
  unit TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### æ©Ÿèƒ½è©³ç´°

#### å ±å‘Šæ›¸ä½œæˆãƒ•ãƒ­ãƒ¼
```typescript
// 1. ãã®æ—¥ã®å·¥å…·ä½¿ç”¨å±¥æ­´ã‚’è‡ªå‹•å–å¾—
const getToolsUsedToday = async (userId: string, siteId: string, date: Date) => {
  const { data: checkouts } = await supabase
    .from('checkouts')
    .select(`
      *,
      tool:tools(*)
    `)
    .eq('user_id', userId)
    .eq('site_id', siteId)
    .gte('checked_out_at', startOfDay(date))
    .lte('checked_out_at', endOfDay(date));

  return checkouts.map(c => c.tool);
};

// 2. å†™çœŸã«ä½ç½®æƒ…å ±ãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’åŸ‹ã‚è¾¼ã¿
const addPhotoMetadata = async (photo: File) => {
  const location = await getCurrentLocation();
  return {
    file: photo,
    taken_at: new Date(),
    gps_latitude: location.latitude,
    gps_longitude: location.longitude
  };
};

// 3. å ±å‘Šæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
interface WorkReportTemplate {
  title: string; // ã€Œã€‡ã€‡é‚¸ å¤–å£å¡—è£…å·¥äº‹ã€
  sections: Array<{
    type: 'text' | 'photo' | 'tool_list' | 'material_list';
    content: any;
  }>;
}
```

#### UI/UXè¨­è¨ˆ
```typescript
// components/WorkReportForm.tsx
export default function WorkReportForm() {
  return (
    <div className="space-y-6">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div>
        <h1 className="text-2xl font-bold">ä½œæ¥­å ±å‘Šæ›¸ä½œæˆ</h1>
        <p className="text-gray-600">ç¾å ´: {site.name}</p>
        <p className="text-gray-600">æ—¥ä»˜: {format(today, 'yyyyå¹´MMæœˆddæ—¥')}</p>
      </div>

      {/* åŸºæœ¬æƒ…å ± */}
      <div className="grid grid-cols-2 gap-4">
        <Input label="ä½œæ¥­æ™‚é–“" type="time-range" />
        <Input label="ä½œæ¥­äººæ•°" type="number" />
        <Select label="å¤©å€™" options={['æ™´ã‚Œ', 'æ›‡ã‚Š', 'é›¨']} />
        <Input label="æ°—æ¸©" type="number" suffix="â„ƒ" />
      </div>

      {/* ä½œæ¥­å†…å®¹ */}
      <Textarea
        label="æœ¬æ—¥ã®ä½œæ¥­å†…å®¹"
        placeholder="å¤–å£ã®é«˜åœ§æ´—æµ„ã‚’å®Ÿæ–½..."
      />

      {/* å†™çœŸæ·»ä»˜ */}
      <PhotoUploader
        label="æ–½å·¥å†™çœŸ"
        multiple={true}
        onUpload={handlePhotoUpload}
      />

      {/* ä½¿ç”¨å·¥å…·ï¼ˆè‡ªå‹•å–å¾—ï¼‰ */}
      <div className="border rounded-lg p-4">
        <h3 className="font-bold mb-2">ä½¿ç”¨å·¥å…·</h3>
        <p className="text-sm text-gray-600 mb-3">
          æœ¬æ—¥ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸå·¥å…·ãŒè‡ªå‹•çš„ã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™
        </p>
        <ToolList tools={toolsUsedToday} editable={true} />
      </div>

      {/* ä½¿ç”¨è³‡æ */}
      <MaterialUsageForm />

      {/* æå‡ºãƒœã‚¿ãƒ³ */}
      <Button variant="primary">å ±å‘Šæ›¸ã‚’æå‡º</Button>
    </div>
  );
}
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬æ©Ÿèƒ½: 30ä¸‡å††
- å†™çœŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ©Ÿèƒ½: 10ä¸‡å††
- PDFå‡ºåŠ›æ©Ÿèƒ½: 10ä¸‡å††
- **åˆè¨ˆ: 50ä¸‡å††**

---

## 2. å‡ºé€€å‹¤ç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
å·¥å…·ç®¡ç†ã¨é€£å‹•ã—ãŸå‡ºé€€å‹¤ç®¡ç†ã€‚ç›´è¡Œç›´å¸°ã«å¯¾å¿œã—ã€ç¾å ´åˆ°ç€æ™‚ã®æ‰“åˆ»ã¨å·¥å…·æŒå‡ºã‚’åŒæ™‚ã«è¨˜éŒ²ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- ç›´è¡Œç›´å¸°ã®å‹¤æ€ ç®¡ç†ãŒå›°é›£
- èª°ãŒã©ã®ç¾å ´ã«ã„ã‚‹ã‹ä¸æ˜
- å·¥å…·æŒå‡ºã¨å‡ºå‹¤ã®äºŒé‡ç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- å‹¤æ€ è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE attendances (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  user_id UUID NOT NULL REFERENCES users(id),

  -- å‡ºå‹¤æƒ…å ±
  clock_in_time TIMESTAMP NOT NULL,
  clock_in_location_id UUID REFERENCES locations(id),
  clock_in_gps_latitude DECIMAL(10, 8),
  clock_in_gps_longitude DECIMAL(11, 8),
  clock_in_method TEXT, -- 'qr', 'manual', 'gps'

  -- é€€å‹¤æƒ…å ±
  clock_out_time TIMESTAMP,
  clock_out_location_id UUID REFERENCES locations(id),
  clock_out_gps_latitude DECIMAL(10, 8),
  clock_out_gps_longitude DECIMAL(11, 8),
  clock_out_method TEXT,

  -- å‹¤å‹™æƒ…å ±
  scheduled_hours DECIMAL(4,2),
  actual_hours DECIMAL(4,2),
  overtime_hours DECIMAL(4,2),
  break_minutes INTEGER DEFAULT 0,

  -- ç¾å ´æƒ…å ±
  primary_site_id UUID REFERENCES sites(id),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'working', -- working, completed, approved
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,
  notes TEXT,

  -- é€£æº
  linked_checkouts UUID[], -- åŒæ™‚ã«æŒã¡å‡ºã—ãŸå·¥å…·

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ä¼‘æ†©è¨˜éŒ²
CREATE TABLE break_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  attendance_id UUID NOT NULL REFERENCES attendances(id),
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  break_type TEXT, -- 'lunch', 'rest'
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç¾å ´ç§»å‹•è¨˜éŒ²
CREATE TABLE site_movements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  attendance_id UUID NOT NULL REFERENCES attendances(id),
  from_site_id UUID REFERENCES sites(id),
  to_site_id UUID REFERENCES sites(id),
  moved_at TIMESTAMP NOT NULL,
  reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### æ©Ÿèƒ½è©³ç´°

#### å‡ºå‹¤ãƒ•ãƒ­ãƒ¼
```typescript
// å‡ºå‹¤ + å·¥å…·æŒå‡ºã®çµ±åˆå‡¦ç†
const clockInWithTools = async (data: {
  userId: string;
  siteId: string;
  toolIds: string[];
  location: GeolocationCoordinates;
}) => {
  const { userId, siteId, toolIds, location } = data;

  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
  const { data: attendance, error } = await supabase.rpc('clock_in_with_tools', {
    p_user_id: userId,
    p_site_id: siteId,
    p_tool_ids: toolIds,
    p_latitude: location.latitude,
    p_longitude: location.longitude
  });

  // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
  await sendNotification({
    to: 'managers',
    title: 'å‡ºå‹¤é€šçŸ¥',
    body: `${user.name}ã•ã‚“ãŒ${site.name}ã«å‡ºå‹¤ã—ã¾ã—ãŸ`
  });

  return attendance;
};
```

#### å‹¤æ€ é›†è¨ˆ
```typescript
// æœˆæ¬¡å‹¤æ€ é›†è¨ˆ
const getMonthlyAttendanceSummary = async (userId: string, month: Date) => {
  const startDate = startOfMonth(month);
  const endDate = endOfMonth(month);

  const { data: attendances } = await supabase
    .from('attendances')
    .select('*')
    .eq('user_id', userId)
    .gte('clock_in_time', startDate)
    .lte('clock_in_time', endDate);

  return {
    totalDays: attendances.length,
    totalHours: sum(attendances.map(a => a.actual_hours)),
    overtimeHours: sum(attendances.map(a => a.overtime_hours)),
    sites: groupBy(attendances, 'primary_site_id')
  };
};
```

#### UI/UXè¨­è¨ˆ
```typescript
// components/ClockInScreen.tsx
export default function ClockInScreen() {
  return (
    <div className="min-h-screen bg-gray-50 p-4">
      {/* ç¾åœ¨æ™‚åˆ» */}
      <div className="text-center mb-6">
        <p className="text-4xl font-bold">{currentTime}</p>
        <p className="text-gray-600">{currentDate}</p>
      </div>

      {/* å‡ºå‹¤ãƒœã‚¿ãƒ³ï¼ˆå¤§ããï¼‰ */}
      <button className="w-full py-8 bg-green-600 text-white text-2xl font-bold rounded-lg">
        å‡ºå‹¤ã™ã‚‹
      </button>

      {/* ç¾å ´é¸æŠ */}
      <Select
        label="æœ¬æ—¥ã®ç¾å ´"
        options={sites}
        className="mt-4"
      />

      {/* æŒå‡ºå·¥å…·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */}
      <div className="mt-6 p-4 border rounded-lg">
        <h3 className="font-bold mb-2">å·¥å…·ã‚‚ä¸€ç·’ã«æŒã¡å‡ºã™</h3>
        <button className="text-blue-600">
          QRã‚¹ã‚­ãƒ£ãƒ³ or å·¥å…·é¸æŠ
        </button>
      </div>

      {/* ç›´è¡Œç›´å¸°ãƒ¢ãƒ¼ãƒ‰ */}
      <div className="mt-4 flex items-center">
        <input type="checkbox" id="direct" />
        <label htmlFor="direct" className="ml-2">
          ç¾å ´ã¸ç›´è¡Œ
        </label>
      </div>
    </div>
  );
}
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬å‹¤æ€ æ©Ÿèƒ½: 40ä¸‡å††
- GPSæ‰“åˆ»æ©Ÿèƒ½: 10ä¸‡å††
- å·¥å…·é€£æºæ©Ÿèƒ½: 10ä¸‡å††
- å‹¤æ€ é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ: 20ä¸‡å††
- **åˆè¨ˆ: 80ä¸‡å††**

---

## 3. è³‡æç™ºæ³¨ãƒ»åœ¨åº«ç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
æ¶ˆè€—å“ãƒ»è³‡æã®åœ¨åº«ç®¡ç†ã¨ç™ºæ³¨ã‚’åŠ¹ç‡åŒ–ã€‚æœ€ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆã€ç¾å ´ã¸ã®ç›´é€æ‰‹é…ã‚‚å¯èƒ½ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- è³‡æä¸è¶³ã«ã‚ˆã‚‹ä½œæ¥­ä¸­æ–­
- éå‰°åœ¨åº«ã«ã‚ˆã‚‹è³‡é‡‘åœ§è¿«
- ç™ºæ³¨å±¥æ­´ãŒä¸æ˜ç­

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- è³‡æãƒã‚¹ã‚¿
CREATE TABLE materials (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- åŸºæœ¬æƒ…å ±
  material_code TEXT NOT NULL,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  manufacturer TEXT,
  model_number TEXT,

  -- åœ¨åº«ç®¡ç†
  current_stock DECIMAL(10,2) NOT NULL DEFAULT 0,
  unit TEXT NOT NULL, -- å€‹ã€æœ¬ã€kgã€Lç­‰
  minimum_stock DECIMAL(10,2),
  reorder_point DECIMAL(10,2),
  reorder_quantity DECIMAL(10,2),

  -- ä¾¡æ ¼æƒ…å ±
  unit_price DECIMAL(10,2),
  supplier_id UUID REFERENCES suppliers(id),

  -- ä¿ç®¡å ´æ‰€
  default_location_id UUID REFERENCES locations(id),

  custom_fields JSONB DEFAULT '{}',
  deleted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ä»•å…¥å…ˆãƒã‚¹ã‚¿
CREATE TABLE suppliers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  name TEXT NOT NULL,
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,
  payment_terms TEXT,
  delivery_lead_time INTEGER, -- æ—¥æ•°
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç™ºæ³¨å±¥æ­´
CREATE TABLE purchase_orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  order_number TEXT NOT NULL,
  supplier_id UUID REFERENCES suppliers(id),

  -- ç™ºæ³¨æƒ…å ±
  ordered_by UUID NOT NULL REFERENCES users(id),
  order_date DATE NOT NULL,
  expected_delivery_date DATE,
  delivery_site_id UUID REFERENCES sites(id),

  -- é‡‘é¡
  subtotal DECIMAL(10,2),
  tax_amount DECIMAL(10,2),
  total_amount DECIMAL(10,2),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'pending', -- pending, ordered, partial, completed, cancelled

  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç™ºæ³¨æ˜ç´°
CREATE TABLE purchase_order_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  purchase_order_id UUID NOT NULL REFERENCES purchase_orders(id),
  material_id UUID REFERENCES materials(id),

  -- ç™ºæ³¨å†…å®¹
  material_name TEXT NOT NULL,
  quantity DECIMAL(10,2) NOT NULL,
  unit TEXT NOT NULL,
  unit_price DECIMAL(10,2),
  total_price DECIMAL(10,2),

  -- ç´å“çŠ¶æ³
  received_quantity DECIMAL(10,2) DEFAULT 0,
  received_date DATE,

  created_at TIMESTAMP DEFAULT NOW()
);

-- åœ¨åº«ç§»å‹•å±¥æ­´
CREATE TABLE stock_movements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  material_id UUID NOT NULL REFERENCES materials(id),
  movement_type TEXT NOT NULL, -- 'in', 'out', 'transfer', 'adjustment'
  quantity DECIMAL(10,2) NOT NULL,

  -- ç§»å‹•å…ƒãƒ»å…ˆ
  from_location_id UUID REFERENCES locations(id),
  to_location_id UUID REFERENCES locations(id),

  -- é–¢é€£æƒ…å ±
  work_report_id UUID REFERENCES work_reports(id),
  purchase_order_id UUID REFERENCES purchase_orders(id),

  -- è¨˜éŒ²è€…
  recorded_by UUID NOT NULL REFERENCES users(id),
  reason TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);
```

### æ©Ÿèƒ½è©³ç´°

#### è‡ªå‹•ç™ºæ³¨ææ¡ˆ
```typescript
// æœ€ä½åœ¨åº«ã‚’ä¸‹å›ã£ãŸè³‡æã‚’æ¤œå‡º
const checkLowStock = async () => {
  const { data: lowStockItems } = await supabase
    .from('materials')
    .select('*')
    .lt('current_stock', 'minimum_stock');

  // ç™ºæ³¨ææ¡ˆã‚’ç”Ÿæˆ
  const suggestions = lowStockItems.map(item => ({
    material: item,
    suggestedQuantity: item.reorder_quantity || (item.minimum_stock * 2),
    urgency: item.current_stock === 0 ? 'critical' : 'normal',
    estimatedCost: item.unit_price * item.reorder_quantity
  }));

  return suggestions;
};

// ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ç™ºæ³¨
const quickOrder = async (materialId: string, siteId?: string) => {
  const { data: material } = await supabase
    .from('materials')
    .select('*, supplier:suppliers(*)')
    .eq('id', materialId)
    .single();

  // ç™ºæ³¨æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ
  const order = await createPurchaseOrder({
    supplier_id: material.supplier_id,
    items: [{
      material_id: materialId,
      quantity: material.reorder_quantity,
      unit_price: material.unit_price
    }],
    delivery_site_id: siteId || material.default_location_id
  });

  // ãƒ¡ãƒ¼ãƒ«ã§ç™ºæ³¨æ›¸é€ä¿¡
  await sendOrderEmail(order, material.supplier);

  return order;
};
```

#### UI/UXè¨­è¨ˆ
```typescript
// components/MaterialStockDashboard.tsx
export default function MaterialStockDashboard() {
  return (
    <div className="space-y-6">
      {/* åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ */}
      <Alert variant="warning">
        <AlertTitle>åœ¨åº«ä¸è¶³ã‚¢ãƒ©ãƒ¼ãƒˆ</AlertTitle>
        <AlertDescription>
          ä»¥ä¸‹ã®è³‡æãŒæœ€ä½åœ¨åº«ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™
        </AlertDescription>
        <div className="mt-2 space-y-2">
          {lowStockItems.map(item => (
            <div key={item.id} className="flex justify-between items-center">
              <span>{item.name}: æ®‹ã‚Š{item.current_stock}{item.unit}</span>
              <Button size="sm" onClick={() => quickOrder(item.id)}>
                ç™ºæ³¨ã™ã‚‹
              </Button>
            </div>
          ))}
        </div>
      </Alert>

      {/* åœ¨åº«ä¸€è¦§ */}
      <DataTable
        columns={[
          { header: 'è³‡æå', accessor: 'name' },
          { header: 'åœ¨åº«æ•°', accessor: 'current_stock' },
          { header: 'æœ€ä½åœ¨åº«', accessor: 'minimum_stock' },
          { header: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', accessor: 'status' }
        ]}
        data={materials}
      />

      {/* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
      <div className="grid grid-cols-2 gap-4">
        <Button variant="primary">æ–°è¦ç™ºæ³¨</Button>
        <Button variant="secondary">åœ¨åº«èª¿æ•´</Button>
      </div>
    </div>
  );
}
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬åœ¨åº«ç®¡ç†: 40ä¸‡å††
- ç™ºæ³¨ç®¡ç†: 30ä¸‡å††
- è‡ªå‹•ç™ºæ³¨ææ¡ˆ: 20ä¸‡å††
- ä»•å…¥å…ˆç®¡ç†: 10ä¸‡å††
- **åˆè¨ˆ: 100ä¸‡å††**

---

## 4. è«‹æ±‚æ›¸ä½œæˆæ©Ÿèƒ½

### æ¦‚è¦
ä½œæ¥­å ±å‘Šã‹ã‚‰è‡ªå‹•çš„ã«è«‹æ±‚æ›¸ã‚’ç”Ÿæˆã€‚ä½¿ç”¨ã—ãŸå·¥å…·ãƒ»è³‡æãƒ»ä½œæ¥­æ™‚é–“ã‚’å…ƒã«è«‹æ±‚é¡ã‚’è¨ˆç®—ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- è«‹æ±‚æ›¸ä½œæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹
- ä½œæ¥­å†…å®¹ã¨è«‹æ±‚å†…å®¹ã®ä¸ä¸€è‡´
- è«‹æ±‚æ¼ã‚Œã®ç™ºç”Ÿ

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- è«‹æ±‚æ›¸ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- è«‹æ±‚å…ˆ
  client_id UUID REFERENCES clients(id),
  client_name TEXT NOT NULL,
  client_address TEXT,

  -- è«‹æ±‚æƒ…å ±
  invoice_number TEXT NOT NULL,
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL,

  -- å·¥äº‹æƒ…å ±
  project_id UUID REFERENCES projects(id),
  project_name TEXT,
  site_id UUID REFERENCES sites(id),

  -- é‡‘é¡
  subtotal DECIMAL(12,2) NOT NULL,
  tax_rate DECIMAL(5,2) DEFAULT 10.0,
  tax_amount DECIMAL(12,2),
  total_amount DECIMAL(12,2) NOT NULL,

  -- æ”¯æ‰•ã„çŠ¶æ³
  payment_status TEXT DEFAULT 'unpaid', -- unpaid, partial, paid
  paid_amount DECIMAL(12,2) DEFAULT 0,
  payment_date DATE,
  payment_method TEXT,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'draft', -- draft, sent, approved, cancelled
  sent_at TIMESTAMP,
  approved_by UUID REFERENCES users(id),

  -- å‚™è€ƒ
  notes TEXT,
  payment_terms TEXT,

  -- é–¢é€£ãƒ‡ãƒ¼ã‚¿
  work_report_ids UUID[], -- é–¢é€£ã™ã‚‹ä½œæ¥­å ±å‘Š

  custom_fields JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- è«‹æ±‚æ˜ç´°
CREATE TABLE invoice_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_id UUID NOT NULL REFERENCES invoices(id),

  -- é …ç›®æƒ…å ±
  item_type TEXT NOT NULL, -- 'labor', 'material', 'equipment', 'other'
  description TEXT NOT NULL,

  -- æ•°é‡ãƒ»å˜ä¾¡
  quantity DECIMAL(10,2) NOT NULL,
  unit TEXT,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(12,2) NOT NULL,

  -- é–¢é€£æƒ…å ±
  work_report_id UUID REFERENCES work_reports(id),
  material_id UUID REFERENCES materials(id),
  tool_id UUID REFERENCES tools(id),

  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- é¡§å®¢ãƒã‚¹ã‚¿
CREATE TABLE clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- åŸºæœ¬æƒ…å ±
  client_code TEXT NOT NULL,
  name TEXT NOT NULL,
  name_kana TEXT,

  -- é€£çµ¡å…ˆ
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,

  -- è«‹æ±‚æƒ…å ±
  billing_address TEXT,
  payment_terms TEXT DEFAULT 'month_end_next_month',
  payment_method TEXT DEFAULT 'bank_transfer',

  -- å–å¼•å±¥æ­´
  first_transaction_date DATE,
  total_transaction_amount DECIMAL(12,2) DEFAULT 0,

  notes TEXT,
  custom_fields JSONB DEFAULT '{}',
  deleted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- å…¥é‡‘è¨˜éŒ²
CREATE TABLE payment_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_id UUID NOT NULL REFERENCES invoices(id),

  payment_date DATE NOT NULL,
  payment_amount DECIMAL(12,2) NOT NULL,
  payment_method TEXT,

  recorded_by UUID NOT NULL REFERENCES users(id),
  notes TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);
```

### æ©Ÿèƒ½è©³ç´°

#### ä½œæ¥­å ±å‘Šã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ
```typescript
// ä½œæ¥­å ±å‘Šã‹ã‚‰è«‹æ±‚æ›¸ã‚’ç”Ÿæˆ
const createInvoiceFromWorkReports = async (
  workReportIds: string[],
  clientId: string
) => {
  // ä½œæ¥­å ±å‘Šã‚’å–å¾—
  const { data: workReports } = await supabase
    .from('work_reports')
    .select(`
      *,
      work_report_tools(tool:tools(*)),
      work_report_materials(*)
    `)
    .in('id', workReportIds);

  // è«‹æ±‚é …ç›®ã‚’ç”Ÿæˆ
  const invoiceItems = [];

  // 1. ä½œæ¥­è²»
  workReports.forEach(report => {
    const hours = calculateHours(report.start_time, report.end_time);
    invoiceItems.push({
      item_type: 'labor',
      description: `${report.work_type} - ${format(report.report_date, 'MMæœˆddæ—¥')}`,
      quantity: hours,
      unit: 'æ™‚é–“',
      unit_price: 5000, // æ™‚é–“å˜ä¾¡
      total_price: hours * 5000,
      work_report_id: report.id
    });
  });

  // 2. ä½¿ç”¨è³‡æ
  const materials = workReports.flatMap(r => r.work_report_materials);
  materials.forEach(material => {
    invoiceItems.push({
      item_type: 'material',
      description: material.material_name,
      quantity: material.quantity,
      unit: material.unit,
      unit_price: material.unit_price * 1.3, // 30%ãƒãƒ¼ã‚¸ãƒ³
      total_price: material.quantity * material.unit_price * 1.3,
      material_id: material.material_id
    });
  });

  // 3. å·¥å…·ä½¿ç”¨æ–™ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«æ‰±ã„ã®å ´åˆï¼‰
  const toolUsage = calculateToolUsageCharges(workReports);
  if (toolUsage.length > 0) {
    invoiceItems.push(...toolUsage);
  }

  // è«‹æ±‚æ›¸ä½œæˆ
  const subtotal = sum(invoiceItems.map(i => i.total_price));
  const taxAmount = subtotal * 0.1;

  const invoice = await supabase
    .from('invoices')
    .insert({
      client_id: clientId,
      invoice_number: generateInvoiceNumber(),
      invoice_date: new Date(),
      due_date: getPaymentDueDate(clientId),
      subtotal,
      tax_amount: taxAmount,
      total_amount: subtotal + taxAmount,
      work_report_ids: workReportIds
    })
    .select()
    .single();

  // æ˜ç´°è¿½åŠ 
  await supabase
    .from('invoice_items')
    .insert(invoiceItems.map(item => ({
      ...item,
      invoice_id: invoice.id
    })));

  return invoice;
};
```

#### PDFå‡ºåŠ›
```typescript
// è«‹æ±‚æ›¸PDFç”Ÿæˆ
import PDFDocument from 'pdfkit';

const generateInvoicePDF = async (invoiceId: string) => {
  const { data: invoice } = await supabase
    .from('invoices')
    .select(`
      *,
      items:invoice_items(*),
      client:clients(*),
      organization:organizations(*)
    `)
    .eq('id', invoiceId)
    .single();

  const doc = new PDFDocument({ size: 'A4' });

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  doc.fontSize(20)
     .text('è«‹æ±‚æ›¸', 50, 50);

  doc.fontSize(12)
     .text(`è«‹æ±‚æ›¸ç•ªå·: ${invoice.invoice_number}`, 400, 50)
     .text(`è«‹æ±‚æ—¥: ${format(invoice.invoice_date, 'yyyyå¹´MMæœˆddæ—¥')}`, 400, 70);

  // å®›å…ˆ
  doc.fontSize(14)
     .text(`${invoice.client.name} å¾¡ä¸­`, 50, 120);

  // è«‹æ±‚é‡‘é¡
  doc.fontSize(16)
     .text(`è«‹æ±‚é‡‘é¡: Â¥${invoice.total_amount.toLocaleString()}`, 50, 180);

  // æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
  let y = 250;
  doc.fontSize(10);

  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
  doc.text('å“ç›®', 50, y)
     .text('æ•°é‡', 300, y)
     .text('å˜ä¾¡', 380, y)
     .text('é‡‘é¡', 460, y);

  y += 20;

  // æ˜ç´°è¡Œ
  invoice.items.forEach(item => {
    doc.text(item.description, 50, y)
       .text(`${item.quantity} ${item.unit}`, 300, y)
       .text(`Â¥${item.unit_price.toLocaleString()}`, 380, y)
       .text(`Â¥${item.total_price.toLocaleString()}`, 460, y);
    y += 20;
  });

  // åˆè¨ˆ
  y += 20;
  doc.text(`å°è¨ˆ: Â¥${invoice.subtotal.toLocaleString()}`, 400, y);
  y += 20;
  doc.text(`æ¶ˆè²»ç¨: Â¥${invoice.tax_amount.toLocaleString()}`, 400, y);
  y += 20;
  doc.fontSize(12)
     .text(`åˆè¨ˆ: Â¥${invoice.total_amount.toLocaleString()}`, 400, y);

  // æŒ¯è¾¼å…ˆ
  doc.fontSize(10)
     .text('ã€æŒ¯è¾¼å…ˆã€‘', 50, 650)
     .text(invoice.organization.bank_account_info, 50, 670);

  return doc;
};
```

#### UI/UXè¨­è¨ˆ
```typescript
// components/InvoiceCreator.tsx
export default function InvoiceCreator() {
  return (
    <div className="space-y-6">
      {/* ã‚¹ãƒ†ãƒƒãƒ—1: ä½œæ¥­å ±å‘Šé¸æŠ */}
      <Card>
        <CardHeader>
          <CardTitle>1. è«‹æ±‚å¯¾è±¡ã®ä½œæ¥­ã‚’é¸æŠ</CardTitle>
        </CardHeader>
        <CardContent>
          <WorkReportSelector
            onSelect={setSelectedReports}
            filter={{ status: 'approved', invoiced: false }}
          />
        </CardContent>
      </Card>

      {/* ã‚¹ãƒ†ãƒƒãƒ—2: é¡§å®¢é¸æŠ */}
      <Card>
        <CardHeader>
          <CardTitle>2. è«‹æ±‚å…ˆã‚’é¸æŠ</CardTitle>
        </CardHeader>
        <CardContent>
          <ClientSelector onSelect={setClient} />
        </CardContent>
      </Card>

      {/* ã‚¹ãƒ†ãƒƒãƒ—3: è«‹æ±‚å†…å®¹ç¢ºèª */}
      <Card>
        <CardHeader>
          <CardTitle>3. è«‹æ±‚å†…å®¹ã®ç¢ºèª</CardTitle>
        </CardHeader>
        <CardContent>
          <InvoicePreview items={invoiceItems} />

          {/* é …ç›®ã®è¿½åŠ ãƒ»ç·¨é›† */}
          <Button variant="outline" className="mt-4">
            é …ç›®ã‚’è¿½åŠ 
          </Button>
        </CardContent>
      </Card>

      {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
      <div className="flex gap-4">
        <Button variant="primary">
          è«‹æ±‚æ›¸ã‚’ä½œæˆ
        </Button>
        <Button variant="outline">
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </Button>
      </div>
    </div>
  );
}
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬è«‹æ±‚æ›¸æ©Ÿèƒ½: 40ä¸‡å††
- ä½œæ¥­å ±å‘Šé€£æº: 20ä¸‡å††
- PDFå‡ºåŠ›: 15ä¸‡å††
- å…¥é‡‘ç®¡ç†: 15ä¸‡å††
- é¡§å®¢ç®¡ç†: 10ä¸‡å††
- **åˆè¨ˆ: 100ä¸‡å††**

---

## 5. å®šæœŸç‚¹æ¤œãƒ»æ ¡æ­£æœŸé™ç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
æ³•å®šç‚¹æ¤œã‚„æ ¡æ­£ãŒå¿…è¦ãªå·¥å…·ãƒ»æ©Ÿå™¨ã®æœŸé™ç®¡ç†ã€‚è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¼·åŒ–ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- æ ¡æ­£æœŸé™åˆ‡ã‚Œã«ã‚ˆã‚‹æ¸¬å®šå€¤ã®ä¿¡é ¼æ€§ä½ä¸‹
- æ³•å®šç‚¹æ¤œæ¼ã‚Œã«ã‚ˆã‚‹é•åãƒªã‚¹ã‚¯
- ç‚¹æ¤œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç®¡ç†è² è·

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- ç‚¹æ¤œãƒ»æ ¡æ­£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
CREATE TABLE inspection_schedules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tool_id UUID NOT NULL REFERENCES tools(id),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±
  inspection_type TEXT NOT NULL, -- 'calibration', 'legal', 'routine'
  interval_months INTEGER NOT NULL,
  last_inspection_date DATE,
  next_inspection_date DATE NOT NULL,

  -- é€šçŸ¥è¨­å®š
  alert_days_before INTEGER[] DEFAULT '{30, 14, 7, 1}',
  notify_users UUID[] DEFAULT '{}',

  -- å®Ÿæ–½æƒ…å ±
  inspection_vendor TEXT,
  estimated_cost DECIMAL(10,2),
  estimated_days INTEGER, -- ç‚¹æ¤œã«ã‹ã‹ã‚‹æ—¥æ•°

  is_active BOOLEAN DEFAULT true,
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç‚¹æ¤œå®Ÿæ–½è¨˜éŒ²
CREATE TABLE inspection_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  schedule_id UUID NOT NULL REFERENCES inspection_schedules(id),
  tool_id UUID NOT NULL REFERENCES tools(id),

  -- å®Ÿæ–½æƒ…å ±
  inspection_date DATE NOT NULL,
  inspector TEXT NOT NULL,
  certificate_number TEXT,

  -- çµæœ
  result TEXT NOT NULL, -- 'passed', 'failed', 'conditional'
  issues_found TEXT,
  actions_taken TEXT,

  -- ã‚³ã‚¹ãƒˆ
  actual_cost DECIMAL(10,2),

  -- æ¬¡å›äºˆå®š
  next_inspection_date DATE,

  -- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
  certificate_url TEXT,
  report_url TEXT,

  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡å±¥æ­´
CREATE TABLE inspection_alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  schedule_id UUID NOT NULL REFERENCES inspection_schedules(id),

  alert_type TEXT NOT NULL, -- 'upcoming', 'overdue', 'critical'
  days_until_due INTEGER,

  sent_to UUID[] NOT NULL,
  sent_at TIMESTAMP DEFAULT NOW(),

  acknowledged_by UUID REFERENCES users(id),
  acknowledged_at TIMESTAMP
);
```

### æ©Ÿèƒ½è©³ç´°

#### è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
```typescript
// æ—¥æ¬¡ãƒãƒƒãƒ: ç‚¹æ¤œæœŸé™ãƒã‚§ãƒƒã‚¯
const checkInspectionDeadlines = async () => {
  const today = new Date();
  const alerts = [];

  // æœŸé™ãŒè¿‘ã„ç‚¹æ¤œã‚’å–å¾—
  const { data: upcomingInspections } = await supabase
    .from('inspection_schedules')
    .select(`
      *,
      tool:tools(*)
    `)
    .eq('is_active', true)
    .gte('next_inspection_date', today)
    .lte('next_inspection_date', addDays(today, 30));

  for (const schedule of upcomingInspections) {
    const daysUntilDue = differenceInDays(
      new Date(schedule.next_inspection_date),
      today
    );

    // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
    if (schedule.alert_days_before.includes(daysUntilDue)) {
      // ã‚¢ãƒ©ãƒ¼ãƒˆä½œæˆ
      const alert = {
        schedule_id: schedule.id,
        alert_type: daysUntilDue <= 7 ? 'critical' : 'upcoming',
        days_until_due: daysUntilDue,
        message: `${schedule.tool.name}ã®${getInspectionTypeName(schedule.inspection_type)}æœŸé™ã¾ã§ã‚ã¨${daysUntilDue}æ—¥ã§ã™`,
        tool: schedule.tool
      };

      // é€šçŸ¥é€ä¿¡
      await sendInspectionAlert(alert, schedule.notify_users);

      // è¨˜éŒ²
      await supabase
        .from('inspection_alerts')
        .insert({
          schedule_id: schedule.id,
          alert_type: alert.alert_type,
          days_until_due: daysUntilDue,
          sent_to: schedule.notify_users
        });

      alerts.push(alert);
    }
  }

  // æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
  const { data: overdueInspections } = await supabase
    .from('inspection_schedules')
    .select('*, tool:tools(*)')
    .eq('is_active', true)
    .lt('next_inspection_date', today);

  for (const schedule of overdueInspections) {
    // å·¥å…·ã‚’ä½¿ç”¨åœæ­¢ã«
    await supabase
      .from('tools')
      .update({
        status: 'inspection_required',
        custom_fields: {
          ...schedule.tool.custom_fields,
          inspection_overdue_since: today
        }
      })
      .eq('id', schedule.tool_id);

    // ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ
    await sendEmergencyAlert({
      type: 'INSPECTION_OVERDUE',
      tool: schedule.tool,
      message: `${schedule.tool.name}ã®ç‚¹æ¤œæœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ä½¿ç”¨ã‚’åœæ­¢ã—ã¦ãã ã•ã„ã€‚`
    });
  }

  return alerts;
};
```

#### ç‚¹æ¤œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æœ€é©åŒ–
```typescript
// è¤‡æ•°å·¥å…·ã®ç‚¹æ¤œã‚’ã¾ã¨ã‚ã¦å®Ÿæ–½
const optimizeInspectionSchedule = async (organizationId: string) => {
  const { data: schedules } = await supabase
    .from('inspection_schedules')
    .select('*')
    .eq('organization_id', organizationId)
    .eq('inspection_type', 'calibration')
    .order('next_inspection_date');

  // åŒã˜æ¥­è€…ãƒ»åŒã˜æœˆã®ç‚¹æ¤œã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const grouped = groupBy(schedules, (s) => {
    return `${s.inspection_vendor}_${format(s.next_inspection_date, 'yyyy-MM')}`;
  });

  const recommendations = [];

  Object.entries(grouped).forEach(([key, group]) => {
    if (group.length >= 3) {
      recommendations.push({
        vendor: group[0].inspection_vendor,
        month: format(group[0].next_inspection_date, 'yyyyå¹´MMæœˆ'),
        tools: group.map(g => g.tool_id),
        potentialSaving: group.length * 1000, // ã¾ã¨ã‚å‰²å¼•æƒ³å®š
        message: `${group.length}å°ã¾ã¨ã‚ã¦ç‚¹æ¤œã«å‡ºã™ã¨ã€ç´„${group.length * 1000}å††ç¯€ç´„ã§ãã¾ã™`
      });
    }
  });

  return recommendations;
};
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†: 30ä¸‡å††
- è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½: 20ä¸‡å††
- ç‚¹æ¤œè¨˜éŒ²ç®¡ç†: 20ä¸‡å††
- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½: 10ä¸‡å††
- **åˆè¨ˆ: 80ä¸‡å††**

---

## 6. ç¾å ´æŒ‡ç¤ºç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
ä½œæ¥­æŒ‡ç¤ºæ›¸ã®é›»å­åŒ–ã€‚èª°ãŒãƒ»ã©ã“ã§ãƒ»ä½•ã‚’ã™ã‚‹ã‹ã‚’æ˜ç¢ºåŒ–ã—ã€å·¥å…·ãƒ»è³‡æã®æº–å‚™ã‚‚é€£å‹•ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- ç´™ã®æŒ‡ç¤ºæ›¸ã®ç´›å¤±ãƒ»ä¼é”ãƒŸã‚¹
- æŒ‡ç¤ºå†…å®¹ã¨å®Ÿä½œæ¥­ã®ä¹–é›¢
- å¿…è¦ãªå·¥å…·ãƒ»è³‡æã®æº–å‚™æ¼ã‚Œ

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- ä½œæ¥­æŒ‡ç¤ºæ›¸
CREATE TABLE work_orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- åŸºæœ¬æƒ…å ±
  order_number TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,

  -- ç¾å ´ãƒ»æ—¥ç¨‹
  site_id UUID NOT NULL REFERENCES sites(id),
  scheduled_date DATE NOT NULL,
  start_time TIME,
  end_time TIME,

  -- æ‹…å½“è€…
  created_by UUID NOT NULL REFERENCES users(id),
  assigned_to UUID[] NOT NULL, -- è¤‡æ•°äººã‚¢ã‚µã‚¤ãƒ³å¯
  team_leader_id UUID REFERENCES users(id),

  -- ä½œæ¥­å†…å®¹
  work_type TEXT NOT NULL,
  priority TEXT DEFAULT 'normal', -- 'low', 'normal', 'high', 'urgent'

  -- å¿…è¦ãƒªã‚½ãƒ¼ã‚¹
  required_tools UUID[], -- å¿…è¦å·¥å…·ãƒªã‚¹ãƒˆ
  required_materials JSONB, -- [{material_id, quantity}]
  required_skills TEXT[], -- å¿…è¦è³‡æ ¼ãƒ»ã‚¹ã‚­ãƒ«

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'draft', -- 'draft', 'assigned', 'in_progress', 'completed', 'cancelled'

  -- å®Œäº†æƒ…å ±
  actual_start_time TIMESTAMP,
  actual_end_time TIMESTAMP,
  completed_by UUID REFERENCES users(id),
  completion_notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ä½œæ¥­æŒ‡ç¤ºæ›¸ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ
CREATE TABLE work_order_comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id),
  user_id UUID NOT NULL REFERENCES users(id),
  comment TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ä½œæ¥­æŒ‡ç¤ºæ›¸ã®æ‰¿èªãƒ•ãƒ­ãƒ¼
CREATE TABLE work_order_approvals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  work_order_id UUID NOT NULL REFERENCES work_orders(id),
  approver_id UUID NOT NULL REFERENCES users(id),
  status TEXT NOT NULL, -- 'pending', 'approved', 'rejected'
  comments TEXT,
  approved_at TIMESTAMP
);
```

### æ©Ÿèƒ½è©³ç´°

#### æŒ‡ç¤ºæ›¸ä½œæˆã¨é…å¸ƒ
```typescript
// ä½œæ¥­æŒ‡ç¤ºæ›¸ã®ä½œæˆã¨é€šçŸ¥
const createWorkOrder = async (data: WorkOrderInput) => {
  // å¿…è¦ã‚¹ã‚­ãƒ«ã‚’æŒã¤ã‚¹ã‚¿ãƒƒãƒ•ã‚’æ¨å¥¨
  const { data: qualifiedStaff } = await supabase
    .from('users')
    .select('*')
    .contains('certifications', data.required_skills);

  // ä½œæ¥­æŒ‡ç¤ºæ›¸ä½œæˆ
  const workOrder = await supabase
    .from('work_orders')
    .insert({
      ...data,
      order_number: generateOrderNumber(),
      status: 'assigned'
    })
    .select()
    .single();

  // æ‹…å½“è€…ã«é€šçŸ¥
  for (const userId of data.assigned_to) {
    await sendNotification({
      user_id: userId,
      type: 'work_order_assigned',
      title: 'æ–°ã—ã„ä½œæ¥­æŒ‡ç¤º',
      body: `${data.title} - ${format(data.scheduled_date, 'MMæœˆddæ—¥')}`,
      data: { work_order_id: workOrder.id }
    });
  }

  // å¿…è¦å·¥å…·ã®è‡ªå‹•äºˆç´„
  if (data.required_tools.length > 0) {
    await reserveToolsForWork(
      data.required_tools,
      data.scheduled_date,
      data.assigned_to[0]
    );
  }

  return workOrder;
};
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬æ©Ÿèƒ½: 40ä¸‡å††
- æ‰¿èªãƒ•ãƒ­ãƒ¼: 20ä¸‡å††
- å·¥å…·ãƒ»è³‡æé€£æº: 20ä¸‡å††
- **åˆè¨ˆ: 80ä¸‡å††**

---

## 7. è»Šä¸¡ãƒ»é‡æ©Ÿç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
ãƒˆãƒ©ãƒƒã‚¯ã€ã‚¯ãƒ¬ãƒ¼ãƒ³è»Šãªã©ã®é…è»Šç®¡ç†ã¨ã€ç©è¼‰å·¥å…·ã®è¿½è·¡ã‚’çµ±åˆã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- è»Šä¸¡ã®æ‰€åœ¨ãŒä¸æ˜
- è»Šæ¤œãƒ»ä¿é™ºã®æœŸé™ç®¡ç†
- ã©ã®è»Šä¸¡ã«ä½•ãŒç©ã¾ã‚Œã¦ã„ã‚‹ã‹ä¸æ˜

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- è»Šä¸¡ãƒã‚¹ã‚¿
CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- åŸºæœ¬æƒ…å ±
  vehicle_code TEXT NOT NULL,
  vehicle_type TEXT NOT NULL, -- 'truck', 'van', 'crane', 'forklift'
  manufacturer TEXT,
  model TEXT,
  license_plate TEXT NOT NULL,

  -- ç®¡ç†æƒ…å ±
  purchase_date DATE,
  purchase_price DECIMAL(10,2),
  current_driver_id UUID REFERENCES users(id),
  current_location_id UUID REFERENCES locations(id),

  -- ç‚¹æ¤œãƒ»ä¿é™º
  inspection_due_date DATE, -- è»Šæ¤œ
  insurance_expiry_date DATE,

  -- çŠ¶æ…‹
  status TEXT DEFAULT 'available', -- 'available', 'in_use', 'maintenance'
  fuel_level INTEGER, -- ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
  odometer_reading INTEGER, -- èµ°è¡Œè·é›¢

  custom_fields JSONB DEFAULT '{}',
  deleted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- è»Šä¸¡ä½¿ç”¨è¨˜éŒ²
CREATE TABLE vehicle_usage_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID NOT NULL REFERENCES vehicles(id),
  driver_id UUID NOT NULL REFERENCES users(id),

  -- ä½¿ç”¨æƒ…å ±
  purpose TEXT NOT NULL,
  destination TEXT,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  start_odometer INTEGER,
  end_odometer INTEGER,
  fuel_added DECIMAL(5,2),

  -- ç©è¼‰å·¥å…·
  loaded_tools UUID[],

  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬è»Šä¸¡ç®¡ç†: 30ä¸‡å††
- é…è»Šç®¡ç†: 20ä¸‡å††
- ç‚¹æ¤œãƒ»ä¿é™ºã‚¢ãƒ©ãƒ¼ãƒˆ: 10ä¸‡å††
- **åˆè¨ˆ: 60ä¸‡å††**

---

## 8. é¡§å®¢ãƒ»ç¾å ´æƒ…å ±ç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
é¡§å®¢æƒ…å ±ã¨ç¾å ´æƒ…å ±ã€éå»ã®æ–½å·¥å±¥æ­´ã‚’ä¸€å…ƒç®¡ç†ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- éå»ã®æ–½å·¥å†…å®¹ãŒä¸æ˜
- ç¾å ´ç‰¹æœ‰ã®æ³¨æ„äº‹é …ã®å¼•ãç¶™ãä¸è¶³
- é¡§å®¢æƒ…å ±ã®æ•£é€¸

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ¡ˆä»¶ï¼‰
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  client_id UUID REFERENCES clients(id),

  -- åŸºæœ¬æƒ…å ±
  project_code TEXT NOT NULL,
  name TEXT NOT NULL,
  description TEXT,

  -- æœŸé–“ãƒ»é‡‘é¡
  start_date DATE,
  end_date DATE,
  contract_amount DECIMAL(12,2),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'planning', -- 'planning', 'active', 'completed', 'cancelled'

  created_at TIMESTAMP DEFAULT NOW()
);

-- ç¾å ´è©³ç´°æƒ…å ±
CREATE TABLE site_details (
  site_id UUID PRIMARY KEY REFERENCES sites(id),

  -- ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±
  access_notes TEXT, -- éµã®å ´æ‰€ã€å…¥å ´æ–¹æ³•ç­‰
  parking_info TEXT,
  nearest_station TEXT,

  -- æ³¨æ„äº‹é …
  special_requirements TEXT, -- ãƒšãƒƒãƒˆã€é™éŸ³ä½œæ¥­ç­‰
  prohibited_items TEXT,

  -- é€£çµ¡å…ˆ
  site_contact_name TEXT,
  site_contact_phone TEXT,
  emergency_contact TEXT,

  -- æ–½è¨­æƒ…å ±
  has_electricity BOOLEAN DEFAULT true,
  has_water BOOLEAN DEFAULT true,
  has_toilet BOOLEAN DEFAULT true,

  updated_at TIMESTAMP DEFAULT NOW()
);

-- æ–½å·¥å±¥æ­´
CREATE TABLE project_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID NOT NULL REFERENCES projects(id),
  site_id UUID REFERENCES sites(id),

  work_date DATE NOT NULL,
  work_type TEXT NOT NULL,
  description TEXT,
  workers TEXT[],
  tools_used TEXT[],
  materials_used JSONB,

  photos TEXT[],
  notes TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);
```

### æƒ³å®šä¾¡æ ¼
- é¡§å®¢ç®¡ç†: 30ä¸‡å††
- ç¾å ´æƒ…å ±ç®¡ç†: 20ä¸‡å††
- æ–½å·¥å±¥æ­´: 20ä¸‡å††
- **åˆè¨ˆ: 70ä¸‡å††**

---

## 9. è¦‹ç©ã‚‚ã‚Šä½œæˆæ©Ÿèƒ½

### æ¦‚è¦
éå»ã®æ–½å·¥å®Ÿç¸¾ã‚’åŸºã«è¦‹ç©ã‚‚ã‚Šã‚’è‡ªå‹•ç”Ÿæˆã€‚å·¥æ•°ãƒ»è³‡æã‚’äºˆæ¸¬ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- è¦‹ç©ã‚‚ã‚Šä½œæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹
- è¦‹ç©ã‚‚ã‚Šç²¾åº¦ã®ã°ã‚‰ã¤ã
- éå»ã®é¡ä¼¼æ¡ˆä»¶ã®å‚ç…§ãŒå›°é›£

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- è¦‹ç©æ›¸
CREATE TABLE quotes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- åŸºæœ¬æƒ…å ±
  quote_number TEXT NOT NULL,
  client_id UUID REFERENCES clients(id),
  project_name TEXT NOT NULL,

  -- è¦‹ç©æƒ…å ±
  quote_date DATE NOT NULL,
  valid_until DATE NOT NULL,

  -- é‡‘é¡
  subtotal DECIMAL(12,2) NOT NULL,
  tax_amount DECIMAL(12,2),
  total_amount DECIMAL(12,2) NOT NULL,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT DEFAULT 'draft', -- 'draft', 'sent', 'accepted', 'rejected', 'expired'

  -- å—æ³¨æƒ…å ±
  accepted_date DATE,
  project_id UUID REFERENCES projects(id),

  notes TEXT,
  terms_and_conditions TEXT,

  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- è¦‹ç©æ˜ç´°
CREATE TABLE quote_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  quote_id UUID NOT NULL REFERENCES quotes(id),

  category TEXT NOT NULL, -- 'åŠ´å‹™è²»', 'ææ–™è²»', 'è«¸çµŒè²»'ç­‰
  description TEXT NOT NULL,
  quantity DECIMAL(10,2) NOT NULL,
  unit TEXT,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(12,2) NOT NULL,

  -- åŸä¾¡æƒ…å ±ï¼ˆéè¡¨ç¤ºï¼‰
  cost_price DECIMAL(10,2),
  profit_margin DECIMAL(5,2),

  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- è¦‹ç©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
CREATE TABLE quote_templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  name TEXT NOT NULL,
  work_type TEXT NOT NULL,

  -- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé …ç›®
  template_items JSONB NOT NULL,

  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### æ©Ÿèƒ½è©³ç´°

#### AIè¦‹ç©ã‚‚ã‚Šã‚¢ã‚·ã‚¹ãƒˆ
```typescript
// éå»ã®é¡ä¼¼æ¡ˆä»¶ã‹ã‚‰è¦‹ç©ã‚‚ã‚Šã‚’ç”Ÿæˆ
const generateQuoteFromSimilarProjects = async (
  workType: string,
  siteArea: number,
  requirements: string
) => {
  // é¡ä¼¼æ¡ˆä»¶ã‚’æ¤œç´¢
  const { data: similarProjects } = await supabase
    .from('projects')
    .select(`
      *,
      quotes(*),
      project_history(*)
    `)
    .eq('work_type', workType)
    .gte('site_area', siteArea * 0.8)
    .lte('site_area', siteArea * 1.2)
    .eq('status', 'completed')
    .limit(5);

  // å¹³å‡å€¤ã‚’è¨ˆç®—
  const avgCost = average(similarProjects.map(p => p.contract_amount));
  const avgDuration = average(similarProjects.map(p => p.duration_days));
  const commonMaterials = getMostUsedMaterials(similarProjects);

  // è¦‹ç©ã‚‚ã‚Šé …ç›®ã‚’ç”Ÿæˆ
  const quoteItems = [
    {
      category: 'åŠ´å‹™è²»',
      description: `${workType} ä½œæ¥­å“¡ ${avgDuration}æ—¥é–“`,
      quantity: avgDuration,
      unit: 'äººæ—¥',
      unit_price: 25000,
      total_price: avgDuration * 25000
    },
    ...commonMaterials.map(m => ({
      category: 'ææ–™è²»',
      description: m.name,
      quantity: m.avgQuantity,
      unit: m.unit,
      unit_price: m.unitPrice * 1.3, // 30%ãƒãƒ¼ã‚¸ãƒ³
      total_price: m.avgQuantity * m.unitPrice * 1.3
    }))
  ];

  return {
    estimatedCost: avgCost,
    estimatedDuration: avgDuration,
    quoteItems,
    similarProjects: similarProjects.map(p => ({
      name: p.name,
      cost: p.contract_amount,
      duration: p.duration_days
    }))
  };
};
```

### æƒ³å®šä¾¡æ ¼
- åŸºæœ¬è¦‹ç©æ©Ÿèƒ½: 40ä¸‡å††
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½: 20ä¸‡å††
- é¡ä¼¼æ¡ˆä»¶æ¤œç´¢: 20ä¸‡å††
- PDFå‡ºåŠ›: 10ä¸‡å††
- **åˆè¨ˆ: 90ä¸‡å††**

---

## 10. å®‰å…¨ç®¡ç†ãƒ»KYæ´»å‹•è¨˜éŒ²æ©Ÿèƒ½

### æ¦‚è¦
å±é™ºäºˆçŸ¥æ´»å‹•ã€ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Šã€å®‰å…¨è£…å‚™ãƒã‚§ãƒƒã‚¯ã‚’é›»å­åŒ–ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- ç´™ãƒ™ãƒ¼ã‚¹ã®KYæ´»å‹•è¨˜éŒ²ã®ç®¡ç†
- ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆæƒ…å ±ã®å…±æœ‰ä¸è¶³
- å®‰å…¨è£…å‚™ã®è£…ç€ç¢ºèªæ¼ã‚Œ

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- KYï¼ˆå±é™ºäºˆçŸ¥ï¼‰æ´»å‹•è¨˜éŒ²
CREATE TABLE ky_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  site_id UUID NOT NULL REFERENCES sites(id),

  -- å®Ÿæ–½æƒ…å ±
  activity_date DATE NOT NULL,
  leader_id UUID NOT NULL REFERENCES users(id),
  participants UUID[] NOT NULL,

  -- ä½œæ¥­å†…å®¹
  work_description TEXT NOT NULL,

  -- å±é™ºäºˆçŸ¥
  hazards JSONB NOT NULL, -- [{hazard, risk_level, countermeasure}]

  -- é‡ç‚¹å®Ÿæ–½é …ç›®
  key_points TEXT[],

  -- ç¢ºèªäº‹é …
  safety_equipment_check JSONB,
  tool_inspection_done BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT NOW()
);

-- ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Š
CREATE TABLE near_miss_reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- ç™ºç”Ÿæƒ…å ±
  occurred_at TIMESTAMP NOT NULL,
  site_id UUID REFERENCES sites(id),
  reported_by UUID NOT NULL REFERENCES users(id),

  -- å†…å®¹
  incident_type TEXT NOT NULL,
  description TEXT NOT NULL,
  potential_consequence TEXT,

  -- åŸå› ã¨å¯¾ç­–
  root_cause TEXT,
  immediate_action TEXT,
  preventive_measure TEXT,

  -- é‡è¦åº¦
  severity_level INTEGER, -- 1-5

  -- å…±æœ‰çŠ¶æ³
  shared_with_team BOOLEAN DEFAULT false,
  shared_date DATE,

  photos TEXT[],

  created_at TIMESTAMP DEFAULT NOW()
);

-- å®‰å…¨ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«è¨˜éŒ²
CREATE TABLE safety_patrols (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  site_id UUID NOT NULL REFERENCES sites(id),

  patrol_date DATE NOT NULL,
  inspector_id UUID NOT NULL REFERENCES users(id),

  -- ãƒã‚§ãƒƒã‚¯é …ç›®
  checklist_results JSONB, -- [{item, result, notes}]

  -- æŒ‡æ‘˜äº‹é …
  violations JSONB, -- [{violation, severity, corrective_action}]

  overall_score INTEGER, -- 0-100

  created_at TIMESTAMP DEFAULT NOW()
);
```

### æƒ³å®šä¾¡æ ¼
- KYæ´»å‹•è¨˜éŒ²: 30ä¸‡å††
- ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ: 30ä¸‡å††
- å®‰å…¨ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«: 20ä¸‡å††
- ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½: 20ä¸‡å††
- **åˆè¨ˆ: 100ä¸‡å††**

---

## 11. ã‚¹ã‚¿ãƒƒãƒ•è³‡æ ¼ãƒ»å…è¨±ç®¡ç†æ©Ÿèƒ½

### æ¦‚è¦
ã‚¹ã‚¿ãƒƒãƒ•ã®ä¿æœ‰è³‡æ ¼ã€å…è¨±ã®æœŸé™ç®¡ç†ã€ã‚¹ã‚­ãƒ«ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ä½œæˆã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
- èª°ãŒã©ã®è³‡æ ¼ã‚’æŒã£ã¦ã„ã‚‹ã‹ä¸æ˜
- è³‡æ ¼ãƒ»å…è¨±ã®æ›´æ–°æ¼ã‚Œ
- é©æé©æ‰€ã®äººå“¡é…ç½®å›°é›£

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
```sql
-- ã‚¹ã‚¿ãƒƒãƒ•è³‡æ ¼æƒ…å ±
CREATE TABLE staff_certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- è³‡æ ¼æƒ…å ±
  certification_type TEXT NOT NULL, -- 'license', 'qualification', 'training'
  name TEXT NOT NULL,
  issuer TEXT,

  -- æœ‰åŠ¹æœŸé™
  issue_date DATE NOT NULL,
  expiry_date DATE,

  -- è¨¼æ˜æ›¸
  certificate_number TEXT,
  certificate_url TEXT,

  -- æ›´æ–°æƒ…å ±
  renewal_required BOOLEAN DEFAULT false,
  renewal_reminder_days INTEGER DEFAULT 30,

  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¹ã‚­ãƒ«ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
CREATE TABLE skill_matrix (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id),

  -- ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ï¼ˆ1-5ï¼‰
  skills JSONB, -- {welding: 4, painting: 5, electrical: 2}

  -- çµŒé¨“å¹´æ•°
  experience_years JSONB, -- {welding: 5, painting: 8}

  -- å¾—æ„åˆ†é‡
  specialties TEXT[],

  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç ”ä¿®è¨˜éŒ²
CREATE TABLE training_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id),

  training_name TEXT NOT NULL,
  training_type TEXT, -- 'safety', 'skill', 'compliance'
  provider TEXT,

  completed_date DATE NOT NULL,
  valid_until DATE,

  score INTEGER,
  certificate_url TEXT,

  created_at TIMESTAMP DEFAULT NOW()
);
```

### æƒ³å®šä¾¡æ ¼
- è³‡æ ¼ç®¡ç†: 30ä¸‡å††
- æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ: 20ä¸‡å††
- ã‚¹ã‚­ãƒ«ãƒãƒˆãƒªãƒƒã‚¯ã‚¹: 20ä¸‡å††
- ç ”ä¿®ç®¡ç†: 10ä¸‡å††
- **åˆè¨ˆ: 80ä¸‡å††**

---

## æ¶ˆè€—å“ç®¡ç†ã«ã¤ã„ã¦ï¼ˆåˆæœŸé–‹ç™ºã§ã®å¯¾å¿œï¼‰

### æ—¢å­˜ä»•æ§˜ã§ã®å¯¾å¿œçŠ¶æ³

SPECIFICATION_SAAS_FINAL.mdã§æ—¢ã«ä»¥ä¸‹ã®å¯¾å¿œãŒã•ã‚Œã¦ã„ã¾ã™ï¼š

```sql
-- toolsãƒ†ãƒ¼ãƒ–ãƒ«ã§æ¶ˆè€—å“ã‚‚ç®¡ç†
CREATE TABLE tools (
  id UUID PRIMARY KEY,

  -- ç®¡ç†æ–¹å¼ã®åˆ‡ã‚Šæ›¿ãˆ
  management_type TEXT DEFAULT 'individual', -- 'individual'ï¼ˆå€‹åˆ¥ï¼‰or 'quantity'ï¼ˆæ•°é‡ï¼‰

  -- æ•°é‡ç®¡ç†ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  current_quantity INTEGER, -- ç¾åœ¨ã®åœ¨åº«æ•°
  unit TEXT DEFAULT 'å€‹', -- å˜ä½ï¼ˆå€‹ã€æœ¬ã€ç®±ã€Lã€kgç­‰ï¼‰

  -- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ‹¡å¼µ
  custom_fields JSONB DEFAULT '{}',
  -- {
  --   minimum_stock: 100,  // æœ€ä½åœ¨åº«æ•°
  --   reorder_point: 150,  // ç™ºæ³¨ç‚¹
  --   supplier: "ãƒ¢ãƒã‚¿ãƒ­ã‚¦",
  --   unit_price: 15.5
  -- }
);
```

### é‹ç”¨ä¾‹

#### å·¥å…·ï¼ˆå€‹åˆ¥ç®¡ç†ï¼‰
```typescript
{
  management_type: 'individual',
  tool_code: 'A-0123',
  name: 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼',
  current_quantity: null // ä½¿ç”¨ã—ãªã„
}
```

#### æ¶ˆè€—å“ï¼ˆæ•°é‡ç®¡ç†ï¼‰
```typescript
{
  management_type: 'quantity',
  tool_code: 'C-0001',
  name: 'ãƒ“ã‚¹ 65mm',
  current_quantity: 5000, // 5000æœ¬
  unit: 'æœ¬',
  custom_fields: {
    minimum_stock: 1000,
    reorder_point: 1500
  }
}
```

### è¿½åŠ é–‹ç™ºã§ã®æ‹¡å¼µ

ä¸Šè¨˜ã®ã€Œè³‡æç™ºæ³¨ãƒ»åœ¨åº«ç®¡ç†æ©Ÿèƒ½ã€ã§ã€ã‚ˆã‚Šé«˜åº¦ãªæ¶ˆè€—å“ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼š
- è‡ªå‹•ç™ºæ³¨ææ¡ˆ
- ä½¿ç”¨å±¥æ­´åˆ†æ
- ç¾å ´ã”ã¨ã®æ¶ˆè²»é‡äºˆæ¸¬
- ä»•å…¥å…ˆç®¡ç†

---

## é–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã¾ã¨ã‚

### ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰- ç¾å ´DXåŸºç›¤
1. **ä½œæ¥­å ±å‘Š** - 50ä¸‡å††
2. **å‡ºé€€å‹¤ç®¡ç†** - 80ä¸‡å††
3. **å®šæœŸç‚¹æ¤œãƒ»æ ¡æ­£æœŸé™ç®¡ç†** - 80ä¸‡å††
- **å°è¨ˆ: 210ä¸‡å††**

### ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆ6ãƒ¶æœˆå¾Œï¼‰- æ¥­å‹™åŠ¹ç‡åŒ–
4. **è³‡æç™ºæ³¨ãƒ»åœ¨åº«ç®¡ç†** - 100ä¸‡å††
5. **è«‹æ±‚æ›¸ä½œæˆ** - 100ä¸‡å††
6. **ç¾å ´æŒ‡ç¤ºç®¡ç†** - 80ä¸‡å††
7. **è»Šä¸¡ãƒ»é‡æ©Ÿç®¡ç†** - 60ä¸‡å††
- **å°è¨ˆ: 340ä¸‡å††**

### ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆ1å¹´å¾Œï¼‰- çµŒå–¶æ”¯æ´
8. **é¡§å®¢ãƒ»ç¾å ´æƒ…å ±ç®¡ç†** - 70ä¸‡å††
9. **è¦‹ç©ã‚‚ã‚Šä½œæˆ** - 90ä¸‡å††
10. **å®‰å…¨ç®¡ç†ãƒ»KYæ´»å‹•** - 100ä¸‡å††
11. **ã‚¹ã‚¿ãƒƒãƒ•è³‡æ ¼ãƒ»å…è¨±ç®¡ç†** - 80ä¸‡å††
- **å°è¨ˆ: 340ä¸‡å††**

**ç·è¨ˆ: 890ä¸‡å††**

---

## æ¨å¥¨äº‹é …

1. **æœ€å„ªå…ˆæ©Ÿèƒ½**
   - ä½œæ¥­å ±å‘Šï¼ˆå·¥å…·ä½¿ç”¨å±¥æ­´ã®è‡ªå‹•åŒ–ãŒå·®åˆ¥åŒ–è¦ç´ ï¼‰
   - å‡ºé€€å‹¤ç®¡ç†ï¼ˆç›´è¡Œç›´å¸°å¯¾å¿œï¼‰
   - å®šæœŸç‚¹æ¤œãƒ»æ ¡æ­£æœŸé™ç®¡ç†ï¼ˆã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼‰

2. **ç«¶åˆå„ªä½æ€§ã‚’ç”Ÿã‚€æ©Ÿèƒ½**
   - å·¥å…·Ã—ä½œæ¥­å ±å‘Šã®é€£æº
   - å·¥å…·Ã—å‡ºé€€å‹¤ã®é€£æº
   - AIç•°å¸¸æ¤œçŸ¥ï¼ˆç›—é›£é˜²æ­¢ï¼‰

3. **åç›ŠåŒ–ã®è¦³ç‚¹**
   - åŸºæœ¬ãƒ—ãƒ©ãƒ³: å·¥å…·ç®¡ç†ã®ã¿
   - æ¨™æº–ãƒ—ãƒ©ãƒ³: +ä½œæ¥­å ±å‘Šã€å‡ºé€€å‹¤
   - ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³: å…¨æ©Ÿèƒ½

---

**ä½œæˆæ—¥**: 2025-11-29
**æ›´æ–°æ—¥**: -