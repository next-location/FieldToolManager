# GPS打刻機能 包括的テスト計画

## 実装内容の概要

1. **データベース拡張**
   - attendance_recordsにGPS座標カラム追加
   - organization_attendance_settingsにGPS設定追加
   - sitesに位置情報カラム追加
   - attendance_allowed_areas新規テーブル作成

2. **API機能**
   - clock-in/clock-out APIにGPS対応追加
   - GPS検証API（/api/attendance/gps/validate）新規作成

3. **UI機能**
   - 勤怠設定画面にGPS設定追加
   - 出勤簿画面にGPS取得機能追加
   - シフト制専用表示追加

---

## 🧪 テストケース一覧

### 1. 既存機能の動作確認（レグレッションテスト）

#### 1.1 従来の打刻機能
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| QRコード打刻（固定勤務） | 1. QRコード生成<br>2. スキャンして打刻 | 正常に打刻完了 | [ ] |
| ボタン打刻（固定勤務） | 1. 場所選択<br>2. 出勤ボタンクリック | 正常に打刻完了 | [ ] |
| 夜勤ボタン許可 | 1. 夜勤パターン設定<br>2. QRのみ設定でもボタン表示 | ボタンが表示される | [ ] |
| 休憩時間記録 | 1. 休憩時間入力<br>2. 退勤打刻 | 休憩時間が保存される | [ ] |
| 休日出勤判定 | 1. 休日に出勤打刻 | 確認ダイアログ表示 | [ ] |

#### 1.2 勤怠設定画面
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| 打刻方法設定 | 1. 手動/QR設定変更<br>2. 保存 | 設定が保持される | [ ] |
| QR更新頻度設定 | 1. 日数変更<br>2. 保存 | 設定が反映される | [ ] |
| 休憩設定 | 1. 自動控除設定<br>2. 時間入力 | 設定が保存される | [ ] |

#### 1.3 スタッフ管理
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| シフト制設定 | 1. スタッフ編集<br>2. シフト制ON | is_shift_workが更新 | [ ] |
| 勤務パターン設定 | 1. パターン選択<br>2. 保存 | パターンが設定される | [ ] |
| 夜勤パターン | 1. 夜勤フラグON<br>2. 保存 | is_night_shiftが更新 | [ ] |

---

### 2. GPS機能の新規テスト

#### 2.1 GPS設定（管理者）
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| GPS不要設定 | 1. 「GPS位置確認を使用しない」選択<br>2. 保存 | GPS取得なしで打刻可能 | [ ] |
| 全員必須設定 | 1. 「すべてのスタッフに必須」選択<br>2. 保存 | 全員GPS必須になる | [ ] |
| シフト制のみ設定 | 1. 「シフト制のみ必須」選択<br>2. 保存 | シフト制のみGPS必須 | [ ] |
| シフト制+夜勤設定 | 1. 「シフト制と夜勤のみ」選択<br>2. 保存 | 該当者のみGPS必須 | [ ] |
| GPS許容範囲設定 | 1. 範囲を200mに設定<br>2. 保存 | 200m範囲で打刻可能 | [ ] |

#### 2.2 GPS打刻（スタッフ）
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| GPS許可時の打刻 | 1. 位置情報許可<br>2. ボタン打刻 | GPS座標が記録される | [ ] |
| GPS拒否時の打刻 | 1. 位置情報拒否<br>2. ボタン打刻試行 | エラーメッセージ表示 | [ ] |
| GPS精度表示 | 1. GPS取得成功<br>2. 精度確認 | 精度がm単位で表示 | [ ] |
| GPS取得中表示 | 1. 打刻ボタン押下 | ローディング表示 | [ ] |
| GPS取得エラー | 1. 屋内で打刻試行 | エラーメッセージ表示 | [ ] |

#### 2.3 GPS検証API
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| 範囲内判定 | 1. 許可範囲内から打刻 | 打刻成功 | [ ] |
| 範囲外判定 | 1. 許可範囲外から打刻 | エラー表示 | [ ] |
| 事務所エリア | 1. 事務所設定<br>2. 事務所から打刻 | 事務所として記録 | [ ] |
| 現場エリア | 1. 現場位置設定<br>2. 現場から打刻 | 現場として記録 | [ ] |
| 在宅勤務 | 1. 在宅選択<br>2. GPS検証 | GPS検証スキップ | [ ] |

---

### 3. シフト制専用機能テスト

#### 3.1 シフト制の打刻制限
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| QR無効化 | 1. シフト制設定<br>2. 出勤簿表示 | QRボタン非表示 | [ ] |
| ボタンのみ表示 | 1. シフト制設定<br>2. 打刻画面確認 | ボタンのみ表示 | [ ] |
| 注意表示 | 1. シフト制設定<br>2. 画面上部確認 | 「シフト制勤務モード」表示 | [ ] |
| GPS必須表示 | 1. GPS設定ON<br>2. シフト制で確認 | GPS必須の注意表示 | [ ] |

#### 3.2 シフト制GPS連携
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| シフト制GPS必須 | 1. 「シフト制のみ」設定<br>2. シフト制で打刻 | GPS取得が必須 | [ ] |
| 固定勤務GPS不要 | 1. 「シフト制のみ」設定<br>2. 固定勤務で打刻 | GPS不要で打刻可能 | [ ] |
| 夜勤シフト制 | 1. 「シフト制+夜勤」設定<br>2. 夜勤シフトで打刻 | GPS必須 | [ ] |

---

### 4. エラーケースのテスト

#### 4.1 GPS関連エラー
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| 権限拒否 | 1. GPS権限拒否<br>2. 必須設定で打刻 | 「許可してください」表示 | [ ] |
| タイムアウト | 1. GPS取得10秒待機 | タイムアウトエラー | [ ] |
| 位置取得不可 | 1. 機内モードON<br>2. 打刻試行 | 「取得できません」表示 | [ ] |
| 精度不足 | 1. 屋内でGPS取得<br>2. 精度確認 | 精度警告表示 | [ ] |

#### 4.2 データ整合性
| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| NULL値処理 | 1. GPS無効で打刻<br>2. DB確認 | GPS列がNULL | [ ] |
| 既存データ | 1. 過去の打刻確認 | GPS列NULL、動作正常 | [ ] |
| 設定未登録 | 1. GPS設定なし<br>2. 打刻 | デフォルト動作 | [ ] |

---

### 5. パフォーマンステスト

| テスト項目 | 手順 | 期待結果 | ステータス |
|-----------|------|---------|-----------|
| GPS取得速度 | 1. 打刻ボタン押下<br>2. 時間計測 | 3秒以内に取得 | [ ] |
| API応答速度 | 1. GPS検証API呼出<br>2. レスポンス計測 | 1秒以内に応答 | [ ] |
| 大量データ | 1. 1000件の許可エリア<br>2. 検証実行 | 正常動作 | [ ] |

---

### 6. ブラウザ互換性テスト

| ブラウザ | GPS取得 | 打刻機能 | UI表示 | ステータス |
|---------|---------|---------|--------|-----------|
| Chrome (最新) | [ ] | [ ] | [ ] | [ ] |
| Safari (iOS) | [ ] | [ ] | [ ] | [ ] |
| Firefox | [ ] | [ ] | [ ] | [ ] |
| Edge | [ ] | [ ] | [ ] | [ ] |

---

## 📱 モバイルデバイステスト

| デバイス | OS | GPS精度 | 動作確認 | ステータス |
|---------|-----|---------|---------|-----------|
| iPhone 14 | iOS 17 | [ ] | [ ] | [ ] |
| iPhone SE | iOS 16 | [ ] | [ ] | [ ] |
| Pixel 7 | Android 14 | [ ] | [ ] | [ ] |
| Galaxy S23 | Android 13 | [ ] | [ ] | [ ] |

---

## 🔄 マイグレーションテスト

### データベース更新
```sql
-- テスト用クエリ
SELECT
  clock_in_latitude,
  clock_in_longitude,
  clock_in_accuracy
FROM attendance_records
LIMIT 5;

SELECT
  gps_requirement,
  gps_radius
FROM organization_attendance_settings
LIMIT 5;
```

### ロールバック確認
1. マイグレーション実行
2. データ投入
3. ロールバックSQL実行
4. 元の状態に戻ることを確認

---

## ⚠️ 注意事項

1. **本番環境テスト前に必ず実施**
   - ステージング環境での全項目テスト
   - データベースバックアップ取得
   - ロールバック手順の確認

2. **GPS権限の扱い**
   - ユーザーに権限要求の理由を明確に説明
   - 権限拒否時の代替フロー確認

3. **プライバシー配慮**
   - GPS情報は打刻時のみ取得
   - 常時追跡しないことを確認
   - データ保護方針の確認

---

## 実行手順

1. **準備**
   - [ ] データベースマイグレーション実行
   - [ ] テスト用組織・ユーザー作成
   - [ ] 各種設定パターン準備

2. **テスト実行**
   - [ ] 既存機能テスト（1章）
   - [ ] GPS新機能テスト（2章）
   - [ ] シフト制テスト（3章）
   - [ ] エラーケーステスト（4章）
   - [ ] パフォーマンステスト（5章）
   - [ ] 互換性テスト（6章）

3. **完了確認**
   - [ ] 全テスト項目PASS
   - [ ] バグ修正完了
   - [ ] ドキュメント更新
   - [ ] 本番デプロイ承認

---

最終更新: 2025-02-01