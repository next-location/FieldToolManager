# å¸³ç¥¨ç®¡ç†æ©Ÿèƒ½ä»•æ§˜æ›¸

## ç›®æ¬¡
1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [æ©Ÿèƒ½ä¸€è¦§ã¨å„ªå…ˆé †ä½](#2-æ©Ÿèƒ½ä¸€è¦§ã¨å„ªå…ˆé †ä½)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [UI/UXè¨­è¨ˆ](#4-uiuxè¨­è¨ˆ)
5. [å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º](#5-å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º)
6. [APIè¨­è¨ˆ](#6-apiè¨­è¨ˆ)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶](#7-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶)
8. [ä»–æ©Ÿèƒ½ã¨ã®é€£æº](#8-ä»–æ©Ÿèƒ½ã¨ã®é€£æº)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„
Field Tool Managerã«çµ±åˆã•ã‚ŒãŸå¸³ç¥¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã€å»ºç¯‰ç³»ä¼æ¥­ã®è¦‹ç©ãƒ»è«‹æ±‚ãƒ»æ”¯æ‰•ã„æ¥­å‹™ã‚’ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã™ã‚‹ã€‚

### 1.2 å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ç¾å ´ä½œæ¥­å“¡ï¼ˆstaffï¼‰**: ä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å‚ç…§
- **ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆleaderï¼‰**: è¦‹ç©ä½œæˆã€è«‹æ±‚æ›¸ç¢ºèª
- **ç®¡ç†è€…ï¼ˆadminï¼‰**: å…¨å¸³ç¥¨ã®ç®¡ç†ã€æ‰¿èªã€åˆ†æ

### 1.3 ä¸»è¦ãªä¾¡å€¤æä¾›
- å·¥äº‹å˜ä½ã§ã®åæ”¯ç®¡ç†
- ä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰ã®è‡ªå‹•è«‹æ±‚æ›¸ç”Ÿæˆ
- å–å¼•å…ˆï¼ˆå…ƒè«‹ã‘ãƒ»ä¸‹è«‹ã‘ï¼‰ã¨ã®å¸³ç¥¨ç®¡ç†ä¸€å…ƒåŒ–
- ä¼šè¨ˆã‚½ãƒ•ãƒˆã¸ã®ãƒ‡ãƒ¼ã‚¿é€£æº

---

## 2. æ©Ÿèƒ½ä¸€è¦§ã¨å„ªå…ˆé †ä½

### Phase 1: åŸºæœ¬å¸³ç¥¨æ©Ÿèƒ½ï¼ˆMVPï¼‰
```
å„ªå…ˆåº¦: æœ€é«˜
å®Ÿè£…æœŸé–“: 2ãƒ¶æœˆ
```

#### 2.1 è¦‹ç©æ›¸æ©Ÿèƒ½
- è¦‹ç©æ›¸ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- å·¥äº‹æƒ…å ±ã¨ã®ç´ä»˜ã‘
- è¦‹ç©æ›¸PDFå‡ºåŠ›
- è¦‹ç©æ›¸è¤‡è£½æ©Ÿèƒ½
- è¦‹ç©æ›¸ã‹ã‚‰è«‹æ±‚æ›¸ã¸ã®å¤‰æ›

#### 2.2 è«‹æ±‚æ›¸æ©Ÿèƒ½
- è«‹æ±‚æ›¸ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- ä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆ
- è«‹æ±‚æ›¸PDFå‡ºåŠ›
- ã‚¤ãƒ³ãƒœã‚¤ã‚¹å¯¾å¿œï¼ˆé©æ ¼è«‹æ±‚æ›¸ï¼‰
- è«‹æ±‚æ›¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆä¸‹æ›¸ã/æ‰¿èªå¾…ã¡/ç™ºè¡Œæ¸ˆã¿/å…¥é‡‘æ¸ˆã¿ï¼‰

#### 2.3 åŸºæœ¬çš„ãªç®¡ç†æ©Ÿèƒ½
- å¸³ç¥¨ä¸€è¦§è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢ï¼‰
- è‡ªå‹•æ¡ç•ªæ©Ÿèƒ½
- å–å¼•å…ˆãƒã‚¹ã‚¿ã¨ã®é€£æº

### Phase 2: ç™ºæ³¨ãƒ»æ”¯æ‰•ç®¡ç†
```
å„ªå…ˆåº¦: é«˜
å®Ÿè£…æœŸé–“: 1.5ãƒ¶æœˆ
```

#### 2.4 ç™ºæ³¨æ›¸æ©Ÿèƒ½
- ç™ºæ³¨æ›¸ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼ˆææ–™ç™ºæ³¨ã€å¤–æ³¨ç™ºæ³¨ï¼‰
- ç™ºæ³¨æ›¸PDFå‡ºåŠ›
- ç™ºæ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

#### 2.5 æ”¯æ‰•ç®¡ç†
- æ”¯æ‰•é€šçŸ¥æ›¸ä½œæˆ
- è²·æ›é‡‘ç®¡ç†
- æ”¯æ‰•äºˆå®šè¡¨

#### 2.6 å…¥é‡‘ç®¡ç†
- å…¥é‡‘ç™»éŒ²ãƒ»æ¶ˆè¾¼
- å£²æ›é‡‘ç®¡ç†
- å…¥é‡‘äºˆå®šè¡¨

### Phase 3: å·¥äº‹åŸä¾¡ç®¡ç†
```
å„ªå…ˆåº¦: ä¸­
å®Ÿè£…æœŸé–“: 2ãƒ¶æœˆ
```

#### 2.7 å·¥äº‹åˆ¥åæ”¯ç®¡ç†
- å·¥äº‹å°å¸³æ©Ÿèƒ½
- å·¥äº‹åˆ¥æç›Šè¨ˆç®—
- åŸä¾¡ç®¡ç†ï¼ˆææ–™è²»ã€åŠ´å‹™è²»ã€å¤–æ³¨è²»ã€çµŒè²»ï¼‰
- äºˆç®—å®Ÿç¸¾å¯¾æ¯”

#### 2.8 ç´å“ãƒ»æ¤œåç®¡ç†
- ç´å“æ›¸ä½œæˆãƒ»ç®¡ç†
- æ¤œåç™»éŒ²
- å‡ºæ¥é«˜ç®¡ç†

### Phase 4: åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
```
å„ªå…ˆåº¦: ä¸­
å®Ÿè£…æœŸé–“: 1ãƒ¶æœˆ
```

#### 2.9 å£²ä¸Šåˆ†æ
- æœˆæ¬¡ãƒ»å¹´æ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ
- å–å¼•å…ˆåˆ¥å£²ä¸Šåˆ†æ
- å·¥äº‹åˆ¥åç›Šåˆ†æ

#### 2.10 è³‡é‡‘ç¹°ã‚Šç®¡ç†
- è³‡é‡‘ç¹°ã‚Šäºˆæ¸¬è¡¨
- å…¥å‡ºé‡‘äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æ

### Phase 5: è‡ªå‹•åŒ–ãƒ»é€£æºå¼·åŒ–
```
å„ªå…ˆåº¦: ä½
å®Ÿè£…æœŸé–“: 1.5ãƒ¶æœˆ
```

#### 2.11 è‡ªå‹•åŒ–æ©Ÿèƒ½
- æ”¯æ‰•æœŸæ—¥ã‚¢ãƒ©ãƒ¼ãƒˆ
- å…¥é‡‘é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆ
- å®šæœŸè«‹æ±‚æ©Ÿèƒ½
- è‡ªå‹•ç£ä¿ƒãƒ¡ãƒ¼ãƒ«

#### 2.12 å¤–éƒ¨é€£æº
- ä¼šè¨ˆã‚½ãƒ•ãƒˆé€£æºï¼ˆCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½
- é›»å­å¸³ç°¿ä¿å­˜æ³•å¯¾å¿œ

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### estimatesï¼ˆè¦‹ç©æ›¸ï¼‰
```sql
CREATE TABLE estimates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  estimate_number TEXT NOT NULL, -- è¦‹ç©ç•ªå·ï¼ˆEST-2024-0001ï¼‰
  client_id UUID REFERENCES clients(id), -- å–å¼•å…ˆãƒã‚¹ã‚¿å‚ç…§
  project_id UUID REFERENCES projects(id), -- å·¥äº‹ãƒã‚¹ã‚¿å‚ç…§

  -- è¦‹ç©æƒ…å ±
  estimate_date DATE NOT NULL,
  valid_until DATE,
  title TEXT NOT NULL,

  -- é‡‘é¡
  subtotal DECIMAL(12, 2) NOT NULL,
  tax_amount DECIMAL(12, 2) NOT NULL,
  total_amount DECIMAL(12, 2) NOT NULL,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT NOT NULL CHECK (status IN ('draft', 'sent', 'accepted', 'rejected', 'expired')),

  -- æ‹…å½“è€…
  created_by UUID REFERENCES users(id),
  approved_by UUID REFERENCES users(id),

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  notes TEXT,
  internal_notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP,

  UNIQUE(organization_id, estimate_number)
);
```

#### estimate_itemsï¼ˆè¦‹ç©æ˜ç´°ï¼‰
```sql
CREATE TABLE estimate_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  estimate_id UUID NOT NULL REFERENCES estimates(id) ON DELETE CASCADE,

  -- æ˜ç´°æƒ…å ±
  display_order INTEGER NOT NULL,
  item_type TEXT NOT NULL CHECK (item_type IN ('material', 'labor', 'subcontract', 'expense', 'other')),
  item_code TEXT,
  item_name TEXT NOT NULL,
  description TEXT,

  -- æ•°é‡ãƒ»å˜ä¾¡
  quantity DECIMAL(10, 2) NOT NULL,
  unit TEXT NOT NULL,
  unit_price DECIMAL(12, 2) NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,

  -- ç¨ç‡
  tax_rate DECIMAL(5, 2) NOT NULL DEFAULT 10.0,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### invoicesï¼ˆè«‹æ±‚æ›¸ï¼‰
```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  invoice_number TEXT NOT NULL, -- è«‹æ±‚ç•ªå·ï¼ˆINV-2024-0001ï¼‰
  estimate_id UUID REFERENCES estimates(id), -- è¦‹ç©æ›¸ã‹ã‚‰ã®å¤‰æ›
  client_id UUID REFERENCES clients(id),
  project_id UUID REFERENCES projects(id),

  -- è«‹æ±‚æƒ…å ±
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL,
  title TEXT NOT NULL,

  -- é‡‘é¡
  subtotal DECIMAL(12, 2) NOT NULL,
  tax_amount DECIMAL(12, 2) NOT NULL,
  total_amount DECIMAL(12, 2) NOT NULL,
  paid_amount DECIMAL(12, 2) DEFAULT 0, -- å…¥é‡‘æ¸ˆã¿é‡‘é¡

  -- ã‚¤ãƒ³ãƒœã‚¤ã‚¹å¯¾å¿œ
  is_qualified_invoice BOOLEAN DEFAULT false,
  invoice_registration_number TEXT, -- T + 13æ¡

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT NOT NULL CHECK (status IN ('draft', 'approved', 'sent', 'partially_paid', 'paid', 'overdue', 'cancelled')),

  -- æ‰¿èª
  created_by UUID REFERENCES users(id),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,

  -- é€ä»˜è¨˜éŒ²
  sent_at TIMESTAMP,
  sent_method TEXT, -- email, postal, hand_delivery

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  notes TEXT,
  internal_notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP,

  UNIQUE(organization_id, invoice_number)
);
```

#### invoice_itemsï¼ˆè«‹æ±‚æ˜ç´°ï¼‰
```sql
CREATE TABLE invoice_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_id UUID NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
  work_report_id UUID REFERENCES work_reports(id), -- ä½œæ¥­å ±å‘Šæ›¸ã¨ã®é€£æº

  -- æ˜ç´°æƒ…å ±ï¼ˆestimate_itemsã¨åŒæ§˜ã®æ§‹é€ ï¼‰
  display_order INTEGER NOT NULL,
  item_type TEXT NOT NULL CHECK (item_type IN ('material', 'labor', 'subcontract', 'expense', 'other')),
  item_code TEXT,
  item_name TEXT NOT NULL,
  description TEXT,

  quantity DECIMAL(10, 2) NOT NULL,
  unit TEXT NOT NULL,
  unit_price DECIMAL(12, 2) NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,

  tax_rate DECIMAL(5, 2) NOT NULL DEFAULT 10.0,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### purchase_ordersï¼ˆç™ºæ³¨æ›¸ï¼‰
```sql
CREATE TABLE purchase_orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  order_number TEXT NOT NULL, -- ç™ºæ³¨ç•ªå·ï¼ˆPO-2024-0001ï¼‰
  supplier_id UUID REFERENCES clients(id), -- ä»•å…¥å…ˆ
  project_id UUID REFERENCES projects(id),

  -- ç™ºæ³¨æƒ…å ±
  order_date DATE NOT NULL,
  delivery_date DATE,
  delivery_location TEXT,

  -- é‡‘é¡
  subtotal DECIMAL(12, 2) NOT NULL,
  tax_amount DECIMAL(12, 2) NOT NULL,
  total_amount DECIMAL(12, 2) NOT NULL,

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT NOT NULL CHECK (status IN ('draft', 'ordered', 'partially_received', 'received', 'cancelled')),

  -- æ‰¿èª
  created_by UUID REFERENCES users(id),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  notes TEXT,
  internal_notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP,

  UNIQUE(organization_id, order_number)
);
```

#### paymentsï¼ˆå…¥å‡ºé‡‘è¨˜éŒ²ï¼‰
```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),

  -- å…¥å‡ºé‡‘ã‚¿ã‚¤ãƒ—
  payment_type TEXT NOT NULL CHECK (payment_type IN ('receipt', 'payment')), -- å…¥é‡‘/æ”¯æ‰•

  -- é–¢é€£å¸³ç¥¨
  invoice_id UUID REFERENCES invoices(id),
  purchase_order_id UUID REFERENCES purchase_orders(id),

  -- æ”¯æ‰•æƒ…å ±
  payment_date DATE NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,
  payment_method TEXT NOT NULL CHECK (payment_method IN ('bank_transfer', 'cash', 'check', 'credit_card', 'other')),

  -- éŠ€è¡Œæƒ…å ±
  bank_name TEXT,
  bank_account_number TEXT,
  reference_number TEXT,

  -- è¨˜éŒ²è€…
  recorded_by UUID REFERENCES users(id),

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  notes TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP
);
```

#### projectsï¼ˆå·¥äº‹ãƒã‚¹ã‚¿ï¼‰
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  project_code TEXT NOT NULL, -- å·¥äº‹ç•ªå·
  project_name TEXT NOT NULL,
  client_id UUID REFERENCES clients(id),

  -- å·¥æœŸ
  start_date DATE,
  end_date DATE,

  -- é‡‘é¡
  contract_amount DECIMAL(12, 2), -- å¥‘ç´„é‡‘é¡
  budget_amount DECIMAL(12, 2), -- äºˆç®—é‡‘é¡

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT NOT NULL CHECK (status IN ('planning', 'in_progress', 'completed', 'cancelled')),

  -- æ‹…å½“è€…
  project_manager_id UUID REFERENCES users(id),

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP,

  UNIQUE(organization_id, project_code)
);
```

### 3.2 çµ„ç¹”ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼ˆã‚¤ãƒ³ãƒœã‚¤ã‚¹å¯¾å¿œï¼‰

#### organizations ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
```sql
-- è‡ªç¤¾ã®ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå·ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã« organizationsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µ
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS tax_registration_number TEXT;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS is_qualified_invoice_issuer BOOLEAN DEFAULT false;
ALTER TABLE organizations ADD COLUMN IF NOT EXISTS company_seal_url TEXT; -- ä¼šç¤¾å°ã®ç”»åƒURL

-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
COMMENT ON COLUMN organizations.tax_registration_number IS 'é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ç™»éŒ²ç•ªå·ï¼ˆT + 13æ¡ï¼‰';
COMMENT ON COLUMN organizations.is_qualified_invoice_issuer IS 'é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ã‹ã©ã†ã‹';
COMMENT ON COLUMN organizations.company_seal_url IS 'ä¼šç¤¾å°ã®ç”»åƒURLï¼ˆè«‹æ±‚æ›¸ç­‰ã«ä½¿ç”¨ï¼‰';
```

### 3.3 å–å¼•å…ˆãƒã‚¹ã‚¿ã¨ã®é€£æºè¨­è¨ˆ

#### å–å¼•å…ˆæƒ…å ±ã®è‡ªå‹•å…¥åŠ›ãƒ•ãƒ­ãƒ¼
```typescript
// è«‹æ±‚æ›¸ä½œæˆæ™‚ã«å–å¼•å…ˆãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã‚‹é …ç›®
interface ClientToInvoiceMapping {
  // åŸºæœ¬æƒ…å ±
  client_name: string;           // clients.name â†’ è«‹æ±‚æ›¸ã®å®›å…ˆ
  client_address: string;         // clients.address â†’ è«‹æ±‚æ›¸ã®é€ä»˜å…ˆ

  // ã‚¤ãƒ³ãƒœã‚¤ã‚¹é–¢é€£
  client_tax_registration_number: string; // clients.tax_registration_number
  is_client_tax_exempt: boolean;         // clients.is_tax_exempt

  // æ”¯æ‰•æ¡ä»¶
  payment_terms: string;          // clients.payment_terms â†’ æ”¯æ‰•æ¡ä»¶
  payment_method: string;         // clients.payment_method â†’ æ”¯æ‰•æ–¹æ³•
  payment_due_days: number;       // clients.payment_due_days â†’ æœŸæ—¥è¨ˆç®—ç”¨

  // éŠ€è¡Œæƒ…å ±ï¼ˆæŒ¯è¾¼å…ˆã¨ã—ã¦è¡¨ç¤ºï¼‰
  bank_name: string;              // clients.bank_name
  branch_name: string;            // clients.branch_name
  account_type: string;           // clients.account_type
  account_number: string;         // clients.account_number
  account_name: string;           // clients.account_name

  // ä¸ä¿¡ç®¡ç†
  credit_limit: number;           // clients.credit_limit â†’ ä¸ä¿¡ãƒã‚§ãƒƒã‚¯ç”¨
  current_balance: number;        // clients.current_balance â†’ å£²æ›é‡‘æ®‹é«˜
}

// å…ç¨äº‹æ¥­è€…ã¨ã®å–å¼•æ™‚ã®è­¦å‘Š
async function validateInvoiceCreation(clientId: string) {
  const client = await getClient(clientId);

  if (client.is_tax_exempt) {
    // è­¦å‘Šè¡¨ç¤º
    showWarning({
      title: "å…ç¨äº‹æ¥­è€…ã¨ã®å–å¼•",
      message: "ã“ã®å–å¼•å…ˆã¯å…ç¨äº‹æ¥­è€…ã§ã™ã€‚ä»•å…¥ç¨é¡æ§é™¤ã®å¯¾è±¡å¤–ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
      details: [
        "2029å¹´9æœˆ30æ—¥ã¾ã§: ä»•å…¥ç¨é¡ç›¸å½“é¡ã®80%æ§é™¤å¯",
        "2029å¹´10æœˆ1æ—¥ä»¥é™: æ§é™¤ä¸å¯"
      ]
    });
  }

  // ä¸ä¿¡é™åº¦é¡ãƒã‚§ãƒƒã‚¯
  const newInvoiceAmount = calculateInvoiceAmount();
  const totalOutstanding = client.current_balance + newInvoiceAmount;

  if (totalOutstanding > client.credit_limit) {
    showWarning({
      title: "ä¸ä¿¡é™åº¦é¡è¶…é",
      message: `ä¸ä¿¡é™åº¦é¡ï¼ˆ${formatCurrency(client.credit_limit)}ï¼‰ã‚’è¶…éã—ã¾ã™ã€‚`,
      currentBalance: client.current_balance,
      newAmount: newInvoiceAmount,
      total: totalOutstanding
    });
  }
}
```

### 3.4 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
```sql
-- è¦‹ç©æ›¸
CREATE INDEX idx_estimates_org_status ON estimates(organization_id, status);
CREATE INDEX idx_estimates_client ON estimates(client_id);
CREATE INDEX idx_estimates_project ON estimates(project_id);
CREATE INDEX idx_estimates_date ON estimates(estimate_date DESC);

-- è«‹æ±‚æ›¸
CREATE INDEX idx_invoices_org_status ON invoices(organization_id, status);
CREATE INDEX idx_invoices_client ON invoices(client_id);
CREATE INDEX idx_invoices_project ON invoices(project_id);
CREATE INDEX idx_invoices_due_date ON invoices(due_date);

-- ç™ºæ³¨æ›¸
CREATE INDEX idx_purchase_orders_org_status ON purchase_orders(organization_id, status);
CREATE INDEX idx_purchase_orders_supplier ON purchase_orders(supplier_id);
CREATE INDEX idx_purchase_orders_project ON purchase_orders(project_id);

-- å…¥å‡ºé‡‘
CREATE INDEX idx_payments_org_type ON payments(organization_id, payment_type);
CREATE INDEX idx_payments_invoice ON payments(invoice_id);
CREATE INDEX idx_payments_date ON payments(payment_date DESC);

-- å·¥äº‹
CREATE INDEX idx_projects_org_status ON projects(organization_id, status);
CREATE INDEX idx_projects_client ON projects(client_id);
```

---

## 4. UI/UXè¨­è¨ˆ

### 4.1 ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹æˆ

#### ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ•´ç†
```
ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”œâ”€â”€ ãƒ›ãƒ¼ãƒ 
â””â”€â”€ é€šçŸ¥

ğŸ”§ é“å…·ç®¡ç†
â”œâ”€â”€ é“å…·ä¸€è¦§
â”œâ”€â”€ QRã‚¹ã‚­ãƒ£ãƒ³
â”œâ”€â”€ ç§»å‹•å±¥æ­´
â””â”€â”€ ã‚«ãƒ†ã‚´ãƒªè¨­å®š

ğŸ“ æ¥­å‹™ç®¡ç†
â”œâ”€â”€ ä½œæ¥­å ±å‘Šæ›¸
â”œâ”€â”€ å‹¤æ€ ç®¡ç†
â””â”€â”€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

ğŸ’° å¸³ç¥¨ç®¡ç† â† NEW
â”œâ”€â”€ è¦‹ç©ãƒ»è«‹æ±‚
â”‚   â”œâ”€â”€ è¦‹ç©æ›¸ä¸€è¦§
â”‚   â”œâ”€â”€ è«‹æ±‚æ›¸ä¸€è¦§
â”‚   â””â”€â”€ é ˜åæ›¸ä¸€è¦§
â”œâ”€â”€ ç™ºæ³¨ãƒ»æ”¯æ‰•
â”‚   â”œâ”€â”€ ç™ºæ³¨æ›¸ä¸€è¦§
â”‚   â”œâ”€â”€ æ”¯æ‰•äºˆå®š
â”‚   â””â”€â”€ è²·æ›é‡‘ç®¡ç†
â”œâ”€â”€ å…¥é‡‘ç®¡ç†
â”‚   â”œâ”€â”€ å…¥é‡‘äºˆå®š
â”‚   â”œâ”€â”€ å…¥é‡‘ç™»éŒ²
â”‚   â””â”€â”€ å£²æ›é‡‘ç®¡ç†
â””â”€â”€ åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
    â”œâ”€â”€ å£²ä¸Šåˆ†æ
    â”œâ”€â”€ å·¥äº‹åˆ¥åæ”¯
    â””â”€â”€ è³‡é‡‘ç¹°ã‚Šè¡¨

ğŸ“‹ ãƒã‚¹ã‚¿ç®¡ç†
â”œâ”€â”€ å–å¼•å…ˆç®¡ç†
â”œâ”€â”€ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
â”œâ”€â”€ å·¥äº‹ç®¡ç† â† NEW
â””â”€â”€ çµ„ç¹”è¨­å®š

âš™ï¸ è¨­å®š
â”œâ”€â”€ å¸³ç¥¨è¨­å®š â† NEW
â”‚   â”œâ”€â”€ æ¡ç•ªãƒ«ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â””â”€â”€ ç¨ç‡è¨­å®š
â””â”€â”€ ãã®ä»–è¨­å®š
```

### 4.2 ç”»é¢é·ç§»

#### è¦‹ç©æ›¸ä½œæˆãƒ•ãƒ­ãƒ¼
```
è¦‹ç©ä¸€è¦§ç”»é¢
    â†“
[æ–°è¦ä½œæˆ]ãƒœã‚¿ãƒ³
    â†“
è¦‹ç©ä½œæˆç”»é¢
â”œâ”€â”€ åŸºæœ¬æƒ…å ±å…¥åŠ›
â”‚   â”œâ”€â”€ å–å¼•å…ˆé¸æŠ
â”‚   â”œâ”€â”€ å·¥äº‹é¸æŠ
â”‚   â””â”€â”€ è¦‹ç©æ—¥ãƒ»æœ‰åŠ¹æœŸé™
â”œâ”€â”€ æ˜ç´°å…¥åŠ›
â”‚   â”œâ”€â”€ é …ç›®è¿½åŠ 
â”‚   â”œâ”€â”€ æ•°é‡ãƒ»å˜ä¾¡å…¥åŠ›
â”‚   â””â”€â”€ å°è¨ˆè‡ªå‹•è¨ˆç®—
â””â”€â”€ ä¿å­˜ãƒ»ç™ºè¡Œ
    â”œâ”€â”€ ä¸‹æ›¸ãä¿å­˜
    â”œâ”€â”€ PDFå‡ºåŠ›
    â””â”€â”€ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
```

#### è«‹æ±‚æ›¸ä½œæˆãƒ•ãƒ­ãƒ¼ï¼ˆä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰ï¼‰
```
ä½œæ¥­å ±å‘Šæ›¸è©³ç´°ç”»é¢
    â†“
[è«‹æ±‚æ›¸ä½œæˆ]ãƒœã‚¿ãƒ³
    â†“
è«‹æ±‚æ›¸ä½œæˆç”»é¢ï¼ˆãƒ‡ãƒ¼ã‚¿è‡ªå‹•å…¥åŠ›ï¼‰
â”œâ”€â”€ ä½œæ¥­å†…å®¹ãŒæ˜ç´°ã«åæ˜ 
â”œâ”€â”€ é‡‘é¡è‡ªå‹•è¨ˆç®—
â””â”€â”€ æ‰¿èªç”³è«‹
    â†“
æ‰¿èªè€…ç”»é¢
â”œâ”€â”€ å†…å®¹ç¢ºèª
â””â”€â”€ æ‰¿èª/å·®æˆ»ã—
    â†“
è«‹æ±‚æ›¸ç™ºè¡Œ
```

### 4.3 ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¾‹

#### è¦‹ç©æ›¸ä¸€è¦§ç”»é¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¦‹ç©æ›¸ç®¡ç†                                   [æ–°è¦ä½œæˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æ¤œç´¢: å–å¼•å…ˆåãƒ»è¦‹ç©ç•ªå·] [çŠ¶æ…‹: å…¨ã¦â–¼] [æœŸé–“: ä»Šæœˆâ–¼] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ è¦‹ç©ç•ªå·    å–å¼•å…ˆ      å·¥äº‹å     é‡‘é¡      çŠ¶æ…‹    â”‚
â”‚ â–¡ EST-2024-   Aå»ºè¨­      æ¸‹è°·ãƒ“ãƒ«   Â¥1,200,000 æ‰¿èªæ¸ˆ â”‚
â”‚   0125        æ ªå¼ä¼šç¤¾    æ”¹ä¿®å·¥äº‹             [è©³ç´°]  â”‚
â”‚ â–¡ EST-2024-   Bå·¥å‹™åº—    æ–°ç¯‰å·¥äº‹   Â¥3,500,000 ä¸‹æ›¸ã â”‚
â”‚   0124                                        [ç·¨é›†]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ä¸€æ‹¬æ“ä½œ: é¸æŠé …ç›®ã‚’â–¼] [CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¦‹ç©æ›¸ä½œæˆç”»é¢
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¦‹ç©æ›¸ä½œæˆ                         [ä¸‹æ›¸ãä¿å­˜] [ç™ºè¡Œ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºæœ¬æƒ…å ±                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ è¦‹ç©ç•ªå·: EST-2024-0126 (è‡ªå‹•æ¡ç•ª)              â”‚  â”‚
â”‚ â”‚ å–å¼•å…ˆ: [Aå»ºè¨­æ ªå¼ä¼šç¤¾           â–¼]             â”‚  â”‚
â”‚ â”‚ å·¥äº‹: [æ¸‹è°·ãƒ“ãƒ«æ”¹ä¿®å·¥äº‹         â–¼]             â”‚  â”‚
â”‚ â”‚ è¦‹ç©æ—¥: [2024/12/08]  æœ‰åŠ¹æœŸé™: [2025/01/08]    â”‚  â”‚
â”‚ â”‚ ä»¶å: [                                      ]  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚ æ˜ç´°                                    [è¡Œè¿½åŠ ]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ é …ç›®å        æ•°é‡  å˜ä½  å˜ä¾¡      é‡‘é¡        â”‚  â”‚
â”‚ â”‚ ææ–™è²»                                         â”‚  â”‚
â”‚ â”‚ â”œ ã‚»ãƒ¡ãƒ³ãƒˆ    10   è¢‹    Â¥5,000    Â¥50,000   â”‚  â”‚
â”‚ â”‚ â”” é‰„ç­‹        100  kg    Â¥1,200    Â¥120,000  â”‚  â”‚
â”‚ â”‚ åŠ´å‹™è²»                                         â”‚  â”‚
â”‚ â”‚ â”” ä½œæ¥­å“¡      5    äººæ—¥  Â¥25,000   Â¥125,000  â”‚  â”‚
â”‚ â”‚                                               â”‚  â”‚
â”‚ â”‚                          å°è¨ˆ:     Â¥295,000   â”‚  â”‚
â”‚ â”‚                          æ¶ˆè²»ç¨:   Â¥29,500    â”‚  â”‚
â”‚ â”‚                          åˆè¨ˆ:     Â¥324,500   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â”‚ å‚™è€ƒ                                                  â”‚
â”‚ [                                                  ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ

#### ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³è¡¨ç¤ºï¼ˆç¾å ´ã§ã®ç¢ºèªç”¨ï¼‰
- è«‹æ±‚æ›¸ãƒ»è¦‹ç©æ›¸ã®é–²è¦§
- ç°¡æ˜“çš„ãªæ‰¿èªæ“ä½œ
- å…¥é‡‘çŠ¶æ³ã®ç¢ºèª
- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆæ”¯æ‰•æœŸæ—¥ã‚¢ãƒ©ãƒ¼ãƒˆç­‰ï¼‰

---

## 5. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: MVPå®Ÿè£…ï¼ˆ2ãƒ¶æœˆï¼‰

#### Month 1
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] å–å¼•å…ˆãƒã‚¹ã‚¿æ©Ÿèƒ½
- [ ] å·¥äº‹ãƒã‚¹ã‚¿æ©Ÿèƒ½
- [ ] è¦‹ç©æ›¸CRUDæ©Ÿèƒ½
- [ ] è¦‹ç©æ›¸PDFå‡ºåŠ›

#### Month 2
- [ ] è«‹æ±‚æ›¸CRUDæ©Ÿèƒ½
- [ ] è«‹æ±‚æ›¸PDFå‡ºåŠ›
- [ ] ã‚¤ãƒ³ãƒœã‚¤ã‚¹å¯¾å¿œ
- [ ] è‡ªå‹•æ¡ç•ªæ©Ÿèƒ½
- [ ] åŸºæœ¬çš„ãªä¸€è¦§ãƒ»æ¤œç´¢æ©Ÿèƒ½

### Phase 2: ç™ºæ³¨ãƒ»æ”¯æ‰•ç®¡ç†ï¼ˆ1.5ãƒ¶æœˆï¼‰

#### Month 3
- [ ] ç™ºæ³¨æ›¸æ©Ÿèƒ½
- [ ] æ”¯æ‰•äºˆå®šè¡¨
- [ ] è²·æ›é‡‘ç®¡ç†

#### Month 3.5
- [ ] å…¥é‡‘ç™»éŒ²ãƒ»æ¶ˆè¾¼æ©Ÿèƒ½
- [ ] å£²æ›é‡‘ç®¡ç†
- [ ] å…¥é‡‘äºˆå®šè¡¨

### Phase 3: å·¥äº‹åŸä¾¡ç®¡ç†ï¼ˆ2ãƒ¶æœˆï¼‰

#### Month 4-5
- [ ] å·¥äº‹å°å¸³
- [ ] åŸä¾¡å…¥åŠ›æ©Ÿèƒ½
- [ ] å·¥äº‹åˆ¥æç›Šè¨ˆç®—
- [ ] äºˆç®—å®Ÿç¸¾å¯¾æ¯”

### Phase 4: åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ1ãƒ¶æœˆï¼‰

#### Month 6
- [ ] å£²ä¸Šåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] è³‡é‡‘ç¹°ã‚Šäºˆæ¸¬
- [ ] å„ç¨®ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›

### Phase 5: è‡ªå‹•åŒ–ãƒ»é€£æºï¼ˆ1.5ãƒ¶æœˆï¼‰

#### Month 7
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
- [ ] å®šæœŸè«‹æ±‚
- [ ] ä¼šè¨ˆã‚½ãƒ•ãƒˆé€£æº
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½

---

## 6. APIè¨­è¨ˆ

### 6.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

#### è¦‹ç©æ›¸API
```
GET    /api/estimates              # ä¸€è¦§å–å¾—
GET    /api/estimates/:id          # è©³ç´°å–å¾—
POST   /api/estimates              # æ–°è¦ä½œæˆ
PUT    /api/estimates/:id          # æ›´æ–°
DELETE /api/estimates/:id          # å‰Šé™¤
POST   /api/estimates/:id/copy     # è¤‡è£½
POST   /api/estimates/:id/approve  # æ‰¿èª
GET    /api/estimates/:id/pdf      # PDFç”Ÿæˆ
POST   /api/estimates/:id/convert-to-invoice # è«‹æ±‚æ›¸å¤‰æ›
```

#### è«‹æ±‚æ›¸API
```
GET    /api/invoices               # ä¸€è¦§å–å¾—
GET    /api/invoices/:id           # è©³ç´°å–å¾—
POST   /api/invoices               # æ–°è¦ä½œæˆ
PUT    /api/invoices/:id           # æ›´æ–°
DELETE /api/invoices/:id           # å‰Šé™¤
POST   /api/invoices/:id/approve   # æ‰¿èª
POST   /api/invoices/:id/send      # é€ä»˜è¨˜éŒ²
GET    /api/invoices/:id/pdf       # PDFç”Ÿæˆ
POST   /api/invoices/from-work-report # ä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰ç”Ÿæˆ
```

#### å…¥é‡‘API
```
GET    /api/payments               # ä¸€è¦§å–å¾—
POST   /api/payments               # å…¥é‡‘ç™»éŒ²
PUT    /api/payments/:id           # æ›´æ–°
DELETE /api/payments/:id           # å‰Šé™¤
POST   /api/payments/match         # æ¶ˆè¾¼å‡¦ç†
```

### 6.2 è«‹æ±‚æ›¸PDFç”Ÿæˆã®å®Ÿè£…è©³ç´°

#### ã‚¤ãƒ³ãƒœã‚¤ã‚¹å¯¾å¿œPDFç”Ÿæˆå‡¦ç†
```typescript
// è«‹æ±‚æ›¸PDFç”Ÿæˆæ™‚ã®è‡ªç¤¾ãƒ»å–å¼•å…ˆæƒ…å ±ã®çµ±åˆ
async function generateInvoicePDF(invoiceId: string) {
  const invoice = await getInvoice(invoiceId);
  const client = await getClient(invoice.client_id);
  const organization = await getOrganization(invoice.organization_id);

  // è‡ªç¤¾ã®ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå·ãƒã‚§ãƒƒã‚¯
  if (!organization.tax_registration_number && invoice.is_qualified_invoice) {
    throw new Error('é©æ ¼è«‹æ±‚æ›¸ã‚’ç™ºè¡Œã™ã‚‹ã«ã¯ã€çµ„ç¹”è¨­å®šã§ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²ç•ªå·ã‚’è¨­å®šã—ã¦ãã ã•ã„');
  }

  const pdfData = {
    // ç™ºè¡Œè€…ï¼ˆè‡ªç¤¾ï¼‰æƒ…å ±
    issuer: {
      name: organization.name,
      address: organization.address,
      tax_registration_number: organization.tax_registration_number,
      seal_url: organization.company_seal_url, // ä¼šç¤¾å°
    },

    // å®›å…ˆï¼ˆå–å¼•å…ˆï¼‰æƒ…å ± - clientsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è‡ªå‹•å–å¾—
    recipient: {
      name: client.name,
      postal_code: client.postal_code,
      address: client.address,
      contact_person: client.contact_person,
      // å…ç¨äº‹æ¥­è€…ã®å ´åˆã¯æ³¨è¨˜ã‚’è¿½åŠ 
      tax_note: client.is_tax_exempt ? 'â€»å…ç¨äº‹æ¥­è€…' : null,
    },

    // æ”¯æ‰•æƒ…å ± - clientsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è‡ªå‹•å–å¾—
    payment: {
      terms: client.payment_terms || 'è«‹æ±‚æ›¸ç™ºè¡Œæ—¥ã‚ˆã‚Š30æ—¥ä»¥å†…',
      method: client.payment_method,
      due_date: invoice.due_date,
      bank_account: client.bank_name ? {
        bank_name: client.bank_name,
        branch_name: client.branch_name,
        account_type: client.account_type,
        account_number: client.account_number,
        account_name: client.account_name,
      } : null,
    },

    // ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¶åº¦å¯¾å¿œã®ç¨ç‡åˆ¥é›†è¨ˆ
    tax_summary: generateTaxSummary(invoice.items),
  };

  return createPDF(pdfData);
}

// ç¨ç‡åˆ¥é›†è¨ˆå‡¦ç†
function generateTaxSummary(items: InvoiceItem[]) {
  const summary = items.reduce((acc, item) => {
    const rate = item.tax_rate.toString();
    if (!acc[rate]) {
      acc[rate] = { subtotal: 0, tax: 0, items: [] };
    }
    acc[rate].subtotal += item.amount;
    acc[rate].tax += item.amount * (item.tax_rate / 100);
    acc[rate].items.push(item.item_name);
    return acc;
  }, {} as Record<string, any>);

  return Object.entries(summary).map(([rate, data]) => ({
    tax_rate: parseFloat(rate),
    subtotal: data.subtotal,
    tax_amount: data.tax,
    total: data.subtotal + data.tax,
    is_reduced_rate: rate === '8', // 8%ã¯è»½æ¸›ç¨ç‡
  }));
}
```

### 6.3 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

#### è¦‹ç©æ›¸è©³ç´°
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "estimate_number": "EST-2024-0125",
  "client": {
    "id": "client-uuid",
    "name": "Aå»ºè¨­æ ªå¼ä¼šç¤¾",
    "contact_person": "å±±ç”°å¤ªéƒ"
  },
  "project": {
    "id": "project-uuid",
    "name": "æ¸‹è°·ãƒ“ãƒ«æ”¹ä¿®å·¥äº‹",
    "code": "PRJ-2024-001"
  },
  "estimate_date": "2024-12-08",
  "valid_until": "2025-01-08",
  "title": "æ¸‹è°·ãƒ“ãƒ«æ”¹ä¿®å·¥äº‹ è¦‹ç©æ›¸",
  "items": [
    {
      "id": "item-uuid-1",
      "item_type": "material",
      "item_name": "ã‚»ãƒ¡ãƒ³ãƒˆ",
      "quantity": 10,
      "unit": "è¢‹",
      "unit_price": 5000,
      "amount": 50000,
      "tax_rate": 10
    }
  ],
  "subtotal": 295000,
  "tax_amount": 29500,
  "total_amount": 324500,
  "status": "approved",
  "created_by": {
    "id": "user-uuid",
    "name": "ç”°ä¸­å¤ªéƒ"
  },
  "approved_by": {
    "id": "manager-uuid",
    "name": "ä½è—¤èŠ±å­"
  },
  "notes": "ç¾å ´çŠ¶æ³ã«ã‚ˆã‚Šè¿½åŠ å·¥äº‹ã®å¯èƒ½æ€§ã‚ã‚Š"
}
```

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

### 7.1 æ¨©é™ç®¡ç†

#### ãƒ­ãƒ¼ãƒ«åˆ¥æ¨©é™
| æ©Ÿèƒ½ | staff | leader | admin |
|------|-------|--------|-------|
| è¦‹ç©æ›¸é–²è¦§ | è‡ªåˆ†ãŒä½œæˆ | â—‹ | â—‹ |
| è¦‹ç©æ›¸ä½œæˆ | Ã— | â—‹ | â—‹ |
| è¦‹ç©æ›¸æ‰¿èª | Ã— | Ã— | â—‹ |
| è«‹æ±‚æ›¸é–²è¦§ | Ã— | â—‹ | â—‹ |
| è«‹æ±‚æ›¸ä½œæˆ | Ã— | â—‹ | â—‹ |
| è«‹æ±‚æ›¸æ‰¿èª | Ã— | Ã— | â—‹ |
| å…¥é‡‘ç™»éŒ² | Ã— | Ã— | â—‹ |
| å£²ä¸Šåˆ†æé–²è¦§ | Ã— | â–³ | â—‹ |
| å¸³ç¥¨è¨­å®šå¤‰æ›´ | Ã— | Ã— | â—‹ |

### 7.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·
- RLSã«ã‚ˆã‚‹çµ„ç¹”é–“ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- è«–ç†å‰Šé™¤ã«ã‚ˆã‚‹ç›£æŸ»è¨¼è·¡ä¿æŒ
- PDFç”Ÿæˆæ™‚ã®é›»å­é€ã‹ã—åŸ‹ã‚è¾¼ã¿
- æ“ä½œãƒ­ã‚°ã®è¨˜éŒ²

### 7.3 ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
- é›»å­å¸³ç°¿ä¿å­˜æ³•å¯¾å¿œ
- ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¶åº¦å¯¾å¿œ
- æ”¹ã–ã‚“é˜²æ­¢ï¼ˆãƒãƒƒã‚·ãƒ¥å€¤ä¿å­˜ï¼‰
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ3å¹´é–“ä¿å­˜ï¼‰

---

## 8. ä»–æ©Ÿèƒ½ã¨ã®é€£æº

### 8.1 å–å¼•å…ˆãƒã‚¹ã‚¿ã¨ã®è©³ç´°é€£æºä»•æ§˜

#### é€£æºãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```mermaid
graph LR
    A[å–å¼•å…ˆãƒã‚¹ã‚¿<br/>clients] --> B[è¦‹ç©æ›¸ä½œæˆ]
    A --> C[è«‹æ±‚æ›¸ä½œæˆ]
    A --> D[ç™ºæ³¨æ›¸ä½œæˆ]

    B --> E[è‡ªå‹•å…¥åŠ›é …ç›®<br/>ãƒ»ä¼šç¤¾å<br/>ãƒ»ä½æ‰€<br/>ãƒ»æ”¯æ‰•æ¡ä»¶]
    C --> F[è‡ªå‹•å…¥åŠ›é …ç›®<br/>ãƒ»ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·<br/>ãƒ»å…ç¨äº‹æ¥­è€…ãƒ•ãƒ©ã‚°<br/>ãƒ»éŠ€è¡Œå£åº§æƒ…å ±]
    D --> G[è‡ªå‹•å…¥åŠ›é …ç›®<br/>ãƒ»ä»•å…¥å…ˆæƒ…å ±<br/>ãƒ»æ”¯æ‰•æ–¹æ³•]

    C --> H[ä¸ä¿¡ãƒã‚§ãƒƒã‚¯<br/>ãƒ»é™åº¦é¡ç¢ºèª<br/>ãƒ»å£²æ›é‡‘æ®‹é«˜]
```

#### å–å¼•å…ˆé¸æŠæ™‚ã®è‡ªå‹•å‡¦ç†
```typescript
// å–å¼•å…ˆé¸æŠã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const ClientSelector = ({ onSelect, documentType }) => {
  const handleClientSelect = async (clientId: string) => {
    const client = await fetchClient(clientId);

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‡ªå‹•å…¥åŠ›
    switch(documentType) {
      case 'invoice':
        // è«‹æ±‚æ›¸ã®å ´åˆ
        return {
          // åŸºæœ¬æƒ…å ±
          client_name: client.name,
          client_address: formatAddress(client),

          // æ”¯æ‰•æ¡ä»¶ï¼ˆå–å¼•å…ˆãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•è¨­å®šï¼‰
          payment_terms: client.payment_terms,
          payment_method: client.payment_method,
          due_date: calculateDueDate(new Date(), client.payment_due_days),

          // ã‚¤ãƒ³ãƒœã‚¤ã‚¹é–¢é€£
          show_tax_registration: !client.is_tax_exempt,
          tax_warning: client.is_tax_exempt ? 'å…ç¨äº‹æ¥­è€…ã®ãŸã‚ä»•å…¥ç¨é¡æ§é™¤å¯¾è±¡å¤–' : null,

          // æŒ¯è¾¼å…ˆæƒ…å ±ï¼ˆè«‹æ±‚æ›¸ã«è¨˜è¼‰ï¼‰
          bank_info: formatBankInfo(client),
        };

      case 'purchase_order':
        // ç™ºæ³¨æ›¸ã®å ´åˆ
        return {
          supplier_name: client.name,
          supplier_address: formatAddress(client),
          delivery_location: client.default_delivery_location,
        };

      case 'estimate':
        // è¦‹ç©æ›¸ã®å ´åˆ
        return {
          client_name: client.name,
          client_title: client.contact_person ? `${client.contact_person} æ§˜` : 'å¾¡ä¸­',
          valid_days: client.estimate_valid_days || 30,
        };
    }
  };
};
```

### 8.2 ä½œæ¥­å ±å‘Šæ›¸ã¨ã®é€£æº
```typescript
// ä½œæ¥­å ±å‘Šæ›¸ã‹ã‚‰è«‹æ±‚æ›¸ã‚’ç”Ÿæˆ
async function createInvoiceFromWorkReport(workReportId: string) {
  const workReport = await getWorkReport(workReportId);

  const invoice = {
    client_id: workReport.client_id,
    project_id: workReport.project_id,
    items: workReport.work_items.map(item => ({
      item_type: 'labor',
      item_name: item.work_description,
      quantity: item.hours,
      unit: 'æ™‚é–“',
      unit_price: item.hourly_rate,
      amount: item.hours * item.hourly_rate
    })),
    notes: `ä½œæ¥­å ±å‘Šæ›¸ ${workReport.report_number} ã‚ˆã‚Šç”Ÿæˆ`
  };

  return createInvoice(invoice);
}
```

### 8.2 é“å…·ç®¡ç†ã¨ã®é€£æº
- ãƒ¬ãƒ³ã‚¿ãƒ«é“å…·ã®è«‹æ±‚æ›¸è‡ªå‹•ç”Ÿæˆ
- é“å…·è³¼å…¥æ™‚ã®ç™ºæ³¨æ›¸ä½œæˆ
- æ¸›ä¾¡å„Ÿå´è¨ˆç®—ã¨ã®é€£æº

### 8.3 å‹¤æ€ ç®¡ç†ã¨ã®é€£æº
- åŠ´å‹™è²»ã®è‡ªå‹•è¨ˆç®—
- æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®è«‹æ±‚æ˜ç´°ç”Ÿæˆ
- å¤–æ³¨äººå·¥ã®é›†è¨ˆ

### 8.4 é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº
- æ‰¿èªä¾é ¼é€šçŸ¥
- æ”¯æ‰•æœŸæ—¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
- å…¥é‡‘ç¢ºèªé€šçŸ¥

---

## ä»˜éŒ²

### A. ç”¨èªå®šç¾©
- **è¦‹ç©æ›¸**: å·¥äº‹ã®è²»ç”¨æ¦‚ç®—ã‚’ç¤ºã™æ›¸é¡
- **è«‹æ±‚æ›¸**: å®Œäº†ã—ãŸå·¥äº‹ã®ä»£é‡‘ã‚’è«‹æ±‚ã™ã‚‹æ›¸é¡
- **ç™ºæ³¨æ›¸**: ææ–™ã‚„å¤–æ³¨ã‚’ä¾é ¼ã™ã‚‹æ›¸é¡
- **æ¶ˆè¾¼**: è«‹æ±‚ã¨å…¥é‡‘ã‚’ç´ä»˜ã‘ã‚‹å‡¦ç†
- **å‡ºæ¥é«˜**: å·¥äº‹ã®é€²æ—ã«å¿œã˜ãŸå®Œæˆåº¦

### B. å‚è€ƒè³‡æ–™
- é›»å­å¸³ç°¿ä¿å­˜æ³•ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¶åº¦å®Ÿå‹™ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
- å»ºè¨­æ¥­ä¼šè¨ˆåŸºæº–

### C. ä»Šå¾Œã®æ‹¡å¼µäºˆå®š
- AI ã«ã‚ˆã‚‹è¦‹ç©ç²¾åº¦å‘ä¸Š
- OCRã«ã‚ˆã‚‹è«‹æ±‚æ›¸å–ã‚Šè¾¼ã¿
- éŠ€è¡ŒAPIé€£æºã«ã‚ˆã‚‹è‡ªå‹•æ¶ˆè¾¼
- ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ”¹ã–ã‚“é˜²æ­¢