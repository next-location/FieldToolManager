# 道具管理システム 設計・仕様書（SaaS型マルチテナント版）

## 目次
1. [システム概要](#1-システム概要)
2. [SaaS型アーキテクチャ](#2-saas型アーキテクチャ)
3. [ユーザーペルソナ](#3-ユーザーペルソナ)
4. [利用開始フロー](#4-利用開始フロー)
5. [情報アーキテクチャ](#5-情報アーキテクチャ)
6. [画面設計](#6-画面設計)
7. [QRスキャン機能](#7-qrスキャン機能)
8. [データモデル](#8-データモデル)
9. [技術仕様](#9-技術仕様)
10. [セキュリティ](#10-セキュリティ)
11. [課金・プラン管理](#11-課金プラン管理)
12. [拡張機能](#12-拡張機能)
13. [管理者機能](#13-管理者機能)
14. [導入・運用](#14-導入運用)
15. [開発ロードマップ](#15-開発ロードマップ)

---

## 1. システム概要

### 1.1 ビジネスモデル

本システムは**マルチテナントSaaS型**の道具管理システムです。

```
【提供形態】
複数企業が1つの統合システムを共有利用
- 企業ごとに完全にデータ分離
- サブドメインで企業を識別
- 月額課金制

【サービス提供者】
あなた（開発者）が統一環境を運用

【顧客企業】
各企業は独自のサブドメインでアクセス
例:
- a-kensetsu.tool-manager.com（A建設株式会社）
- b-tosou.tool-manager.com（B塗装）
- c-koumuten.tool-manager.com（C工務店）
```

---

### 1.2 課題と解決策

#### 顧客企業の課題
- 道具の数量・所在が不明確（現場 vs 会社倉庫）
- 20名程度のスタッフによる複雑な道具移動の管理困難
- アナログ管理によるDX化の遅れ

#### 解決策
全道具に**一意のID + QRコード**を付与し、スマホでスキャンするだけで**リアルタイムな在庫・所在管理**を実現

---

### 1.3 主要機能

#### 基本機能（全プラン共通）
1. **道具マスタ管理** - 道具情報のデジタル化
2. **在庫・所在管理** - リアルタイム在庫表示
3. **入出庫・移動管理** - QRスキャンによる履歴追跡
4. **低在庫アラート** - 在庫不足の自動通知
5. **基本レポート** - 移動履歴のCSV出力

#### プレミアム機能（上位プラン）
6. **損耗・修理管理** - 道具のライフサイクル管理
7. **コスト分析** - 購入・修理費用の分析
8. **高度なレポート** - グラフ化、詳細分析

#### 拡張機能（アドオン）
9. **見積管理** - 取引先への見積書作成・管理
10. **請求管理** - 請求書発行・支払い管理
11. **カスタムフィールド** - 企業ごとの独自項目追加

---

## 2. SaaS型アーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────┐
│           SaaS統合プラットフォーム                  │
│        （あなたが運用する単一環境）                 │
├─────────────────────────────────────────────────────┤
│  【フロントエンド】                                 │
│  Next.js 14 (App Router) + TypeScript               │
│  ホスティング: Vercel                               │
│                                                     │
│  【バックエンド・データベース】                     │
│  Supabase PostgreSQL                                │
│  - マルチテナント対応（organization_id分離）       │
│  - Row Level Security (RLS)                         │
│  - Realtime Subscriptions                           │
│                                                     │
│  【認証】                                           │
│  Supabase Auth (JWT)                                │
│                                                     │
│  【ストレージ】                                     │
│  Supabase Storage（画像・PDF）                      │
│                                                     │
│  【決済・課金】                                     │
│  Stripe                                             │
│  - サブスクリプション管理                           │
│  - 請求書自動発行                                   │
│  - Webhook連携                                      │
└─────────────────────────────────────────────────────┘
                        ↓ サブドメイン振り分け
    ┌─────────────┬─────────────┬─────────────┐
    │  企業A      │  企業B      │  企業C      │
    │ a-kensetsu. │ b-tosou.    │ c-koumuten. │
    │ tool-mgr.com│ tool-mgr.com│ tool-mgr.com│
    └─────────────┴─────────────┴─────────────┘
```

---

### 2.2 データ分離の仕組み

#### マルチテナント設計の核心
```sql
-- 全テーブルに organization_id を持たせる
CREATE TABLE tools (
  id UUID PRIMARY KEY,
  organization_id UUID NOT NULL,  -- ← 企業を識別
  tool_code TEXT,
  name TEXT,
  ...
);

-- Row Level Security で自動的にフィルタリング
CREATE POLICY "tools_isolation"
  ON tools FOR ALL
  USING (
    organization_id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );
```

**結果**: ユーザーは自分の企業のデータしか見えない・操作できない

---

### 2.3 サブドメイン対応

#### URL構造
```
マーケティングサイト: https://www.tool-manager.com
管理画面（あなた用）: https://admin.tool-manager.com

顧客企業アプリ:
- A建設: https://a-kensetsu.tool-manager.com
- B塗装: https://b-tosou.tool-manager.com
- C工務店: https://c-koumuten.tool-manager.com
```

#### 技術実装
```typescript
// middleware.ts でサブドメインを抽出
export function middleware(request: NextRequest) {
  const hostname = request.headers.get('host') || '';
  const subdomain = hostname.split('.')[0];

  // サブドメインに応じて組織を特定
  response.headers.set('x-organization-subdomain', subdomain);
  return response;
}
```

---

## 3. ユーザーペルソナ

### 3.1 エンドユーザー（顧客企業のスタッフ）

#### ペルソナA: 現場スタッフ（一般作業者）
- **年齢**: 20-50代
- **ITリテラシー**: 低〜中（スマホの基本操作は可能）
- **利用環境**: 屋外現場、手袋着用、雨天・日光下
- **主な課題**: 作業中の忙しい時に複雑な操作は困難
- **ニーズ**: 簡単・迅速・最小タップ数での道具スキャン
- **利用頻度**: 毎日5-20回（道具の持ち出し・返却）

#### ペルソナB: 現場リーダー
- **年齢**: 30-50代
- **ITリテラシー**: 中
- **利用環境**: 現場と会社の両方、PC・スマホ併用
- **主な課題**: 複数現場の道具在庫を把握する必要
- **ニーズ**: 現場ごとの在庫一覧、チェックリスト、レポート出力
- **利用頻度**: 毎日（朝の在庫確認、夕方の報告）

#### ペルソナC: 経営者・管理者
- **年齢**: 40-60代
- **ITリテラシー**: 低〜中
- **利用環境**: 主にオフィスのPC、たまにスマホ
- **主な課題**: 全体像の把握と投資判断
- **ニーズ**: シンプルなダッシュボード、発注アラート、コスト管理
- **利用頻度**: 週2-3回（経営レポート確認）

---

### 3.2 サービス提供者（あなた）

#### ペルソナD: システム管理者・運営者
- **役割**: SaaS全体の運用・顧客管理
- **主なタスク**:
  - 新規顧客のオンボーディング
  - 顧客企業の設定変更
  - 課金・請求管理
  - システム監視・メンテナンス
  - カスタマーサポート
- **利用画面**: admin.tool-manager.com（専用管理画面）

---

## 4. 利用開始フロー

### 4.1 顧客企業の導入フロー

```
【ステップ1】申し込み・契約（1日）
┌─────────────────────────────────┐
│ 1. マーケティングサイトで申込  │
│    www.tool-manager.com         │
│ 2. 企業情報入力                 │
│    - 会社名: A建設株式会社      │
│    - 希望サブドメイン: a-kensetsu│
│    - 管理者メール: admin@a.com  │
│ 3. プラン選択                   │
│    - トライアル（14日間無料）   │
│    - ベーシック（¥25,000/月）   │
│    - プレミアム（¥50,000/月）   │
└─────────────────────────────────┘
            ↓
【ステップ2】初期設定（1-2日）
┌─────────────────────────────────┐
│ 1. 管理者アカウント作成         │
│ 2. スタッフアカウント追加       │
│    - メール招待で簡単登録       │
│ 3. 現場マスタ登録               │
│    - 会社倉庫                   │
│    - 現場A、現場B...            │
│ 4. 道具カテゴリ設定             │
│    - 電動工具、手工具、測定器... │
└─────────────────────────────────┘
            ↓
【ステップ3】道具登録（1週間）
┌─────────────────────────────────┐
│ 1. 道具の棚卸し                 │
│ 2. 道具マスタへ一括登録         │
│    - CSVインポート機能          │
│    - または手動登録             │
│ 3. QRコードラベル印刷           │
│    - システムから一括PDF出力    │
│ 4. QRコードを道具に貼付         │
└─────────────────────────────────┘
            ↓
【ステップ4】トレーニング（1-2日）
┌─────────────────────────────────┐
│ 1. 管理者向けトレーニング       │
│    - 基本操作、設定方法         │
│ 2. スタッフ向けトレーニング     │
│    - QRスキャンの使い方         │
│ 3. 運用ルール策定               │
└─────────────────────────────────┘
            ↓
【ステップ5】本格運用開始
┌─────────────────────────────────┐
│ ✅ 道具移動時のQRスキャン      │
│ ✅ 日次の在庫確認              │
│ ✅ 週次の棚卸し                │
└─────────────────────────────────┘
```

---

### 4.2 あなた（提供者）の運用フロー

```
【日常運用】
┌─────────────────────────────────┐
│ 毎日:                           │
│ - 顧客からの問い合わせ対応      │
│ - システム監視（エラーチェック）│
│                                 │
│ 週次:                           │
│ - 新規顧客のオンボーディング    │
│ - MRR（月間経常収益）確認       │
│ - 機能改善の優先順位付け        │
│                                 │
│ 月次:                           │
│ - 請求処理の確認（Stripe自動）  │
│ - 顧客満足度調査                │
│ - 解約リスク顧客のフォロー      │
└─────────────────────────────────┘
```

---

## 5. 情報アーキテクチャ

### 5.1 ナビゲーション構造（エンドユーザー画面）

#### モバイル：下部タブバー
```
┌─────────────────────────────────────┐
│  ホーム   スキャン   道具   履歴   設定  │
│   🏠      📷      🔧     📋     ⚙️   │
└─────────────────────────────────────┘
```

**設計理由**:
- スマホ片手操作で親指が届きやすい下部配置
- 最頻度機能（ホーム・スキャン）を左側に
- アイコン+テキストで視認性向上

#### デスクトップ：サイドバー
```
┌────────┬────────────────────────┐
│ ロゴ   │  A建設株式会社         │
│        │  プレミアムプラン       │
├────────┼────────────────────────┤
│🏠 ホーム│                        │
│📷スキャン│      メインコンテンツ  │
│🔧 道具 │                        │
│📋 履歴 │                        │
│⚙️ 設定 │                        │
│        │                        │
│━━拡張━━│                        │
│📄 見積 │                        │
│💳 請求 │                        │
└────────┴────────────────────────┘
```

---

### 5.2 権限別アクセス制御

#### 企業内の権限（顧客企業のユーザー）
| 機能 | 一般スタッフ | 現場リーダー | 企業管理者 |
|------|-------------|-------------|-----------|
| ダッシュボード閲覧 | ○ | ○ | ○ |
| QRスキャン | ○ | ○ | ○ |
| 道具検索・閲覧 | ○ | ○ | ○ |
| 道具登録・編集 | × | △（制限付き） | ○ |
| 現場マスタ管理 | × | × | ○ |
| ユーザー管理 | × | × | ○ |
| プラン変更・請求 | × | × | ○ |
| 拡張機能（見積等） | × | △ | ○ |

#### システム管理者権限（あなた）
- **全顧客企業のデータ閲覧**（トラブルシューティング用）
- **顧客企業の設定変更**
- **機能フラグの ON/OFF**
- **課金・請求管理**
- **システム全体の監視**

---

## 6. 画面設計

### 6.1 ホーム（ダッシュボード）

#### レイアウト
```
┌─────────────────────────────────┐
│ [ヘッダー]                      │
│ A建設株式会社      [通知🔔 3]  │
│ プレミアムプラン                │
├─────────────────────────────────┤
│ 【在庫サマリー】                │
│ ┌───────┐ ┌───────┐ ┌───────┐ │
│ │ 総在庫 │ │現場中 │ │会社  │ │
│ │ 324個│ │ 187個│ │ 137個│ │
│ └───────┘ └───────┘ └───────┘ │
├─────────────────────────────────┤
│ 【要注意アラート】 🚨           │
│ ⚠️ 在庫不足 (3件)              │
│ ・ドライバーセット 残り2個      │
│ → 発注管理へ                   │
│                                 │
│ 🔧 長期未返却 (2件)            │
│ ・現場A: ハンマー (7日間)      │
│ → 詳細を見る                   │
├─────────────────────────────────┤
│ 【直近の移動履歴】（最新5件）   │
│ 🔵 10:30 田中太郎            │
│    ドライバーセット → 現場A     │
│ 🟢 09:15 佐藤花子            │
│    サンダー → 会社倉庫         │
└─────────────────────────────────┘
```

#### UX配慮ポイント
- **3秒ルール**: 開いて3秒以内に重要情報を把握
- **企業ブランディング**: ヘッダーに企業名・プラン表示
- **色分け**: 在庫（青）、警告（赤・黄）、正常（緑）
- **大きな数字**: 24px以上のフォント
- **直接アクション**: アラートから該当機能へワンタップ遷移

---

### 6.2 スキャン（入出庫・移動）

#### スキャンフロー

**ステップ1: アクション選択**
```
┌─────────────────────────────────┐
│ 道具をスキャン                  │
├─────────────────────────────────┤
│ どの操作をしますか？            │
│ ┌─────────────────────────────┐│
│ │ 📤 持ち出し（会社→現場）    ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 📥 返却（現場→会社）        ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 🔄 現場間移動               ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

**ステップ2: スキャン実行**
```
┌─────────────────────────────────┐
│ [×]                   [💡ライト]│
│                                 │
│    ┌─────────────────┐          │
│    │                 │          │
│    │  QRコード       │          │
│    │  読み取り枠     │          │
│    │                 │          │
│    └─────────────────┘          │
│                                 │
│  道具のQRコードを枠内に合わせる │
│                                 │
│ ┌─────────────────────────────┐│
│ │ 📷 カメラでスキャン         ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ ⌨️  手動でID入力            ││
│ └─────────────────────────────┘│
│                                 │
│ 💡 ヒント: QRコードが汚れている │
│ 場合は、手動入力をご利用ください│
└─────────────────────────────────┘
```

**ステップ3: 詳細入力**
```
┌─────────────────────────────────┐
│ スキャン完了 ✓                  │
├─────────────────────────────────┤
│ 道具: ドライバーセット #A-0123  │
│ 現在地: 会社倉庫                │
├─────────────────────────────────┤
│ 移動先の現場を選択              │
│ ┌─────────────────────────────┐│
│ │ 🏗️ 現場A（渋谷ビル改修）   ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 🏗️ 現場B（新宿マンション）  ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 🏗️ 現場C（横浜倉庫）        ││
│ └─────────────────────────────┘│
│                                 │
│ 備考（任意）                    │
│ ┌─────────────────────────────┐│
│ │ 例: 緊急修理のため          ││
│ └─────────────────────────────┘│
│                                 │
│ ┌─────────────────────────────┐│
│ │     登録する ✓             ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

**ステップ4: 完了フィードバック**
```
┌─────────────────────────────────┐
│         ✅                      │
│     登録完了しました！          │
│                                 │
│ ドライバーセット #A-0123        │
│ 会社倉庫 → 現場A                │
│                                 │
│ ┌─────────────────────────────┐│
│ │   続けてスキャン            ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │   ホームに戻る              ││
│ └─────────────────────────────┘│
│                                 │
│ (3秒後に自動でスキャン画面へ)   │
└─────────────────────────────────┘
```

#### UX配慮ポイント
- **ワンタップアクセス**: 下部タブの中央にスキャンボタン
- **大きなボタン**: 最小44px×44px（手袋対応）
- **フラッシュライト**: 暗所でもQR読み取り可能
- **手動入力オプション**: カメラ不調時のフォールバック
- **連続スキャンモード**: 複数道具の持ち出し時に効率的
- **音声フィードバック**: 成功時にビープ音
- **振動フィードバック**: スキャン成功時にバイブレーション
- **ヒント表示**: 初回利用時の操作ガイド

---

### 6.3 道具（一覧・検索）

#### 検索画面
```
┌─────────────────────────────────┐
│ [🔍 道具名・IDで検索]     [🎚️]│
├─────────────────────────────────┤
│ 【クイックフィルター】          │
│ [全て] [電動工具] [手工具]      │
│ [測定器] [消耗品]               │
├─────────────────────────────────┤
│ 【所在フィルター】              │
│ [すべて] [会社] [現場A] [現場B] │
├─────────────────────────────────┤
│ 324件の道具                     │
│                                 │
│ ┌─────────────────────────────┐│
│ │ 🔧 ドライバーセット         ││
│ │ ID: A-0123                  ││
│ │ 📍 現在地: 現場A            ││
│ │ 👤 担当: 田中太郎           ││
│ │ 🕐 移動: 2時間前            ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ ⚡ 電動サンダー             ││
│ │ ID: B-0045                  ││
│ │ 📍 現在地: 会社倉庫         ││
│ │ ⚠️ 注意: 要メンテナンス    ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

#### 詳細モーダル
```
┌─────────────────────────────────┐
│ [×]        道具詳細             │
├─────────────────────────────────┤
│ 🔧 ドライバーセット             │
│ ID: A-0123                      │
├─────────────────────────────────┤
│ 基本情報                        │
│ ・種類: 電動工具                │
│ ・型番: XYZ-2000                │
│ ・メーカー: マキタ              │
│ ・購入日: 2023/04/15            │
│ ・購入金額: ¥28,000             │
│ ・状態: 🟢 正常                │
├─────────────────────────────────┤
│ 現在の所在                      │
│ 📍 現場A（渋谷ビル改修）        │
│ 👤 使用者: 田中太郎             │
│ 🕐 移動日時: 2024/11/29 10:30   │
├─────────────────────────────────┤
│ 移動履歴（最新5件）             │
│ 2024/11/29 会社→現場A           │
│ 2024/11/25 現場B→会社           │
│ 2024/11/20 会社→現場B           │
│ → すべての履歴を見る            │
├─────────────────────────────────┤
│ アクション                      │
│ ┌───────┐ ┌───────┐ ┌───────┐ │
│ │スキャン│ │編集  │ │故障報告││
│ └───────┘ └───────┘ └───────┘ │
└─────────────────────────────────┘
```

---

### 6.4 設定（企業管理者向け）

```
┌─────────────────────────────────┐
│ 設定                            │
├─────────────────────────────────┤
│ 【道具マスタ管理】              │
│ ┌─────────────────────────────┐│
│ │ ➕ 新規道具登録             ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 📦 一括登録（CSVインポート）││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 🏷️ QRコード一括印刷        ││
│ └─────────────────────────────┘│
├─────────────────────────────────┤
│ 【現場マスタ管理】              │
│ ┌─────────────────────────────┐│
│ │ ➕ 新規現場登録             ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 📋 現場一覧・編集           ││
│ └─────────────────────────────┘│
├─────────────────────────────────┤
│ 【アラート設定】                │
│ ┌─────────────────────────────┐│
│ │ 在庫下限設定                ││
│ │ ドライバーセット: [5]個以下 ││
│ │ サンダー: [3]個以下         ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ 未返却アラート: [7]日以上  ││
│ └─────────────────────────────┘│
├─────────────────────────────────┤
│ 【ユーザー管理】                │
│ ┌─────────────────────────────┐│
│ │ 👥 スタッフ一覧・権限設定  ││
│ │ 現在: 18名 / 上限20名       ││
│ └─────────────────────────────┘│
├─────────────────────────────────┤
│ 【プラン・請求管理】            │
│ ┌─────────────────────────────┐│
│ │ 現在のプラン: プレミアム    ││
│ │ 月額: ¥50,000               ││
│ │ 次回請求日: 2024/12/29      ││
│ │ [プラン変更] [請求書確認]  ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

---

## 7. QRスキャン機能

### 7.1 QRコード設計

#### QRコード内容フォーマット
```
https://a-kensetsu.tool-manager.com/scan?id=A-0123

構成:
- サブドメイン: a-kensetsu（企業識別）
- パス: /scan（スキャン画面へ遷移）
- パラメータ: id=A-0123（道具ID）
```

#### 仕様
- **サイズ**: 最小25mm × 25mm（読み取り距離10cm想定）
- **訂正レベル**: Level H（約30%復元可能）→ 汚れ・破損に強い
- **推奨印刷**: 耐水ラベル用紙、ラミネート加工
- **色**: 黒QRコード + 白背景（視認性最高）

#### 道具ID命名規則
```
[カテゴリーコード]-[連番4桁]

例:
A-0001～A-9999: 電動工具
B-0001～B-9999: 手工具
C-0001～C-9999: 測定器
D-0001～D-9999: 消耗品

※ 企業ごとに独立したID体系
（A建設のA-0001と、B塗装のA-0001は別物）
```

---

### 7.2 スキャン技術仕様

#### 使用ライブラリ（推奨）
- **`html5-qrcode`**: PWAでカメラアクセス可能
- **`qrcode`**: QRコード生成

#### スキャン最適化機能
- **オートフォーカス**: 自動でQRコードにピント調整
- **ズーム対応**: ピンチイン/アウトで拡大縮小
- **フラッシュライト制御**: 暗所での読み取り補助
- **スキャン音**: 成功時にビープ音（設定でON/OFF可能）
- **振動フィードバック**: 成功時に短い振動（iOS/Android対応）
- **連続スキャンモード**: スキャン成功後、自動で次のスキャン待機

#### エラーハンドリング

| エラーケース | メッセージ | アクション |
|-------------|-----------|-----------|
| カメラ権限なし | 「カメラの使用を許可してください」 | 設定画面へのリンク表示 |
| QRコード読み取り失敗 | 「QRコードが読み取れません。明るい場所で再度お試しください」 | 手動入力ボタンを表示 |
| 登録されていないID | 「このIDは登録されていません。管理者にお問い合わせください」 | 入力したIDを表示（確認用） |
| 他企業のQRコード | 「このQRコードは別の企業のものです」 | アクセス拒否 |
| オフライン状態 | 「オフライン状態です。データは後で同期されます」 | ローカルストレージに一時保存 |

---

## 8. データモデル

### 8.1 マルチテナント対応ER図

```
Organization (組織・企業)【新規】
├── id (PK)
├── name "A建設株式会社"
├── subdomain "a-kensetsu" (UQ)
├── plan "basic" | "premium" | "enterprise"
├── stripe_customer_id
├── stripe_subscription_id
├── max_users 20
├── max_tools 500
├── is_active true
└── created_at

    ↓ 1:N

User (ユーザー)
├── id (PK)
├── organization_id (FK) ← 重要！
├── email
├── name
├── role "admin" | "leader" | "staff"
└── created_at

Tool (道具)
├── id (PK)
├── organization_id (FK) ← 重要！
├── tool_code "A-0001"
├── category_id (FK)
├── name
├── model_number
├── manufacturer
├── purchase_date
├── purchase_price
├── status "normal" | "repair" | "broken" | "disposed"
├── current_location_id (FK)
├── min_stock_alert
├── photo_url
├── manual_url
└── created_at

ToolMovement (移動履歴)
├── id (PK)
├── organization_id (FK) ← 重要！
├── tool_id (FK)
├── user_id (FK)
├── from_location_id (FK)
├── to_location_id (FK)
├── movement_type "checkout" | "checkin" | "transfer"
├── note
├── moved_at
└── created_at

Location (場所)
├── id (PK)
├── organization_id (FK) ← 重要！
├── type "company" | "site"
├── name
├── address
├── manager_name
├── is_active
└── created_at

ToolCategory (道具カテゴリ)
├── id (PK)
├── organization_id (FK) ← 重要！
├── name
├── code_prefix "A" | "B" | "C" | "D"
└── created_at

OrganizationFeatures (機能フラグ)【新規】
├── id (PK)
├── organization_id (FK)
├── feature_key "quotation_management" | "invoice_management" | ...
├── is_enabled
└── config JSONB

OrganizationSettings (企業設定)【新規】
├── id (PK)
├── organization_id (FK)
├── setting_key "low_stock_threshold" | "qr_code_size" | ...
├── setting_value JSONB
└── updated_at

OrganizationBranding (ブランディング)【新規】
├── organization_id (PK, FK)
├── logo_url
├── primary_color "#3B82F6"
├── secondary_color "#10B981"
└── display_name "A建設 道具管理システム"

Quotation (見積)【拡張機能】
├── id (PK)
├── organization_id (FK)
├── quotation_number "Q-2024-001"
├── client_name
├── total_amount
├── status "draft" | "sent" | "approved"
└── created_at

Invoice (請求書)【拡張機能】
├── id (PK)
├── organization_id (FK)
├── invoice_number "INV-2024-001"
├── client_name
├── total_amount
├── payment_status "unpaid" | "paid"
└── created_at
```

---

### 8.2 Row Level Security (RLS) ポリシー

#### データ分離の核心部分

```sql
-- 全テーブルに RLS を有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE tools ENABLE ROW LEVEL SECURITY;
ALTER TABLE locations ENABLE ROW LEVEL SECURITY;
ALTER TABLE tool_movements ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分の組織のデータのみアクセス可能
CREATE POLICY "users_own_organization"
  ON users FOR ALL
  USING (
    organization_id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );

CREATE POLICY "tools_own_organization"
  ON tools FOR ALL
  USING (
    organization_id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );

CREATE POLICY "locations_own_organization"
  ON locations FOR ALL
  USING (
    organization_id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );

CREATE POLICY "movements_own_organization"
  ON tool_movements FOR ALL
  USING (
    organization_id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );

-- 組織情報は所属ユーザーのみ閲覧可能
CREATE POLICY "organizations_own_only"
  ON organizations FOR SELECT
  USING (
    id = (
      SELECT organization_id FROM users WHERE id = auth.uid()
    )
  );
```

**重要**: このポリシーにより、アプリケーションコードで`WHERE organization_id = ...`を書かなくても、データベースレベルで自動的にフィルタリングされます。

---

### 8.3 主要テーブル定義（TypeScript型）

#### Organization（組織）
```typescript
interface Organization {
  id: string;                      // UUID
  name: string;                    // "A建設株式会社"
  subdomain: string;               // "a-kensetsu" (ユニーク)
  plan: 'trial' | 'basic' | 'premium' | 'enterprise';
  plan_started_at: Date;
  trial_ends_at?: Date;

  // 制限
  max_users: number;               // 20
  max_tools: number;               // 500
  max_storage_mb: number;          // 1000

  // ステータス
  is_active: boolean;              // true/false
  is_trial: boolean;

  // Stripe連携
  stripe_customer_id?: string;
  stripe_subscription_id?: string;

  // 請求情報
  billing_email?: string;
  billing_name?: string;
  billing_address?: string;

  created_at: Date;
  updated_at: Date;
}
```

#### Tool（道具マスタ）
```typescript
interface Tool {
  id: string;                      // UUID
  organization_id: string;         // FK ← 重要！
  tool_code: string;               // "A-0001"
  category_id: string;             // FK
  name: string;                    // "ドライバーセット"
  model_number: string;            // "XYZ-2000"
  manufacturer: string;            // "マキタ"
  purchase_date: Date;
  purchase_price?: number;         // 28000
  status: 'normal' | 'repair' | 'broken' | 'disposed';
  current_location_id: string;     // FK
  min_stock_alert: number;         // 5
  photo_url?: string;
  manual_url?: string;
  created_at: Date;
  updated_at: Date;
}
```

#### ToolMovement（移動履歴）
```typescript
interface ToolMovement {
  id: string;
  organization_id: string;         // FK ← 重要！
  tool_id: string;                 // FK
  user_id: string;                 // FK (実行者)
  from_location_id: string;        // FK (移動元)
  to_location_id: string;          // FK (移動先)
  movement_type: 'checkout' | 'checkin' | 'transfer';
  note?: string;
  moved_at: Date;
  created_at: Date;
}
```

---

## 9. 技術仕様

### 9.1 技術スタック

```json
{
  "dependencies": {
    // フレームワーク
    "next": "^14.0.0",
    "react": "^18.0.0",
    "typescript": "^5.0.0",

    // UI
    "tailwindcss": "^3.4.0",
    "@headlessui/react": "^1.7.0",
    "lucide-react": "^0.300.0",

    // QRコード
    "html5-qrcode": "^2.3.8",
    "qrcode": "^1.5.3",

    // 状態管理
    "zustand": "^4.4.0",

    // フォーム
    "react-hook-form": "^7.48.0",
    "zod": "^3.22.0",

    // データフェッチ
    "@tanstack/react-query": "^5.0.0",

    // 日付
    "date-fns": "^2.30.0",

    // PWA
    "next-pwa": "^5.6.0",

    // データベース（Supabase）
    "@supabase/supabase-js": "^2.38.0",
    "@supabase/auth-helpers-nextjs": "^0.8.0",

    // 決済（Stripe）
    "stripe": "^14.0.0",
    "@stripe/stripe-js": "^2.0.0"
  }
}
```

---

### 9.2 インフラ構成

```
┌─────────────────────────────────────────┐
│  Vercel (ホスティング)                  │
│  - Next.js デプロイ                     │
│  - Edge Network (CDN)                   │
│  - 自動HTTPS                            │
│  - カスタムドメイン対応                 │
│  費用: $20/月（Pro プラン）             │
└─────────────────────────────────────────┘
              ↓ API通信
┌─────────────────────────────────────────┐
│  Supabase (バックエンド)                │
│  - PostgreSQL（フルマネージド）         │
│  - Supabase Auth (認証)                 │
│  - Supabase Storage (ファイル)          │
│  - Realtime Subscriptions               │
│  - 自動バックアップ                     │
│  費用: $0〜$599/月（規模に応じて）      │
└─────────────────────────────────────────┘
              ↓ Webhook
┌─────────────────────────────────────────┐
│  Stripe (決済・課金)                    │
│  - サブスクリプション管理               │
│  - 請求書自動発行                       │
│  - 顧客ポータル                         │
│  費用: 手数料3.6% + ¥0/決済             │
└─────────────────────────────────────────┘
              ↓ オプション
┌─────────────────────────────────────────┐
│  Upstash Redis (キャッシュ)             │
│  - セッション管理                       │
│  - レート制限                           │
│  費用: $0〜$20/月                       │
└─────────────────────────────────────────┘
```

---

### 9.3 PWA対応（オフライン機能）

#### 必要性
- 現場では電波が不安定な場合がある
- オフラインでもスキャン操作を継続可能にする

#### 実装方針
```typescript
// Service Worker 実装
interface OfflineQueueItem {
  id: string;
  tool_id: string;
  action: 'checkout' | 'checkin' | 'transfer';
  from_location: string;
  to_location: string;
  user_id: string;
  timestamp: Date;
  synced: boolean;
}

// フロー:
// 1. スキャンデータをIndexedDBに一時保存
// 2. オンライン復帰時に自動同期
// 3. 同期完了を通知
```

#### オフライン対応範囲
- ✅ QRスキャン（ローカル保存）
- ✅ 道具一覧閲覧（キャッシュデータ）
- ❌ 管理者機能（オンライン必須）
- ❌ プラン変更・請求管理（オンライン必須）

---

### 9.4 パフォーマンス目標

| 指標 | 目標値 |
|------|--------|
| FCP（初回表示） | 1.5秒以内 |
| TTI（インタラクティブ） | 3秒以内 |
| QRスキャン応答 | 0.5秒以内 |
| ページ遷移 | 0.3秒以内 |
| Lighthouse スコア | 90点以上 |

**最適化施策**:
- 画像最適化（WebP形式、遅延読み込み）
- コード分割（Dynamic Import）
- CDN配信（Vercel Edge）
- データベースインデックス最適化
- React Server Components 活用

---

## 10. セキュリティ

### 10.1 認証・認可

#### 認証方式
- **Supabase Auth** を使用
- メールアドレス + パスワード
- JWT トークンベースのセッション管理
- パスワードリセット機能（メール送信）

#### 権限制御（RBAC + RLS）

**企業内の権限（3階層）**
```typescript
enum UserRole {
  ADMIN = 'admin',      // 企業管理者（全機能）
  LEADER = 'leader',    // 現場リーダー（閲覧+スキャン+一部編集）
  STAFF = 'staff'       // 一般スタッフ（閲覧+スキャンのみ）
}

const permissions = {
  'tool.create': [UserRole.ADMIN],
  'tool.edit': [UserRole.ADMIN, UserRole.LEADER],
  'tool.view': [UserRole.ADMIN, UserRole.LEADER, UserRole.STAFF],
  'tool.scan': [UserRole.ADMIN, UserRole.LEADER, UserRole.STAFF],
  'location.manage': [UserRole.ADMIN],
  'user.manage': [UserRole.ADMIN],
  'billing.view': [UserRole.ADMIN],
};
```

**システム管理者権限（あなた）**
- Supabase の Service Role Key を使用
- Row Level Security をバイパス可能
- 全顧客企業のデータにアクセス可能（トラブルシューティング用）

---

### 10.2 データ保護

- **通信**: 全通信HTTPS暗号化（Vercel自動対応）
- **パスワード**: bcrypt ハッシュ化（Supabase自動対応）
- **トークン**: JWT、有効期限1時間、リフレッシュトークン対応
- **API**: CORS設定、CSRFトークン
- **ファイル**: Supabase Storage、署名付きURL（期限付き）

---

## 11. 課金・プラン管理

### 11.1 プラン体系

#### ベーシックプラン
```
月額: ¥25,000/月
- ユーザー数: 20名まで
- 道具登録数: 500個まで
- ストレージ: 1GB
- 機能:
  ✅ 道具マスタ管理
  ✅ QRスキャン（入出庫）
  ✅ 在庫・所在管理
  ✅ 移動履歴
  ✅ 低在庫アラート
  ✅ 基本レポート（CSV出力）
  ✅ メールサポート
```

#### プレミアムプラン
```
月額: ¥50,000/月
- ユーザー数: 50名まで
- 道具登録数: 無制限
- ストレージ: 5GB
- 機能:
  ✅ ベーシックプランの全機能
  ✅ 損耗・修理管理
  ✅ コスト分析
  ✅ 高度なレポート（グラフ化）
  ✅ 道具写真・マニュアル添付
  ✅ 電話サポート
```

#### エンタープライズプラン
```
月額: 要相談（¥100,000/月〜）
- ユーザー数: 無制限
- 道具登録数: 無制限
- ストレージ: 無制限
- 機能:
  ✅ プレミアムプランの全機能
  ✅ API連携（会計ソフト等）
  ✅ カスタム開発対応
  ✅ 専任サポート
  ✅ SLA保証
```

---

### 11.2 アドオン（拡張機能）

#### 見積管理機能
```
月額: +¥10,000/月
- 見積書作成・管理
- PDF自動生成
- 取引先管理
- ステータス管理（下書き・送付済・承認等）
```

#### 請求管理機能
```
月額: +¥10,000/月
- 請求書作成・管理
- PDF自動生成
- 支払いステータス管理
- 入金管理
```

---

### 11.3 課金フロー（Stripe統合）

#### 新規契約の流れ
```
1. 顧客がプラン選択
   ↓
2. Stripe Checkout へリダイレクト
   - カード情報入力（Stripe側で暗号化）
   ↓
3. サブスクリプション作成
   - Stripe が自動的に月次課金
   ↓
4. Webhook で通知受信
   - organizations.stripe_subscription_id を更新
   - organizations.plan を設定
   - organizations.is_active = true
   ↓
5. 顧客にメール通知
   「契約完了しました」
```

#### 月次請求の自動化
```
毎月の契約日:
1. Stripe が自動的にカード決済
   ↓
2. 成功 → Webhook "invoice.payment_succeeded"
   - organizations.is_active = true（継続）
   ↓
3. 失敗 → Webhook "invoice.payment_failed"
   - 1回目: 警告メール送信
   - 3回目: organizations.is_active = false（停止）
```

#### 顧客セルフサービス
```
顧客は「設定 > プラン管理」から:
- Stripe 顧客ポータルへアクセス
- プラン変更（アップグレード・ダウングレード）
- 支払い方法変更
- 請求書ダウンロード
- サブスクリプション解約

→ 全て Stripe が自動処理
→ Webhook であなたのDBに反映
```

---

## 12. 拡張機能

### 12.1 見積管理機能

#### 画面設計
```
┌─────────────────────────────────┐
│ 見積一覧                        │
├─────────────────────────────────┤
│ [+ 新規見積作成]                │
│                                 │
│ ┌─────────────────────────────┐│
│ │ Q-2024-001                  ││
│ │ ○○建設様 渋谷ビル改修工事  ││
│ │ 金額: ¥1,280,000            ││
│ │ ステータス: 🟡 送付済      ││
│ │ 有効期限: 2024/12/31        ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ Q-2024-002                  ││
│ │ △△工務店様 横浜倉庫        ││
│ │ 金額: ¥850,000              ││
│ │ ステータス: ✅ 承認        ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

#### 機能詳細
- **見積書作成**: 明細入力、自動計算（小計・消費税・合計）
- **PDF生成**: デザイン済みテンプレートで自動生成
- **ステータス管理**: 下書き → 送付済 → 承認 → 失注
- **取引先管理**: 顧客情報の登録・再利用
- **履歴管理**: 過去の見積を検索・参照

---

### 12.2 請求管理機能

#### 画面設計
```
┌─────────────────────────────────┐
│ 請求一覧                        │
├─────────────────────────────────┤
│ [+ 新規請求書作成]              │
│                                 │
│ ┌─────────────────────────────┐│
│ │ INV-2024-001                ││
│ │ ○○建設様                   ││
│ │ 金額: ¥1,280,000            ││
│ │ 支払期限: 2024/12/31        ││
│ │ ステータス: 🔴 未払い      ││
│ └─────────────────────────────┘│
│ ┌─────────────────────────────┐│
│ │ INV-2024-002                ││
│ │ △△工務店様                 ││
│ │ 金額: ¥850,000              ││
│ │ 支払日: 2024/11/25          ││
│ │ ステータス: ✅ 入金済      ││
│ └─────────────────────────────┘│
└─────────────────────────────────┘
```

#### 機能詳細
- **請求書作成**: 見積からワンクリック変換可能
- **PDF生成**: 自動生成、メール送信
- **支払い管理**: 未払い・一部入金・入金済
- **督促機能**: 支払期限超過時のアラート
- **入金消込**: 支払い記録の管理

---

### 12.3 機能フラグによる制御

#### 実装例
```typescript
// 企業ごとに機能を有効化
INSERT INTO organization_features (organization_id, feature_key, is_enabled) VALUES
  -- A建設: 見積・請求の両方有効
  ('a-kensetsu-id', 'quotation_management', true),
  ('a-kensetsu-id', 'invoice_management', true),

  -- B塗装: 見積のみ有効
  ('b-tosou-id', 'quotation_management', true),
  ('b-tosou-id', 'invoice_management', false);
```

```typescript
// UIでの表示制御
'use client';
import { useOrganization } from '@/contexts/OrganizationContext';

export default function Navigation() {
  const { features } = useOrganization();

  return (
    <nav>
      {/* 基本機能: 常に表示 */}
      <NavItem href="/tools">道具管理</NavItem>

      {/* 拡張機能: フラグで制御 */}
      {features.quotation_management?.enabled && (
        <NavItem href="/quotations">見積管理</NavItem>
      )}

      {features.invoice_management?.enabled && (
        <NavItem href="/invoices">請求管理</NavItem>
      )}
    </nav>
  );
}
```

---

## 13. 管理者機能（あなた用）

### 13.1 管理画面（admin.tool-manager.com）

#### ダッシュボード
```
┌─────────────────────────────────────────┐
│ SaaS管理ダッシュボード                  │
├─────────────────────────────────────────┤
│ 【ビジネスメトリクス】                  │
│ ┌────────┐ ┌────────┐ ┌────────┐       │
│ │総顧客数│ │有効顧客│ │解約率  │       │
│ │  28社 │ │  25社 │ │  3.5% │       │
│ └────────┘ └────────┘ └────────┘       │
│                                         │
│ ┌────────┐ ┌────────┐ ┌────────┐       │
│ │MRR     │ │ARR     │ │ARPU    │       │
│ │¥750,000│ │¥9,000K │ │¥30,000 │       │
│ └────────┘ └────────┘ └────────┘       │
├─────────────────────────────────────────┤
│ 【新規顧客（最近7日）】                 │
│ 2024/11/29: C工務店（プレミアム）       │
│ 2024/11/27: D塗装（トライアル）         │
├─────────────────────────────────────────┤
│ 【アラート】                            │
│ ⚠️ トライアル期限切れ間近: 3社        │
│ 🔴 支払い失敗: 1社（要対応）           │
└─────────────────────────────────────────┘
```

---

#### 顧客一覧
```
┌─────────────────────────────────────────────────────┐
│ 顧客管理                                            │
├─────────────────────────────────────────────────────┤
│ [🔍 検索] [フィルター: 全て▼]                      │
├───┬────────┬──────┬─────┬─────┬──────┬─────┤
│企業│サブ    │プラン│ユーザ│道具数│ステータス│MRR  │
├───┼────────┼──────┼─────┼─────┼──────┼─────┤
│A建設│a-kensetsu│Premium│18/20│324  │✅有効 │¥60K │
│     │         │+見積  │     │     │       │     │
│     │         │+請求  │     │     │       │     │
├───┼────────┼──────┼─────┼─────┼──────┼─────┤
│B塗装│b-tosou │Basic │12/20│189  │✅有効 │¥25K │
├───┼────────┼──────┼─────┼─────┼──────┼─────┤
│C工務│c-koumuten│Premium│25/50│567  │✅有効 │¥50K │
├───┼────────┼──────┼─────┼─────┼──────┼─────┤
│D塗装│d-tosou │Trial │5/20 │45   │⚠️試用 │¥0  │
│     │         │あと3日│     │     │       │     │
└───┴────────┴──────┴─────┴─────┴──────┴─────┘
```

---

#### 顧客詳細画面
```
┌─────────────────────────────────┐
│ A建設株式会社                   │
├─────────────────────────────────┤
│ 【基本情報】                    │
│ サブドメイン: a-kensetsu        │
│ 契約開始日: 2024/08/01          │
│ プラン: プレミアム              │
│ MRR: ¥60,000/月                 │
│   - ベースプラン: ¥50,000       │
│   - 見積機能: ¥10,000           │
│                                 │
│ 【使用状況】                    │
│ ユーザー: 18/20名（90%）        │
│ 道具: 324/無制限                │
│ ストレージ: 1.2GB/5GB（24%）    │
│                                 │
│ 【Stripe情報】                  │
│ Customer ID: cus_xxxxx          │
│ Subscription ID: sub_xxxxx      │
│ 次回請求日: 2024/12/01          │
│ 支払い方法: カード末尾 1234     │
│                                 │
│ 【アクション】                  │
│ [プラン変更] [機能追加/削除]    │
│ [アカウント停止] [ログイン代行] │
└─────────────────────────────────┘
```

---

### 13.2 運用タスク

#### 日次
- 新規問い合わせ対応（メール・チャット）
- システムエラーチェック（Sentry）
- 支払い失敗アラート対応

#### 週次
- 新規顧客のオンボーディング
- トライアル期限切れ間近の顧客へリマインド
- MRR・解約率の確認

#### 月次
- 請求処理の確認（Stripe自動）
- 顧客満足度アンケート
- 機能改善の優先順位付け
- インフラコスト最適化

---

## 14. 導入・運用

### 14.1 初期導入ステップ（顧客企業向け）

#### フェーズ1: 準備（1-2週間）
1. 既存道具の棚卸し
2. カテゴリー分類とID付与ルール決定
3. QRコードラベル印刷・貼付
4. 現場マスタ登録（会社倉庫、現場A、B...）
5. スタッフアカウント作成（メール招待）

#### フェーズ2: パイロット運用（2-4週間）
1. 1現場で試験運用
2. スタッフトレーニング（QRスキャン）
3. フィードバック収集
4. UI/UX改善要望のヒアリング

#### フェーズ3: 本格展開（1ヶ月〜）
1. 全現場へ展開
2. 運用ルール徹底教育
3. 定期棚卸しとデータ整合性チェック
4. 継続的な改善

---

### 14.2 運用ルール（顧客企業向け）

#### 必須ルール
1. **道具移動時は必ずスキャン**
   - 持ち出し時
   - 返却時
   - 現場間移動時
2. **1日の終わりに現場リーダーが在庫確認**
3. **週1回の棚卸し**（現場ごと）
4. **故障・紛失は即座に報告**

#### KPI設定
- **スキャン実施率**: 95%以上
- **在庫差異率**: 5%以下
- **未返却アラート対応率**: 100%

---

## 15. 開発ロードマップ

### 15.1 MVP（最小限の機能）- フェーズ1（0-3ヶ月）

**目標**: 最初の1-3社の顧客獲得

#### 基本機能
✅ マルチテナント基盤構築
✅ 組織・ユーザー管理
✅ 道具マスタ管理
✅ QRスキャン（入出庫）
✅ 在庫サマリー表示
✅ 移動履歴記録
✅ 低在庫アラート
✅ 基本レポート（CSV出力）

#### SaaS基盤
✅ Stripe 連携（決済・課金）
✅ サブドメイン対応
✅ Row Level Security (RLS)
✅ 管理画面（顧客一覧・MRR確認）

---

### 15.2 フェーズ2（3-6ヶ月）

**目標**: 10社以上の顧客獲得、機能強化

#### プレミアム機能
📊 ダッシュボードのグラフ化（在庫推移）
🔧 損耗・修理管理機能
💰 コスト分析
📋 現場別チェックリスト
📧 メール通知機能（アラート）

#### 運用改善
🎨 企業ブランディング機能（ロゴ・カラー変更）
📱 モバイルアプリ化（PWA最適化）
🔔 プッシュ通知

---

### 15.3 フェーズ3（6-12ヶ月）

**目標**: 50社以上、エンタープライズ対応

#### 拡張機能
📄 見積管理機能
💳 請求管理機能
📷 道具写真・マニュアル添付
📱 スタッフ稼働現場表示

#### エンタープライズ機能
🔌 API公開（外部システム連携）
🏢 SSO（シングルサインオン）
📊 高度な分析・BI連携
🔐 監査ログ
📞 専任サポート体制

---

## まとめ

本システムは**SaaS型マルチテナントアーキテクチャ**により、以下を実現します：

### 顧客企業にとって
1. **簡単導入**: サブドメインアクセスだけですぐ利用開始
2. **低コスト**: 月額¥25,000〜で本格的な道具管理
3. **即時性**: QRスキャンでリアルタイム在庫把握
4. **拡張性**: 必要な機能を後から追加可能

### あなた（提供者）にとって
1. **運用効率**: 1つの環境で全顧客を管理
2. **安定収益**: 月額課金で継続的な収入
3. **スケール**: 顧客が増えてもインフラは自動対応
4. **高利益率**: インフラコストが低く、粗利90%以上

**成功の鍵**:
- シンプルな操作（QRスキャンだけで完結）
- モバイルファースト設計
- オフライン対応（現場の電波環境考慮）
- 段階的な機能追加（プランとアドオン）
- 優れたカスタマーサポート

このシステムにより、現場作業の**DX化**と**業務効率の劇的な改善**を実現し、持続可能なSaaSビジネスを構築できます。
