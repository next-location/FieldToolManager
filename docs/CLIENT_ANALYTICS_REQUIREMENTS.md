# 取引先分析・統計ページ 要件定義書

## 📊 目的
取引先（顧客・仕入先・協力会社）の分析を通じて、経営判断に必要な情報を提供し、以下の意思決定を支援する：
- 優良取引先の特定と関係強化
- リスクのある取引先の早期発見
- 取引条件の見直しタイミングの把握
- 新規開拓すべき領域の発見
- キャッシュフロー予測と改善

## 🔍 現状の機能（部分的に機能）

### ✅ 実装済みだが静的な機能
1. **基本統計**
   - 取引先総数のカウント
   - 有効/無効の分類
   - 取引先タイプ別の集計（顧客/仕入先/協力会社/両方）

2. **税務関連**
   - インボイス登録事業者数の集計
   - 免税事業者数の把握

3. **与信管理**
   - 与信限度額の合計表示

### ❌ 実装済みだが機能していない
1. **評価システム**
   - 5段階評価の仕組みはあるが、評価入力機能がない
   - 全て「未評価」として表示される

2. **取引実績**
   - フィールドは存在するが、実データと連動していない
   - 累計取引額、取引回数、平均取引額が全て0

## 📈 経営判断に必要な機能要件

### 1. 取引実績の自動集計と分析
```
【必須データ連携】
- 見積書データとの連携（成約率、平均見積額）
- 請求書データとの連携（売上実績、入金状況）
- 発注書データとの連携（仕入実績、支払状況）
- 作業報告書との連携（実際の作業実績）

【分析指標】
- 月次/四半期/年次の取引推移
- 前年同期比の成長率
- 取引頻度と継続性
- 平均取引単価の推移
```

### 2. キャッシュフロー分析
```
【売掛金管理】
- 取引先別の売掛金残高
- 回収予定日と遅延状況
- 回収率と平均回収期間
- 滞留債権のアラート

【買掛金管理】
- 取引先別の買掛金残高
- 支払予定日の管理
- 支払遅延の状況
```

### 3. 収益性分析
```
【利益貢献度】
- 取引先別の粗利益率
- ABC分析（売上構成比）
- 取引先別の収益性ランキング
- コスト対効果の評価

【効率性指標】
- 取引あたりの工数
- リードタイムの分析
- 不良率・クレーム率
```

### 4. リスク評価と与信管理
```
【信用リスク指標】
- 支払遅延履歴
- 与信限度額の使用率
- 取引条件の遵守状況
- 外部信用情報との連携（将来）

【アラート機能】
- 与信限度額超過警告
- 支払遅延の自動通知
- 異常取引の検知
```

### 5. 関係性分析
```
【取引深度】
- 取引継続年数
- 取引頻度の推移
- クロスセル/アップセル機会
- 依存度分析（売上に占める割合）

【満足度指標】
- クレーム発生率
- リピート率
- 紹介による新規獲得
```

## 🎨 視覚化・UI/UX改善要件

### 1. ダッシュボード設計
```
【トップレベルKPI】
- 本日/今月の売上・仕入額
- 売掛金/買掛金残高
- 回収予定/支払予定
- 重要アラート

【インタラクティブ要素】
- 期間選択（日/週/月/四半期/年）
- 取引先タイプでのフィルタリング
- ドリルダウン機能（概要→詳細）
```

### 2. グラフ・チャート要件
```
【必須チャート】
- 売上推移グラフ（折れ線/棒グラフ）
- 取引先構成比（円グラフ/ドーナツ）
- ABC分析（パレート図）
- ヒートマップ（取引頻度×金額）
- 散布図（利益率×取引額）

【比較分析】
- 前年同期比の表示
- 業界平均との比較（将来）
- 目標値との対比
```

### 3. レポート機能
```
【定型レポート】
- 月次取引先レポート
- 与信管理レポート
- 売掛金年齢表
- 取引先別収益レポート

【エクスポート機能】
- PDF形式での出力
- Excel形式でのデータ出力
- グラフの画像保存
```

## 💼 経営会議での活用シナリオ

### 1. 月次経営会議
```
使用データ：
- 当月の取引先別売上実績
- 売掛金回収状況
- 新規/既存の売上比率

議論ポイント：
- 目標達成状況の確認
- 問題取引先への対応策
- 来月の重点取引先
```

### 2. 四半期レビュー
```
使用データ：
- 取引先別の収益性分析
- ABC分析による重点顧客
- 取引条件の妥当性評価

議論ポイント：
- 取引条件の見直し対象
- 新規開拓vs既存深耕の戦略
- リソース配分の最適化
```

### 3. 年度計画策定
```
使用データ：
- 取引先の成長性分析
- 依存度とリスク評価
- 市場セグメント別の実績

議論ポイント：
- 重点取引先の選定
- 新規開拓目標の設定
- 与信限度額の見直し
```

## 🚀 実装優先順位

### Phase 1（即効性重視）
1. **取引実績の自動連携**
   - 見積書・請求書・発注書との連携
   - リアルタイム集計の実装

2. **基本的な分析機能**
   - 期間指定での集計
   - 売上ランキング表示
   - 簡易ABC分析

3. **視覚化の改善**
   - 売上推移グラフ
   - 取引先構成比の円グラフ

### Phase 2（分析深化）
1. **キャッシュフロー管理**
   - 売掛金/買掛金の可視化
   - 回収/支払予定の管理

2. **収益性分析**
   - 粗利益率の計算
   - 取引先別コスト分析

3. **アラート機能**
   - 与信限度額超過通知
   - 支払遅延アラート

### Phase 3（高度化）
1. **予測分析**
   - 売上予測モデル
   - キャッシュフロー予測

2. **外部データ連携**
   - 信用情報の取得
   - 業界ベンチマーク

3. **AI活用**
   - 異常検知
   - 取引先スコアリング

## 📋 成功指標（KPI）

1. **利用率**
   - 月次での閲覧回数
   - 経営会議での活用率

2. **意思決定への貢献**
   - 取引条件見直しの実施数
   - リスク回避の事例数

3. **業務効率化**
   - レポート作成時間の短縮
   - 分析作業の自動化率

4. **経営改善**
   - 売掛金回収期間の短縮
   - 優良取引先比率の向上

## 🔧 技術要件

### データベース拡張
```sql
-- 取引実績の集計用ビュー
CREATE MATERIALIZED VIEW client_transaction_summary AS
SELECT
  c.id as client_id,
  COUNT(DISTINCT i.id) as invoice_count,
  SUM(i.total_amount) as total_sales,
  COUNT(DISTINCT e.id) as estimate_count,
  SUM(e.total_amount) as total_estimated,
  COUNT(DISTINCT po.id) as purchase_order_count,
  SUM(po.total_amount) as total_purchases
FROM clients c
LEFT JOIN invoices i ON c.id = i.client_id
LEFT JOIN estimates e ON c.id = e.client_id
LEFT JOIN purchase_orders po ON c.id = po.supplier_id
GROUP BY c.id;

-- 月次集計テーブル
CREATE TABLE client_monthly_stats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID REFERENCES clients(id),
  year_month TEXT NOT NULL, -- 'YYYY-MM'
  sales_amount DECIMAL(15,2),
  purchase_amount DECIMAL(15,2),
  invoice_count INTEGER,
  payment_delay_days INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API設計
- `/api/clients/analytics` - 分析データ取得
- `/api/clients/trends` - 推移データ取得
- `/api/clients/rankings` - ランキング取得
- `/api/clients/alerts` - アラート取得

### フロントエンド
- Chart.js or Recharts for グラフ表示
- React Table for データグリッド
- date-fns for 期間計算
- jsPDF for PDF出力

## 📝 備考

このページを本当に経営判断に使えるものにするためには、単なる「データの表示」から「インサイトの提供」へと進化させる必要があります。データを見て「so what?（だから何？）」に答えられる分析と、次のアクションを示唆する機能が重要です。